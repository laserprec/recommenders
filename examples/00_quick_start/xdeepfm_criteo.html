
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>xDeepFM : the eXtreme Deep Factorization Machine &#8212; &lt;h1 style=&#34;font-size:1.7em;text-align:center;color:#FF5733&#34;&gt;Recommenders&lt;/h1&gt;</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title"><h1 style="font-size:1.7em;text-align:center;color:#FF5733">Recommenders</h1></h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption" role="heading">
 <span class="caption-text">
  Quick Start
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="als_movielens.html">
   Running ALS on MovieLens (PySpark)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ncf_movielens.html">
   Neural Collaborative Filtering on MovieLens dataset.
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Deep Dive
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../02_model_collaborative_filtering/als_deep_dive.html">
   Spark Collaborative Filtering (ALS) Deep Dive
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../02_model_collaborative_filtering/baseline_deep_dive.html">
   Estimating Baseline Performance
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  API Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/datasets.html">
   Dataset module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/evaluation.html">
   Evaluation module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/models.html">
   Recommender algorithms module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/tuning.html">
   Hyperparameter tuning module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/utils.html">
   Common utilities module
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/examples/00_quick_start/xdeepfm_criteo.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/microsoft/recommenders"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/microsoft/recommenders/issues/new?title=Issue%20on%20page%20%2Fexamples/00_quick_start/xdeepfm_criteo.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/microsoft/recommenders/main?urlpath=tree/docs/examples/00_quick_start/xdeepfm_criteo.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#global-settings-and-imports">
   0. Global Settings and Imports
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#parameters">
     Parameters
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#synthetic-data">
   1. Synthetic data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prepare-hyper-parameters">
     1.1 Prepare hyper-parameters
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-data-loader">
     1.2 Create data loader
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-model">
     1.3 Create model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-model">
     1.4 Train model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluate-model">
     1.5 Evaluate model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#criteo-data">
   2. Criteo data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reference">
   Reference
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><i>Copyright (c) Microsoft Corporation. All rights reserved.</i></p>
<p><i>Licensed under the MIT License.</i></p>
<div class="tex2jax_ignore mathjax_ignore section" id="xdeepfm-the-extreme-deep-factorization-machine">
<h1>xDeepFM : the eXtreme Deep Factorization Machine<a class="headerlink" href="#xdeepfm-the-extreme-deep-factorization-machine" title="Permalink to this headline">¶</a></h1>
<p>This notebook will give you a quick example of how to train an <a class="reference external" href="https://arxiv.org/abs/1803.05170">xDeepFM model</a>.
xDeepFM [1] is a deep learning-based model aims at capturing both lower- and higher-order feature interactions for precise recommender systems. Thus it can learn feature interactions more effectively and manual feature engineering effort can be substantially reduced. To summarize, xDeepFM has the following key properties:</p>
<ul class="simple">
<li><p>It contains a component, named CIN, that learns feature interactions in an explicit fashion and in vector-wise level;</p></li>
<li><p>It contains a traditional DNN component that learns feature interactions in an implicit fashion and in bit-wise level.</p></li>
<li><p>The implementation makes this model quite configurable. We can enable different subsets of components by setting hyperparameters like <code class="docutils literal notranslate"><span class="pre">use_Linear_part</span></code>, <code class="docutils literal notranslate"><span class="pre">use_FM_part</span></code>, <code class="docutils literal notranslate"><span class="pre">use_CIN_part</span></code>, and <code class="docutils literal notranslate"><span class="pre">use_DNN_part</span></code>. For example, by enabling only the <code class="docutils literal notranslate"><span class="pre">use_Linear_part</span></code> and <code class="docutils literal notranslate"><span class="pre">use_FM_part</span></code>, we can get a classical FM model.</p></li>
</ul>
<p>In this notebook, we test xDeepFM on two datasets: 1) a small synthetic dataset and 2) <a class="reference external" href="http://labs.criteo.com/category/dataset">Criteo dataset</a></p>
<div class="section" id="global-settings-and-imports">
<h2>0. Global Settings and Imports<a class="headerlink" href="#global-settings-and-imports" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">scrapbook</span> <span class="k">as</span> <span class="nn">sb</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="n">tf</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span> <span class="c1"># only show error messages</span>

<span class="kn">from</span> <span class="nn">recommenders.utils.constants</span> <span class="kn">import</span> <span class="n">SEED</span>
<span class="kn">from</span> <span class="nn">recommenders.models.deeprec.deeprec_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">download_deeprec_resources</span><span class="p">,</span> <span class="n">prepare_hparams</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">recommenders.models.deeprec.models.xDeepFM</span> <span class="kn">import</span> <span class="n">XDeepFMModel</span>
<span class="kn">from</span> <span class="nn">recommenders.models.deeprec.io.iterator</span> <span class="kn">import</span> <span class="n">FFMTextIterator</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;System version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tensorflow version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>System version: 3.6.11 | packaged by conda-forge | (default, Aug  5 2020, 20:09:42) 
[GCC 7.5.0]
Tensorflow version: 1.15.2
</pre></div>
</div>
</div>
</div>
<div class="section" id="parameters">
<h3>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_parameters docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EPOCHS_FOR_SYNTHETIC_RUN</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">EPOCHS_FOR_CRITEO_RUN</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">BATCH_SIZE_SYNTHETIC</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">BATCH_SIZE_CRITEO</span> <span class="o">=</span> <span class="mi">4096</span>
<span class="n">RANDOM_SEED</span> <span class="o">=</span> <span class="n">SEED</span>  <span class="c1"># Set to None for non-deterministic result</span>
</pre></div>
</div>
</div>
</div>
<p>xDeepFM uses the FFM format as data input: <code class="docutils literal notranslate"><span class="pre">&lt;label&gt;</span> <span class="pre">&lt;field_id&gt;:&lt;feature_id&gt;:&lt;feature_value&gt;</span></code><br />
Each line represents an instance, <code class="docutils literal notranslate"><span class="pre">&lt;label&gt;</span></code> is a binary value with 1 meaning positive instance and 0 meaning negative instance.
Features are divided into fields. For example, user’s gender is a field, it contains three possible values, i.e. male, female and unknown. Occupation can be another field, which contains many more possible values than the gender field. Both field index and feature index are starting from 1. <br></p>
</div>
</div>
<div class="section" id="synthetic-data">
<h2>1. Synthetic data<a class="headerlink" href="#synthetic-data" title="Permalink to this headline">¶</a></h2>
<p>Now let’s start with a small synthetic dataset. In this dataset, there are 10 fields, 1000 fefatures, and label is generated according to the result of a set of preset pair-wise feature interactions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">()</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">tmpdir</span><span class="o">.</span><span class="n">name</span>
<span class="n">yaml_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;xDeepFM.yaml&#39;</span><span class="p">)</span>
<span class="n">train_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;synthetic_part_0&#39;</span><span class="p">)</span>
<span class="n">valid_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;synthetic_part_1&#39;</span><span class="p">)</span>
<span class="n">test_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;synthetic_part_2&#39;</span><span class="p">)</span>
<span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;output.txt&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">):</span>
    <span class="n">download_deeprec_resources</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;https://recodatasets.z20.web.core.windows.net/deeprec/&#39;</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;xdeepfmresources.zip&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 10.3k/10.3k [00:01&lt;00:00, 5.24kKB/s]
</pre></div>
</div>
</div>
</div>
<div class="section" id="prepare-hyper-parameters">
<h3>1.1 Prepare hyper-parameters<a class="headerlink" href="#prepare-hyper-parameters" title="Permalink to this headline">¶</a></h3>
<p>prepare_hparams() will create a full set of hyper-parameters for model training, such as learning rate, feature number, and dropout ratio. We can put those parameters in a yaml file, or pass parameters as the function’s parameters (which will overwrite yaml settings).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hparams</span> <span class="o">=</span> <span class="n">prepare_hparams</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">,</span> 
                          <span class="n">FEATURE_COUNT</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
                          <span class="n">FIELD_COUNT</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                          <span class="n">cross_l2</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> 
                          <span class="n">embed_l2</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> 
                          <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> 
                          <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS_FOR_SYNTHETIC_RUN</span><span class="p">,</span>
                          <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE_SYNTHETIC</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">hparams</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kg_file=None,user_clicks=None,FEATURE_COUNT=1000,FIELD_COUNT=10,data_format=ffm,PAIR_NUM=None,DNN_FIELD_NUM=None,n_user=None,n_item=None,n_user_attr=None,n_item_attr=None,iterator_type=None,SUMMARIES_DIR=None,MODEL_DIR=None,wordEmb_file=None,entityEmb_file=None,contextEmb_file=None,news_feature_file=None,user_history_file=None,use_entity=True,use_context=True,doc_size=None,history_size=None,word_size=None,entity_size=None,entity_dim=None,entity_embedding_method=None,transform=None,train_ratio=None,dim=10,layer_sizes=[100, 100],cross_layer_sizes=[1],cross_layers=None,activation=[&#39;relu&#39;, &#39;relu&#39;],cross_activation=identity,user_dropout=False,dropout=[0.0, 0.0],attention_layer_sizes=None,attention_activation=None,attention_dropout=0.0,model_type=xDeepFM,method=classification,load_saved_model=False,load_model_name=you model path,filter_sizes=None,num_filters=None,mu=None,fast_CIN_d=0,use_Linear_part=False,use_FM_part=False,use_CIN_part=True,use_DNN_part=False,init_method=tnormal,init_value=0.3,embed_l2=0.0001,embed_l1=0.0,layer_l2=0.0001,layer_l1=0.0,cross_l2=0.0001,cross_l1=0.0,reg_kg=0.0,learning_rate=0.001,lr_rs=1,lr_kg=0.5,kg_training_interval=5,max_grad_norm=2,is_clip_norm=0,dtype=32,loss=log_loss,optimizer=adam,epochs=15,batch_size=128,enable_BN=False,show_step=200000,save_model=False,save_epoch=2,metrics=[&#39;auc&#39;, &#39;logloss&#39;],write_tfevents=False,item_embedding_dim=None,cate_embedding_dim=None,user_embedding_dim=None,train_num_ngs=4,need_sample=True,embedding_dropout=0.0,user_vocab=None,item_vocab=None,cate_vocab=None,pairwise_metrics=None,EARLY_STOP=100,max_seq_length=None,hidden_size=None,L=None,T=None,n_v=None,n_h=None,min_seq_length=1,attention_size=None,att_fcn_layer_sizes=None,dilations=None,kernel_size=None,embed_size=None,n_layers=None,decay=None,eval_epoch=None,top_k=None
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-data-loader">
<h3>1.2 Create data loader<a class="headerlink" href="#create-data-loader" title="Permalink to this headline">¶</a></h3>
<p>Designate a data iterator for the model. xDeepFM uses FFMTextIterator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_creator</span> <span class="o">=</span> <span class="n">FFMTextIterator</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-model">
<h3>1.3 Create model<a class="headerlink" href="#create-model" title="Permalink to this headline">¶</a></h3>
<p>When both hyper-parameters and data iterator are ready, we can create a model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">XDeepFMModel</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">input_creator</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)</span>

<span class="c1">## sometimes we don&#39;t want to train a model from scratch</span>
<span class="c1">## then we can load a pre-trained model like this: </span>
<span class="c1">#model.load_model(r&#39;your_model_path&#39;)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Add CIN part.
</pre></div>
</div>
</div>
</div>
<p>Now let’s see what is the model’s performance at this point (without starting training):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">run_eval</span><span class="p">(</span><span class="n">test_file</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;auc&#39;: 0.5043, &#39;logloss&#39;: 0.7515}
</pre></div>
</div>
</div>
</div>
<p>AUC=0.5 is a state of random guess. We can see that before training, the model behaves like random guessing.</p>
</div>
<div class="section" id="train-model">
<h3>1.4 Train model<a class="headerlink" href="#train-model" title="Permalink to this headline">¶</a></h3>
<p>Next we want to train the model on a training set, and check the performance on a validation dataset. Training the model is as simple as a function call:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_file</span><span class="p">,</span> <span class="n">valid_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>at epoch 1
train info: logloss loss:0.7556826068773302
eval info: auc:0.504, logloss:0.7042
at epoch 1 , train time: 4.3 eval time: 0.6
at epoch 2
train info: logloss loss:0.7263523231666932
eval info: auc:0.5066, logloss:0.6973
at epoch 2 , train time: 4.3 eval time: 0.8
at epoch 3
train info: logloss loss:0.7177084291104189
eval info: auc:0.5099, logloss:0.6953
at epoch 3 , train time: 3.8 eval time: 0.7
at epoch 4
train info: logloss loss:0.7118660186983875
eval info: auc:0.5147, logloss:0.6946
at epoch 4 , train time: 3.7 eval time: 0.8
at epoch 5
train info: logloss loss:0.7055103289302682
eval info: auc:0.523, logloss:0.6941
at epoch 5 , train time: 3.8 eval time: 0.7
at epoch 6
train info: logloss loss:0.6954095556154284
eval info: auc:0.5416, logloss:0.6929
at epoch 6 , train time: 3.6 eval time: 0.8
at epoch 7
train info: logloss loss:0.6723950118133702
eval info: auc:0.5916, logloss:0.6831
at epoch 7 , train time: 4.0 eval time: 0.7
at epoch 8
train info: logloss loss:0.6119807973964927
eval info: auc:0.7024, logloss:0.6288
at epoch 8 , train time: 4.2 eval time: 0.8
at epoch 9
train info: logloss loss:0.5020270644594303
eval info: auc:0.8154, logloss:0.5257
at epoch 9 , train time: 4.3 eval time: 0.8
at epoch 10
train info: logloss loss:0.38994721433346213
eval info: auc:0.8826, logloss:0.4315
at epoch 10 , train time: 4.4 eval time: 0.7
at epoch 11
train info: logloss loss:0.30144522643785704
eval info: auc:0.9205, logloss:0.3605
at epoch 11 , train time: 4.4 eval time: 0.6
at epoch 12
train info: logloss loss:0.23429049589892023
eval info: auc:0.9431, logloss:0.3082
at epoch 12 , train time: 4.2 eval time: 0.6
at epoch 13
train info: logloss loss:0.18283964168677216
eval info: auc:0.9577, logloss:0.2682
at epoch 13 , train time: 3.9 eval time: 0.7
at epoch 14
train info: logloss loss:0.14280925843467826
eval info: auc:0.9676, logloss:0.2369
at epoch 14 , train time: 3.9 eval time: 0.7
at epoch 15
train info: logloss loss:0.11175788457655825
eval info: auc:0.9745, logloss:0.2128
at epoch 15 , train time: 3.7 eval time: 0.7
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;recommenders.models.deeprec.models.xDeepFM.XDeepFMModel at 0x7f9d74f7ff60&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluate-model">
<h3>1.5 Evaluate model<a class="headerlink" href="#evaluate-model" title="Permalink to this headline">¶</a></h3>
<p>Again, let’s see what is the model’s performance now (after training):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_syn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_eval</span><span class="p">(</span><span class="n">test_file</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res_syn</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;auc&#39;: 0.9716, &#39;logloss&#39;: 0.2278}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sb</span><span class="o">.</span><span class="n">glue</span><span class="p">(</span><span class="s2">&quot;res_syn&quot;</span><span class="p">,</span> <span class="n">res_syn</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<p>If we want to get the full prediction scores rather than evaluation metrics, we can do this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;recommenders.models.deeprec.models.xDeepFM.XDeepFMModel at 0x7f9d74f7ff60&gt;
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="criteo-data">
<h2>2. Criteo data<a class="headerlink" href="#criteo-data" title="Permalink to this headline">¶</a></h2>
<p>Now we have successfully launched an experiment on a synthetic dataset. Next let’s try something on a real world dataset, which is a small sample from <a class="reference external" href="http://labs.criteo.com/category/dataset">Criteo dataset</a>. Criteo dataset is a well known industry benchmarking dataset for developing CTR prediction models and it’s frequently adopted as evaluation dataset by research papers. The original dataset is too large for a lightweight demo, so we sample a small portion from it as a demo dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;demo with Criteo dataset&#39;</span><span class="p">)</span>
<span class="n">hparams</span> <span class="o">=</span> <span class="n">prepare_hparams</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">,</span> 
                          <span class="n">FEATURE_COUNT</span><span class="o">=</span><span class="mi">2300000</span><span class="p">,</span> 
                          <span class="n">FIELD_COUNT</span><span class="o">=</span><span class="mi">39</span><span class="p">,</span> 
                          <span class="n">cross_l2</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> 
                          <span class="n">embed_l2</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> 
                          <span class="n">layer_l2</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                          <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.002</span><span class="p">,</span> 
                          <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE_CRITEO</span><span class="p">,</span> 
                          <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS_FOR_CRITEO_RUN</span><span class="p">,</span> 
                          <span class="n">cross_layer_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> 
                          <span class="n">init_value</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                          <span class="n">layer_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span>
                          <span class="n">use_Linear_part</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                          <span class="n">use_CIN_part</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                          <span class="n">use_DNN_part</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>demo with Criteo dataset
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;cretio_tiny_train&#39;</span><span class="p">)</span>
<span class="n">valid_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;cretio_tiny_valid&#39;</span><span class="p">)</span>
<span class="n">test_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;cretio_tiny_test&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">XDeepFMModel</span><span class="p">(</span><span class="n">hparams</span><span class="p">,</span> <span class="n">FFMTextIterator</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Add linear part.
Add CIN part.
Add DNN part.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check the predictive performance before the model is trained</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">run_eval</span><span class="p">(</span><span class="n">test_file</span><span class="p">))</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;auc&#39;: 0.4728, &#39;logloss&#39;: 0.7113}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_file</span><span class="p">,</span> <span class="n">valid_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>at epoch 1
train info: logloss loss:744.3602027893066
eval info: auc:0.6637, logloss:0.5342
at epoch 1 , train time: 21.7 eval time: 4.3
at epoch 2
train info: logloss loss:385.66927337646484
eval info: auc:0.7137, logloss:0.5109
at epoch 2 , train time: 21.4 eval time: 4.3
at epoch 3
train info: logloss loss:191.50830841064453
eval info: auc:0.7283, logloss:0.5037
at epoch 3 , train time: 21.4 eval time: 4.2
at epoch 4
train info: logloss loss:92.20774269104004
eval info: auc:0.7359, logloss:0.4991
at epoch 4 , train time: 21.6 eval time: 4.4
at epoch 5
train info: logloss loss:43.159456968307495
eval info: auc:0.74, logloss:0.4963
at epoch 5 , train time: 21.6 eval time: 4.3
at epoch 6
train info: logloss loss:19.656921446323395
eval info: auc:0.7426, logloss:0.4946
at epoch 6 , train time: 21.3 eval time: 4.2
at epoch 7
train info: logloss loss:8.77035716176033
eval info: auc:0.7441, logloss:0.4934
at epoch 7 , train time: 21.5 eval time: 4.3
at epoch 8
train info: logloss loss:3.9227354377508163
eval info: auc:0.7453, logloss:0.4925
at epoch 8 , train time: 21.7 eval time: 4.3
at epoch 9
train info: logloss loss:1.8598770573735237
eval info: auc:0.7462, logloss:0.4917
at epoch 9 , train time: 21.3 eval time: 4.2
at epoch 10
train info: logloss loss:1.0249397158622742
eval info: auc:0.747, logloss:0.491
at epoch 10 , train time: 21.5 eval time: 4.3
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;recommenders.models.deeprec.models.xDeepFM.XDeepFMModel at 0x7f9d64b4a2e8&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check the predictive performance after the model is trained</span>
<span class="n">res_real</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_eval</span><span class="p">(</span><span class="n">test_file</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res_real</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;auc&#39;: 0.7356, &#39;logloss&#39;: 0.5017}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sb</span><span class="o">.</span><span class="n">glue</span><span class="p">(</span><span class="s2">&quot;res_real&quot;</span><span class="p">,</span> <span class="n">res_real</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cleanup</span>
<span class="n">tmpdir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h2>
<p>[1] Lian, J., Zhou, X., Zhang, F., Chen, Z., Xie, X., &amp; Sun, G. (2018). xDeepFM: Combining Explicit and Implicit Feature Interactions for Recommender Systems. Proceedings of the 24th ACM SIGKDD International Conference on Knowledge Discovery &amp; Data Mining, KDD 2018, London, UK, August 19-23, 2018.<br></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "reco_gpu"
        },
        kernelOptions: {
            kernelName: "reco_gpu",
            path: "./examples/00_quick_start"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'reco_gpu'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>