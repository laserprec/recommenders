
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hyperparameter tuning (Spark based recommender) &#8212; &lt;h1 style=&#34;font-size:1.7em;text-align:center;color:#FF5733&#34;&gt;Recommenders&lt;/h1&gt;</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title"><h1 style="font-size:1.7em;text-align:center;color:#FF5733">Recommenders</h1></h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption" role="heading">
 <span class="caption-text">
  Quick Start
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../00_quick_start/als_movielens.html">
   Running ALS on MovieLens (PySpark)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../00_quick_start/ncf_movielens.html">
   Neural Collaborative Filtering on MovieLens dataset.
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Deep Dive
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../02_model_collaborative_filtering/als_deep_dive.html">
   Spark Collaborative Filtering (ALS) Deep Dive
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../02_model_collaborative_filtering/baseline_deep_dive.html">
   Estimating Baseline Performance
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/examples/04_model_select_and_optimize/tuning_spark_als.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/microsoft/recommenders"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/microsoft/recommenders/issues/new?title=Issue%20on%20page%20%2Fexamples/04_model_select_and_optimize/tuning_spark_als.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/microsoft/recommenders/main?urlpath=tree/docs/examples/04_model_select_and_optimize/tuning_spark_als.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Hyperparameter tuning (Spark based recommender)
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#global-settings-and-import">
     0 Global settings and import
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-preparation">
     1 Data preparation
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hyper-parameter-tuning-with-azure-machine-learning-services">
     2 Hyper parameter tuning with Azure Machine Learning Services
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hyper-parameter-tuning-with-spark-ml-constructs">
     3 Hyper parameter tuning with Spark ML constructs
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#spark-native-construct">
       3.1 Spark native construct
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#custom-estimator-transformer-and-evaluator-for-spark-als">
       3.2 Custom
       <code class="docutils literal notranslate">
        <span class="pre">
         Estimator
        </span>
       </code>
       ,
       <code class="docutils literal notranslate">
        <span class="pre">
         Transformer
        </span>
       </code>
       , and
       <code class="docutils literal notranslate">
        <span class="pre">
         Evaluator
        </span>
       </code>
       for Spark ALS
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#customized-estimator-and-transformer-for-top-k-recommender-based-on-spark-als">
         Customized
         <code class="docutils literal notranslate">
          <span class="pre">
           Estimator
          </span>
         </code>
         and
         <code class="docutils literal notranslate">
          <span class="pre">
           Transformer
          </span>
         </code>
         for top k recommender based on Spark ALS
        </a>
       </li>
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#customized-precision-k-evaluation-metric">
         Customized precision@k evaluation metric
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hyperparameter-tuning-with-hyperopt">
     4 Hyperparameter tuning with
     <code class="docutils literal notranslate">
      <span class="pre">
       hyperopt
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#hyperparameter-tuning-with-tpe">
       4.1 Hyperparameter tuning with TPE
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#hyperparameter-tuning-with-hyperopt-sampling-methods">
       4.2 Hyperparameter tuning with
       <code class="docutils literal notranslate">
        <span class="pre">
         hyperopt
        </span>
       </code>
       sampling methods
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#evaluation-on-testing-data">
     5 Evaluation on testing data
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusions">
   Conclusions
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><i>Copyright (c) Microsoft Corporation. All rights reserved.</i></p>
<p><i>Licensed under the MIT License.</i></p>
<div class="tex2jax_ignore mathjax_ignore section" id="hyperparameter-tuning-spark-based-recommender">
<h1>Hyperparameter tuning (Spark based recommender)<a class="headerlink" href="#hyperparameter-tuning-spark-based-recommender" title="Permalink to this headline">¶</a></h1>
<p>Hyperparameter tuning for Spark based recommender algorithm is important to select a model with the optimal performance. This notebook introduces good practices in performing hyperparameter tuning for building recommender models with the utility functions provided in the <a class="reference external" href="https://github.com/Microsoft/Recommenders.git">Microsoft/Recommenders</a> repository.</p>
<p>Three different approaches are introduced and comparatively studied.</p>
<ul class="simple">
<li><p>Spark native/custom constructs (<code class="docutils literal notranslate"><span class="pre">ParamGridBuilder</span></code>, <code class="docutils literal notranslate"><span class="pre">TrainValidationSplit</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> package with Tree of Parzen Estimator algorithm.</p></li>
<li><p>Brute-force random search of parameter values sampled with pre-defined space.</p></li>
</ul>
<div class="section" id="global-settings-and-import">
<h2>0 Global settings and import<a class="headerlink" href="#global-settings-and-import" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the environment path to find Recommenders</span>
<span class="o">%</span><span class="k">matplotlib</span> notebook

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pyspark</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.recommendation</span> <span class="kn">import</span> <span class="n">ALS</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.tuning</span> <span class="kn">import</span> <span class="n">ParamGridBuilder</span><span class="p">,</span> <span class="n">TrainValidationSplit</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.evaluation</span> <span class="kn">import</span> <span class="n">Evaluator</span><span class="p">,</span> <span class="n">RegressionEvaluator</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.pipeline</span> <span class="kn">import</span> <span class="n">Estimator</span><span class="p">,</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">keyword_only</span>  
<span class="kn">from</span> <span class="nn">pyspark.ml.param.shared</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.util</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyspark.mllib.evaluation</span> <span class="kn">import</span> <span class="n">RankingMetrics</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">ArrayType</span><span class="p">,</span> <span class="n">IntegerType</span>

<span class="kn">from</span> <span class="nn">hyperopt</span> <span class="kn">import</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">tpe</span><span class="p">,</span> <span class="n">hp</span><span class="p">,</span> <span class="n">STATUS_OK</span><span class="p">,</span> <span class="n">Trials</span>
<span class="kn">from</span> <span class="nn">hyperopt.pyll.stochastic</span> <span class="kn">import</span> <span class="n">sample</span>

<span class="kn">from</span> <span class="nn">recommenders.utils.timer</span> <span class="kn">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">recommenders.utils.spark_utils</span> <span class="kn">import</span> <span class="n">start_or_get_spark</span>
<span class="kn">from</span> <span class="nn">recommenders.evaluation.spark_evaluation</span> <span class="kn">import</span> <span class="n">SparkRankingEvaluation</span><span class="p">,</span> <span class="n">SparkRatingEvaluation</span>
<span class="kn">from</span> <span class="nn">recommenders.datasets.movielens</span> <span class="kn">import</span> <span class="n">load_spark_df</span>
<span class="kn">from</span> <span class="nn">recommenders.datasets.spark_splitters</span> <span class="kn">import</span> <span class="n">spark_random_split</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;System version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pandas version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PySpark version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pyspark</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>System version: 3.5.5 |Anaconda custom (64-bit)| (default, May 13 2018, 21:12:35) 
[GCC 7.2.0]
Pandas version: 0.23.0
PySpark version: 2.3.1
</pre></div>
</div>
</div>
</div>
<div class="cell tag_parameters docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MOVIELENS_DATA_SIZE</span> <span class="o">=</span> <span class="s2">&quot;100k&quot;</span>

<span class="n">NUMBER_CORES</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">NUMBER_ITERATIONS</span> <span class="o">=</span> <span class="mi">25</span>

<span class="n">COL_USER</span> <span class="o">=</span> <span class="s2">&quot;userID&quot;</span>
<span class="n">COL_ITEM</span> <span class="o">=</span> <span class="s2">&quot;itemID&quot;</span>
<span class="n">COL_TIMESTAMP</span> <span class="o">=</span> <span class="s2">&quot;timestamp&quot;</span>
<span class="n">COL_RATING</span> <span class="o">=</span> <span class="s2">&quot;rating&quot;</span>
<span class="n">COL_PREDICTION</span> <span class="o">=</span> <span class="s2">&quot;prediction&quot;</span>

<span class="n">HEADER</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;col_user&quot;</span><span class="p">:</span> <span class="n">COL_USER</span><span class="p">,</span>
    <span class="s2">&quot;col_item&quot;</span><span class="p">:</span> <span class="n">COL_ITEM</span><span class="p">,</span>
    <span class="s2">&quot;col_rating&quot;</span><span class="p">:</span> <span class="n">COL_RATING</span><span class="p">,</span>
    <span class="s2">&quot;col_prediction&quot;</span><span class="p">:</span> <span class="n">COL_PREDICTION</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">HEADER_ALS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;userCol&quot;</span><span class="p">:</span> <span class="n">COL_USER</span><span class="p">,</span>
    <span class="s2">&quot;itemCol&quot;</span><span class="p">:</span> <span class="n">COL_ITEM</span><span class="p">,</span>
    <span class="s2">&quot;ratingCol&quot;</span><span class="p">:</span> <span class="n">COL_RATING</span>
<span class="p">}</span>

<span class="n">SUBSET_RATIO</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">RANK</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="n">REG</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.00001</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data-preparation">
<h2>1 Data preparation<a class="headerlink" href="#data-preparation" title="Permalink to this headline">¶</a></h2>
<p>A Spark session is created. Note in this case, to study the running time for different approaches, the Spark session in local mode uses only one core for running. This eliminates the impact of parallelization of parameter tuning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="n">start_or_get_spark</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;local[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NUMBER_CORES</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>MovieLens 100k dataset is used for running the demonstration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">load_spark_df</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">MOVIELENS_DATA_SIZE</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="p">(</span><span class="n">COL_USER</span><span class="p">,</span> <span class="n">COL_ITEM</span><span class="p">,</span> <span class="n">COL_RATING</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 4.81k/4.81k [00:01&lt;00:00, 2.47kKB/s]
</pre></div>
</div>
</div>
</div>
<p>To reduce time spent on the comparitive study, 50% of the data is used for the experimentation below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">spark_random_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">SUBSET_RATIO</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The dataset is split into 3 subsets randomly with a given split ratio. The hyperparameter tuning is performed on the training and the validating data, and then the optimal recommender selected is evaluated on the testing dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">spark_random_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="hyper-parameter-tuning-with-azure-machine-learning-services">
<h2>2 Hyper parameter tuning with Azure Machine Learning Services<a class="headerlink" href="#hyper-parameter-tuning-with-azure-machine-learning-services" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">hyperdrive</span></code> module in the <a class="reference external" href="https://azure.microsoft.com/en-us/services/machine-learning-service/">Azure Machine Learning Services</a> runs <a class="reference external" href="https://docs.microsoft.com/en-us/azure/machine-learning/service/how-to-tune-hyperparameters">hyperparameter tuning and optimizing for machine learning model selection</a>. At the moment, the service supports running hyperparameter tuning on heterogenous computing targets such as cluster of commodity compute nodes with or without GPU devices (see detailed documentation <a class="reference external" href="https://docs.microsoft.com/en-us/azure/machine-learning/service/how-to-set-up-training-targets">here</a>). It is feasible to run parameter tuning on a cluster of VM nodes. In this case, the service containerizes individual and independent Spark session on each node of the cluster to run the parameter tuning job in parallel, instead of inside a single Spark session where the training is executed in a distributed manner.</p>
<p>Detailed instructions of tuning hyperparameter of non-Spark workloads by using Azure Machine Learning Services can be found in <span class="xref myst">this</span> notebook.</p>
</div>
<div class="section" id="hyper-parameter-tuning-with-spark-ml-constructs">
<h2>3 Hyper parameter tuning with Spark ML constructs<a class="headerlink" href="#hyper-parameter-tuning-with-spark-ml-constructs" title="Permalink to this headline">¶</a></h2>
<div class="section" id="spark-native-construct">
<h3>3.1 Spark native construct<a class="headerlink" href="#spark-native-construct" title="Permalink to this headline">¶</a></h3>
<p>Spark ML lib implements modules such as <code class="docutils literal notranslate"><span class="pre">CrossValidator</span></code> and <code class="docutils literal notranslate"><span class="pre">TrainValidationSplit</span></code> for tuning hyperparameters (see <a class="reference external" href="https://spark.apache.org/docs/2.2.0/ml-tuning.html">here</a>). However, by default, it does not support custom machine learning algorithms, data splitting methods, and evaluation metrics, like what are offered as utility functions in the Recommenders repository.</p>
<p>For example, the Spark native constuct can be used for tuning a recommender against the <code class="docutils literal notranslate"><span class="pre">rmse</span></code> metric which is one of the available regression metrics in Spark.</p>
<p>Firstly, a Spark ALS object needs to be created. In this case, for illustration purpose, it is an ALS model object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NOTE the parameters of interest, rank and regParam, are left unset, </span>
<span class="c1"># because their values will be assigned in the parameter grid builder.</span>
<span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span>
    <span class="n">maxIter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">implicitPrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span>
    <span class="n">nonnegative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">HEADER_ALS</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then, a parameter grid can be defined as follows. Without loss of generity, only <code class="docutils literal notranslate"><span class="pre">rank</span></code> and <code class="docutils literal notranslate"><span class="pre">regParam</span></code> are considered.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">paramGrid</span> <span class="o">=</span> <span class="n">ParamGridBuilder</span><span class="p">()</span> \
    <span class="o">.</span><span class="n">addGrid</span><span class="p">(</span><span class="n">als</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">RANK</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">addGrid</span><span class="p">(</span><span class="n">als</span><span class="o">.</span><span class="n">regParam</span><span class="p">,</span> <span class="n">REG</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Given the settings above, a <code class="docutils literal notranslate"><span class="pre">TrainValidationSplit</span></code> constructor can be created for fitting the best model in the given parameter range. In this case, the <code class="docutils literal notranslate"><span class="pre">RegressionEvaluator</span></code> is using <code class="docutils literal notranslate"><span class="pre">RMSE</span></code>, by default, as an evaluation metric.</p>
<p>Since the data splitter is embedded in the <code class="docutils literal notranslate"><span class="pre">TrainValidationSplit</span></code> object, to make sure the splitting ratio is consistent across different approaches, the split ratio is set to be 0.75 and in the model training the training dataset and validating dataset are combined.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tvs</span> <span class="o">=</span> <span class="n">TrainValidationSplit</span><span class="p">(</span>
    <span class="n">estimator</span><span class="o">=</span><span class="n">als</span><span class="p">,</span>
    <span class="n">estimatorParamMaps</span><span class="o">=</span><span class="n">paramGrid</span><span class="p">,</span>
    <span class="c1"># A regression evaluation method is used. </span>
    <span class="n">evaluator</span><span class="o">=</span><span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">labelCol</span><span class="o">=</span><span class="s1">&#39;rating&#39;</span><span class="p">),</span>
    <span class="c1"># 75% of the data will be used for training, 25% for validation.</span>
    <span class="c1"># NOTE here the splitting is random. The Spark splitting utilities (e.g. chrono splitter)</span>
    <span class="c1"># are therefore not available here. </span>
    <span class="n">trainRatio</span><span class="o">=</span><span class="mf">0.75</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">time_spark</span><span class="p">:</span>
    <span class="c1"># Run TrainValidationSplit, and choose the best set of parameters.</span>
    <span class="c1"># NOTE train and valid is union because in Spark TrainValidationSplit does splitting by itself.</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tvs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The model parameters in the grid and the best metrics can be then returned.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">getEstimatorParamMaps</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Run </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Validation Metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">validationMetrics</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Run 0:
	Validation Metric: 1.0505385750367227
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 10
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.1
Run 1:
	Validation Metric: 1.0444319735752456
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 15
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.1
Run 2:
	Validation Metric: 1.040060458376737
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 20
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.1
Run 3:
	Validation Metric: 1.0293843505140208
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 30
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.1
Run 4:
	Validation Metric: 1.0216137585741758
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 40
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.1
Run 5:
	Validation Metric: 1.4359689750708238
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 10
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.01
Run 6:
	Validation Metric: 1.4607579006632527
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 15
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.01
Run 7:
	Validation Metric: 1.462040851503185
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 20
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.01
Run 8:
	Validation Metric: 1.3991557293601262
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 30
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.01
Run 9:
	Validation Metric: 1.3410599805798034
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 40
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.01
Run 10:
	Validation Metric: 1.988790687632913
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 10
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.001
Run 11:
	Validation Metric: 1.87653183445857
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 15
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.001
Run 12:
	Validation Metric: 1.9156975302076813
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 20
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.001
Run 13:
	Validation Metric: 1.8551322988886354
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 30
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.001
Run 14:
	Validation Metric: 1.8640288497082245
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 40
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.001
Run 15:
	Validation Metric: 3.0577123716478947
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 10
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.0001
Run 16:
	Validation Metric: 2.849817587112537
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 15
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.0001
Run 17:
	Validation Metric: 2.5637113568725733
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 20
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.0001
Run 18:
	Validation Metric: 2.549950528259629
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 30
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.0001
Run 19:
	Validation Metric: 2.9097893609292096
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 40
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.0001
Run 20:
	Validation Metric: 4.9701569583584115
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 10
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 1e-05
Run 21:
	Validation Metric: 4.230109404473068
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 15
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 1e-05
Run 22:
	Validation Metric: 3.5723074921735707
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 20
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 1e-05
Run 23:
	Validation Metric: 3.469775656947356
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 30
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 1e-05
Run 24:
	Validation Metric: 4.426604995574413
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 40
	Param(parent=&#39;ALS_496eab0f4b1e8da03092&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 1e-05
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">validationMetrics</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1.0505385750367227,
 1.0444319735752456,
 1.040060458376737,
 1.0293843505140208,
 1.0216137585741758,
 1.4359689750708238,
 1.4607579006632527,
 1.462040851503185,
 1.3991557293601262,
 1.3410599805798034,
 1.988790687632913,
 1.87653183445857,
 1.9156975302076813,
 1.8551322988886354,
 1.8640288497082245,
 3.0577123716478947,
 2.849817587112537,
 2.5637113568725733,
 2.549950528259629,
 2.9097893609292096,
 4.9701569583584115,
 4.230109404473068,
 3.5723074921735707,
 3.469775656947356,
 4.426604995574413]
</pre></div>
</div>
</div>
</div>
<p>To get the best model, just do</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_best_spark</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">bestModel</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="custom-estimator-transformer-and-evaluator-for-spark-als">
<h3>3.2 Custom <code class="docutils literal notranslate"><span class="pre">Estimator</span></code>, <code class="docutils literal notranslate"><span class="pre">Transformer</span></code>, and <code class="docutils literal notranslate"><span class="pre">Evaluator</span></code> for Spark ALS<a class="headerlink" href="#custom-estimator-transformer-and-evaluator-for-spark-als" title="Permalink to this headline">¶</a></h3>
<p>One can also customize Spark modules to allow tuning hyperparameters for a desired model and evaluation metric, given that the native Spark ALS does not allow tuning hyperparameters for ranking metrics such as precision&#64;k, recall&#64;k, etc. This can be done by creating custom <code class="docutils literal notranslate"><span class="pre">Estimator</span></code>, <code class="docutils literal notranslate"><span class="pre">Transformer</span></code> and <code class="docutils literal notranslate"><span class="pre">Evaluator</span></code>. The benefit is that, after the customization, the tuning process can make use of <code class="docutils literal notranslate"><span class="pre">trainValidSplit</span></code> directly, which distributes the tuning in a Spark session.</p>
<div class="section" id="customized-estimator-and-transformer-for-top-k-recommender-based-on-spark-als">
<h4>Customized <code class="docutils literal notranslate"><span class="pre">Estimator</span></code> and <code class="docutils literal notranslate"><span class="pre">Transformer</span></code> for top k recommender based on Spark ALS<a class="headerlink" href="#customized-estimator-and-transformer-for-top-k-recommender-based-on-spark-als" title="Permalink to this headline">¶</a></h4>
<p>The following shows how to implement a PySpark <code class="docutils literal notranslate"><span class="pre">Estimator</span></code> and <code class="docutils literal notranslate"><span class="pre">Transfomer</span></code> for recommending top k items from ALS model. The latter generates top k recommendations from the model object. Both of the two are designed by following the protocol of Spark APIs, to make sure that they can be run with the hyperparameter tuning constructs in Spark.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ALSTopK</span><span class="p">(</span>
    <span class="n">ALS</span><span class="p">,</span>
    <span class="n">Estimator</span><span class="p">,</span>
    <span class="n">HasInputCol</span><span class="p">,</span>
    <span class="n">HasPredictionCol</span>
<span class="p">):</span>    
    <span class="n">rank</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;rank&quot;</span><span class="p">,</span> <span class="s2">&quot;rank of the factorization&quot;</span><span class="p">,</span>
                 <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toInt</span><span class="p">)</span>
    <span class="n">numUserBlocks</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;numUserBlocks&quot;</span><span class="p">,</span> <span class="s2">&quot;number of user blocks&quot;</span><span class="p">,</span>
                          <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toInt</span><span class="p">)</span>
    <span class="n">numItemBlocks</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;numItemBlocks&quot;</span><span class="p">,</span> <span class="s2">&quot;number of item blocks&quot;</span><span class="p">,</span>
                          <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toInt</span><span class="p">)</span>
    <span class="n">implicitPrefs</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;implicitPrefs&quot;</span><span class="p">,</span> <span class="s2">&quot;whether to use implicit preference&quot;</span><span class="p">,</span>
                          <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toBoolean</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha for implicit preference&quot;</span><span class="p">,</span>
                  <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toFloat</span><span class="p">)</span>
    <span class="n">userCol</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;userCol&quot;</span><span class="p">,</span> <span class="s2">&quot;column name for user ids. Ids must be within &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;the integer value range.&quot;</span><span class="p">,</span> <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toString</span><span class="p">)</span>
    <span class="n">itemCol</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;itemCol&quot;</span><span class="p">,</span> <span class="s2">&quot;column name for item ids. Ids must be within &quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;the integer value range.&quot;</span><span class="p">,</span> <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toString</span><span class="p">)</span>
    <span class="n">ratingCol</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;ratingCol&quot;</span><span class="p">,</span> <span class="s2">&quot;column name for ratings&quot;</span><span class="p">,</span>
                      <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toString</span><span class="p">)</span>
    <span class="n">nonnegative</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;nonnegative&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;whether to use nonnegative constraint for least squares&quot;</span><span class="p">,</span>
                        <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toBoolean</span><span class="p">)</span>
    <span class="n">intermediateStorageLevel</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;intermediateStorageLevel&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;StorageLevel for intermediate datasets. Cannot be &#39;NONE&#39;.&quot;</span><span class="p">,</span>
                                     <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toString</span><span class="p">)</span>
    <span class="n">finalStorageLevel</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;finalStorageLevel&quot;</span><span class="p">,</span>
                              <span class="s2">&quot;StorageLevel for ALS model factors.&quot;</span><span class="p">,</span>
                              <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toString</span><span class="p">)</span>
    <span class="n">coldStartStrategy</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">Params</span><span class="o">.</span><span class="n">_dummy</span><span class="p">(),</span> <span class="s2">&quot;coldStartStrategy&quot;</span><span class="p">,</span> <span class="s2">&quot;strategy for dealing with &quot;</span> <span class="o">+</span>
                              <span class="s2">&quot;unknown or new users/items at prediction time. This may be useful &quot;</span> <span class="o">+</span>
                              <span class="s2">&quot;in cross-validation or production scenarios, for handling &quot;</span> <span class="o">+</span>
                              <span class="s2">&quot;user/item ids the model has not seen in the training data. &quot;</span> <span class="o">+</span>
                              <span class="s2">&quot;Supported values: &#39;nan&#39;, &#39;drop&#39;.&quot;</span><span class="p">,</span>
                              <span class="n">typeConverter</span><span class="o">=</span><span class="n">TypeConverters</span><span class="o">.</span><span class="n">toString</span><span class="p">)</span>

    <span class="nd">@keyword_only</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rank</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxIter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">regParam</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">numUserBlocks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">numItemBlocks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">implicitPrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">userCol</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">itemCol</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">ratingCol</span><span class="o">=</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="n">nonnegative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">checkpointInterval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">intermediateStorageLevel</span><span class="o">=</span><span class="s2">&quot;MEMORY_AND_DISK&quot;</span><span class="p">,</span>
        <span class="n">finalStorageLevel</span><span class="o">=</span><span class="s2">&quot;MEMORY_AND_DISK&quot;</span><span class="p">,</span> <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s2">&quot;nan&quot;</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ALS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_java_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_java_obj</span><span class="p">(</span><span class="s2">&quot;org.apache.spark.ml.recommendation.ALS&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setDefault</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxIter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">regParam</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">numUserBlocks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">numItemBlocks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                         <span class="n">implicitPrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">userCol</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">itemCol</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">,</span>
                         <span class="n">ratingCol</span><span class="o">=</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="n">nonnegative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">checkpointInterval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                         <span class="n">intermediateStorageLevel</span><span class="o">=</span><span class="s2">&quot;MEMORY_AND_DISK&quot;</span><span class="p">,</span>
                         <span class="n">finalStorageLevel</span><span class="o">=</span><span class="s2">&quot;MEMORY_AND_DISK&quot;</span><span class="p">,</span> <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_kwargs</span> 
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setParams</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># The manually added parameter is not present in ALS Java implementation. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        
    <span class="k">def</span> <span class="nf">setRank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the value of :py:attr:`rank`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getRank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the value of rank or its default value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">setParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxIter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">regParam</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">numUserBlocks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">numItemBlocks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                  <span class="n">implicitPrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">userCol</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">itemCol</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">ratingCol</span><span class="o">=</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="n">nonnegative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">checkpointInterval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                  <span class="n">intermediateStorageLevel</span><span class="o">=</span><span class="s2">&quot;MEMORY_AND_DISK&quot;</span><span class="p">,</span>
                  <span class="n">finalStorageLevel</span><span class="o">=</span><span class="s2">&quot;MEMORY_AND_DISK&quot;</span><span class="p">,</span> <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s2">&quot;nan&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        setParams(self, rank=10, maxIter=10, regParam=0.1, numUserBlocks=10, numItemBlocks=10, \</span>
<span class="sd">                 implicitPrefs=False, alpha=1.0, userCol=&quot;user&quot;, itemCol=&quot;item&quot;, seed=None, \</span>
<span class="sd">                 ratingCol=&quot;rating&quot;, nonnegative=False, checkpointInterval=10, \</span>
<span class="sd">                 intermediateStorageLevel=&quot;MEMORY_AND_DISK&quot;, \</span>
<span class="sd">                 finalStorageLevel=&quot;MEMORY_AND_DISK&quot;, coldStartStrategy=&quot;nan&quot;)</span>
<span class="sd">        Sets params for ALS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_kwargs</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">}}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_kwargs</span>    
        <span class="c1"># Exclude k as it is not a parameter for ALS.</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">}}</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRank</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;regParam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOrDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regParam</span><span class="p">)</span>
        <span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">als_model</span> <span class="o">=</span> <span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        
        <span class="n">user_col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;userCol&#39;</span><span class="p">]</span>
        <span class="n">item_col</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;itemCol&#39;</span><span class="p">]</span>
        
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>
                     
        <span class="n">topk_model</span> <span class="o">=</span> <span class="n">ALSTopKModel</span><span class="p">()</span>
        <span class="n">topk_model</span><span class="o">.</span><span class="n">setParams</span><span class="p">(</span>
            <span class="n">als_model</span><span class="p">,</span>
            <span class="n">user_col</span><span class="p">,</span> 
            <span class="n">item_col</span><span class="p">,</span> 
            <span class="n">k</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">topk_model</span>
    
    
<span class="k">class</span> <span class="nc">ALSTopKModel</span><span class="p">(</span>
    <span class="n">Model</span><span class="p">,</span>
    <span class="n">HasInputCol</span><span class="p">,</span>
    <span class="n">HasPredictionCol</span><span class="p">,</span>
    <span class="n">HasLabelCol</span>
<span class="p">):</span>    
    <span class="k">def</span> <span class="nf">setParams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">userCol</span><span class="p">,</span> <span class="n">itemCol</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">userCol</span> <span class="o">=</span> <span class="n">userCol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itemCol</span> <span class="o">=</span> <span class="n">itemCol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
    
    <span class="k">def</span> <span class="nf">_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="n">predictionCol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPredictionCol</span><span class="p">()</span>
        <span class="n">labelCol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLabelCol</span><span class="p">()</span>
        
        <span class="n">users</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userCol</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="n">topk_recommendation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">recommendForUserSubset</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>  
        
        <span class="n">extract_value</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">udf</span><span class="p">((</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]),</span> <span class="n">ArrayType</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">()))</span>
        <span class="n">topk_recommendation</span> <span class="o">=</span> <span class="n">topk_recommendation</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">predictionCol</span><span class="p">,</span> <span class="n">extract_value</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;recommendations&quot;</span><span class="p">)))</span>        
        
        <span class="n">dataset</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">dataset</span>
            <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userCol</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">collect_list</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itemCol</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">labelCol</span><span class="p">))</span>
        <span class="p">)</span>
            
        <span class="n">topk_recommendation_all</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">topk_recommendation</span><span class="p">,</span> 
            <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">userCol</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span>
        <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">topk_recommendation_all</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userCol</span><span class="p">,</span> <span class="n">labelCol</span><span class="p">,</span> <span class="n">predictionCol</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="customized-precision-k-evaluation-metric">
<h4>Customized precision&#64;k evaluation metric<a class="headerlink" href="#customized-precision-k-evaluation-metric" title="Permalink to this headline">¶</a></h4>
<p>In addition to the custom <code class="docutils literal notranslate"><span class="pre">Estimator</span></code> and <code class="docutils literal notranslate"><span class="pre">Transformer</span></code>, it may also be desired to customize an <code class="docutils literal notranslate"><span class="pre">Evaluator</span></code> to allow “beyond-rating” metrics. The codes as following illustrates a precision&#64;k evaluator. Other types of evaluators can be developed in a similar way.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a custom Evaulator. Here precision@k is used.</span>
<span class="k">class</span> <span class="nc">PrecisionAtKEvaluator</span><span class="p">(</span><span class="n">Evaluator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictionCol</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="n">labelCol</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictionCol</span> <span class="o">=</span> <span class="n">predictionCol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labelCol</span> <span class="o">=</span> <span class="n">labelCol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>

    <span class="k">def</span> <span class="nf">_evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a random number. </span>
<span class="sd">        Implement here the true metric</span>
<span class="sd">        &quot;&quot;&quot;</span>      
        <span class="c1"># Drop Nulls.</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">RankingMetrics</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictionCol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labelCol</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">metrics</span><span class="o">.</span><span class="n">precisionAt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isLargerBetter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<p>Then a new ALS top-k recommender can be created, and the Spark native construct, <code class="docutils literal notranslate"><span class="pre">TrainValidationSplit</span></code> module, can be used to find the optimal model w.r.t the precision&#64;k metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alstopk</span> <span class="o">=</span> <span class="n">ALSTopK</span><span class="p">(</span>
    <span class="n">userCol</span><span class="o">=</span><span class="n">COL_USER</span><span class="p">,</span>
    <span class="n">itemCol</span><span class="o">=</span><span class="n">COL_ITEM</span><span class="p">,</span>
    <span class="n">ratingCol</span><span class="o">=</span><span class="n">COL_RATING</span><span class="p">,</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>

<span class="c1"># Here for illustration purpose, a small grid is used.</span>
<span class="n">paramGrid</span> <span class="o">=</span> <span class="n">ParamGridBuilder</span><span class="p">()</span> \
    <span class="o">.</span><span class="n">addGrid</span><span class="p">(</span><span class="n">alstopk</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span> \
    <span class="o">.</span><span class="n">addGrid</span><span class="p">(</span><span class="n">alstopk</span><span class="o">.</span><span class="n">regParam</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span> \
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>

<span class="n">tvs</span> <span class="o">=</span> <span class="n">TrainValidationSplit</span><span class="p">(</span>
    <span class="n">estimator</span><span class="o">=</span><span class="n">alstopk</span><span class="p">,</span>
    <span class="n">estimatorParamMaps</span><span class="o">=</span><span class="n">paramGrid</span><span class="p">,</span>
    <span class="c1"># A regression evaluation method is used. </span>
    <span class="n">evaluator</span><span class="o">=</span><span class="n">PrecisionAtKEvaluator</span><span class="p">(),</span>
    <span class="c1"># 75% of the data will be used for training, 25% for validation.</span>
    <span class="c1"># NOTE here the splitting is random. The Spark splitting utilities (e.g. chrono splitter)</span>
    <span class="c1"># are therefore not available here. </span>
    <span class="n">trainRatio</span><span class="o">=</span><span class="mf">0.75</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run TrainValidationSplit, and choose the best set of parameters.</span>
<span class="c1"># NOTE train and valid is union because in Spark TrainValidationSplit does splitting by itself.</span>
<span class="n">model_precision</span> <span class="o">=</span> <span class="n">tvs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">valid</span><span class="p">))</span>

<span class="n">model_precision</span><span class="o">.</span><span class="n">getEstimatorParamMaps</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 10,
  Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.1},
 {Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 10,
  Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.01},
 {Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 20,
  Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.1},
 {Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 20,
  Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.01}]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">best_param</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">is_larger_better</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is_larger_better</span><span class="p">:</span>
        <span class="n">best_metric</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">validationMetrics</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">best_metric</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">validationMetrics</span><span class="p">)</span>
        
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">getEstimatorParamMaps</span><span class="p">()[</span><span class="n">model</span><span class="o">.</span><span class="n">validationMetrics</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">best_metric</span><span class="p">)]</span>
     
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="n">best_param</span><span class="p">(</span><span class="n">model_precision</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_precision</span><span class="o">.</span><span class="n">bestModel</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_precision</span><span class="o">.</span><span class="n">getEstimatorParamMaps</span><span class="p">()):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Run </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Validation Metric: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_precision</span><span class="o">.</span><span class="n">validationMetrics</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+------+--------------------+--------------------+
|userID|               label|          prediction|
+------+--------------------+--------------------+
|   148|     [116, 135, 189]|[126, 735, 222, 7...|
|   463|[15, 100, 103, 12...|[87, 922, 343, 52...|
|   471|      [95, 102, 946]|[663, 114, 488, 9...|
|   496|[94, 143, 196, 28...|[475, 645, 69, 18...|
|   833|[50, 68, 79, 92, ...|[428, 20, 135, 18...|
+------+--------------------+--------------------+

Run 0:
	Validation Metric: 0.01411637931034483
	Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 10
	Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.1
Run 1:
	Validation Metric: 0.007866379310344828
	Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 10
	Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.01
Run 2:
	Validation Metric: 0.01799568965517241
	Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 20
	Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.1
Run 3:
	Validation Metric: 0.018103448275862084
	Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;rank&#39;, doc=&#39;rank of the factorization&#39;): 20
	Param(parent=&#39;ALSTopK_4f48b7cc6cf2badfcea7&#39;, name=&#39;regParam&#39;, doc=&#39;regularization parameter (&gt;= 0).&#39;): 0.01
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="hyperparameter-tuning-with-hyperopt">
<h2>4 Hyperparameter tuning with <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code><a class="headerlink" href="#hyperparameter-tuning-with-hyperopt" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> is an open source Python package that is designed for tuning parameters for generic function with any pre-defined loss. More information about <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> can be found <a class="reference external" href="https://github.com/hyperopt/hyperopt">here</a>. <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> supports parallelization on MongoDB but not Spark. In our case, the tuning is performed in a sequential mode on a local computer.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code>, an <em>objective</em> function is defined for optimizing the hyper parameters. In this case, the objective is similar to that in the Spark native construct situation, which is <em>to the RMSE metric for an ALS recommender</em>. Parameters of <code class="docutils literal notranslate"><span class="pre">rank</span></code> and <code class="docutils literal notranslate"><span class="pre">regParam</span></code> are used as hyperparameters.</p>
<p>The objective function shown below demonstrates a RMSE loss for an ALS recommender.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Customize an objective function</span>
<span class="k">def</span> <span class="nf">objective</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">time_run_start</span><span class="p">:</span>
    
        <span class="n">rank</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> 
        <span class="n">valid</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> 
        <span class="n">col_user</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;col_user&#39;</span><span class="p">]</span> 
        <span class="n">col_item</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;col_item&#39;</span><span class="p">]</span>
        <span class="n">col_rating</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;col_rating&#39;</span><span class="p">]</span> 
        <span class="n">col_prediction</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;col_prediction&#39;</span><span class="p">]</span> 
        <span class="n">k</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
        <span class="n">relevancy_method</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;relevancy_method&#39;</span><span class="p">]</span>

        <span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span>
            <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span>
            <span class="n">maxIter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">implicitPrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">regParam</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
            <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span>
            <span class="n">nonnegative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
            <span class="o">**</span><span class="n">HEADER_ALS</span>
        <span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span> 
        <span class="n">prediction</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>

        <span class="n">rating_eval</span> <span class="o">=</span> <span class="n">SparkRatingEvaluation</span><span class="p">(</span>
            <span class="n">valid</span><span class="p">,</span> 
            <span class="n">prediction</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">HEADER</span>
        <span class="p">)</span>

        <span class="n">rmse</span> <span class="o">=</span> <span class="n">rating_eval</span><span class="o">.</span><span class="n">rmse</span><span class="p">()</span>
    
    <span class="c1"># Return the objective function result.</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">STATUS_OK</span><span class="p">,</span>
        <span class="s1">&#39;eval_time&#39;</span><span class="p">:</span> <span class="n">time_run_start</span><span class="o">.</span><span class="n">interval</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>A search space is usually defined for hyperparameter exploration. Design of search space is empirical, and depends on the understanding of how distribution of parameter of interest affects the model performance measured by the loss function.</p>
<p>In the ALS algorithm, the two hyper parameters, rank and reg, affect model performance in a way that</p>
<ul class="simple">
<li><p>The higher the rank, the better the model performance but also the higher risk of overfitting.</p></li>
<li><p>The reg parameter prevents overfitting in certain way.</p></li>
</ul>
<p>Therefore, in this case, a uniform distribution and a lognormal distribution sampling spaces are used for rank and reg, respectively. A narrow search space is used for illustration purpose, that is, the range of rank is from 10 to 20, while that of reg is from <span class="math notranslate nohighlight">\(e^{-5}\)</span> to <span class="math notranslate nohighlight">\(e^{-1}\)</span>. Together with the randomly sampled hyper parameters, other parameters use for building / evaluating the recommender, like <code class="docutils literal notranslate"><span class="pre">k</span></code>, column names, data, etc., are kept as constants.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define a search space</span>
<span class="n">space</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;rank&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">quniform</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s1">&#39;reg&#39;</span><span class="p">:</span> <span class="n">hp</span><span class="o">.</span><span class="n">loguniform</span><span class="p">(</span><span class="s1">&#39;reg&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
    <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="n">train</span><span class="p">,</span> 
    <span class="s1">&#39;valid&#39;</span><span class="p">:</span> <span class="n">valid</span><span class="p">,</span> 
    <span class="s1">&#39;col_user&#39;</span><span class="p">:</span> <span class="n">COL_USER</span><span class="p">,</span> 
    <span class="s1">&#39;col_item&#39;</span><span class="p">:</span> <span class="n">COL_ITEM</span><span class="p">,</span> 
    <span class="s1">&#39;col_rating&#39;</span><span class="p">:</span> <span class="n">COL_RATING</span><span class="p">,</span> 
    <span class="s1">&#39;col_prediction&#39;</span><span class="p">:</span> <span class="s2">&quot;prediction&quot;</span><span class="p">,</span> 
    <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;relevancy_method&#39;</span><span class="p">:</span> <span class="s2">&quot;top_k&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="hyperparameter-tuning-with-tpe">
<h3>4.1 Hyperparameter tuning with TPE<a class="headerlink" href="#hyperparameter-tuning-with-tpe" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">fmin</span></code> of <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> is used for running the trials for searching optimal hyper parameters. In <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code>, there are different strategies for intelligently optimize hyper parameters. For example, <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> avails <a class="reference external" href="https://papers.nips.cc/paper/4443-algorithms-for-hyper-parameter-optimization.pdf">Tree of Parzen Estimators (TPE) method</a> for searching optimal parameters.</p>
<p>The TPE method models a surface response of <span class="math notranslate nohighlight">\(p(x|y)\)</span> by transforming a generative process, replacing the distributions of the configuration prior with non-parametric densities, where <span class="math notranslate nohighlight">\(p\)</span> is the probability of configuration space <span class="math notranslate nohighlight">\(x\)</span> given the loss <span class="math notranslate nohighlight">\(y\)</span>. For different configuration space, the TPE method does different replacements. That is, uniform <span class="math notranslate nohighlight">\(\to\)</span> truncated Gaussian mixture, log-uniform <span class="math notranslate nohighlight">\(\to\)</span> exponentiated truncated Gaussian mixture, categorical <span class="math notranslate nohighlight">\(\to\)</span> re-weighted categorical, etc. Using different observations <span class="math notranslate nohighlight">\({x(1), ..., x(k)}\)</span> in the non-parametric densities, these substitutions represent a learning algorithm that can produce a variety of densities over the configuration space <span class="math notranslate nohighlight">\(X\)</span>. By maintaining sorted lists of observed variables in <span class="math notranslate nohighlight">\(H\)</span>, the runtime of each iteration of the TPE algorithm can scale linearly in <span class="math notranslate nohighlight">\(|H|\)</span> and linearly in the number of variables (dimensions) being optimized. In a nutshell, the algorithm recognizes the irrelevant variables in the configuration space, and thus reduces iterations in searching for the optimal ones. Details of the TPE algorithm can be found in the reference paper.</p>
<p>The following runs the trials with the pre-defined objective function and search space. TPE is used as the optimization method. Totally there will be 10 evaluations run for searching the best parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">time_hyperopt</span><span class="p">:</span>
    <span class="c1"># Trials for recording each iteration of the hyperparameter searching.</span>
    <span class="n">trials</span> <span class="o">=</span> <span class="n">Trials</span><span class="p">()</span>

    <span class="n">best</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">(</span>
        <span class="n">fn</span><span class="o">=</span><span class="n">objective</span><span class="p">,</span>
        <span class="n">space</span><span class="o">=</span><span class="n">space</span><span class="p">,</span>
        <span class="n">algo</span><span class="o">=</span><span class="n">tpe</span><span class="o">.</span><span class="n">suggest</span><span class="p">,</span>
        <span class="n">trials</span><span class="o">=</span><span class="n">trials</span><span class="p">,</span>
        <span class="n">max_evals</span><span class="o">=</span><span class="n">NUMBER_ITERATIONS</span>
    <span class="p">)</span>
                  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trials</span><span class="o">.</span><span class="n">best_trial</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;book_time&#39;: datetime.datetime(2019, 7, 17, 12, 28, 19, 108000),
 &#39;exp_key&#39;: None,
 &#39;misc&#39;: {&#39;cmd&#39;: (&#39;domain_attachment&#39;, &#39;FMinIter_Domain&#39;),
  &#39;idxs&#39;: {&#39;rank&#39;: [21], &#39;reg&#39;: [21]},
  &#39;tid&#39;: 21,
  &#39;vals&#39;: {&#39;rank&#39;: [35.0], &#39;reg&#39;: [0.20807325457673764]},
  &#39;workdir&#39;: None},
 &#39;owner&#39;: None,
 &#39;refresh_time&#39;: datetime.datetime(2019, 7, 17, 12, 28, 28, 873000),
 &#39;result&#39;: {&#39;eval_time&#39;: 9.763921976089478,
  &#39;loss&#39;: 0.9948670591255364,
  &#39;status&#39;: &#39;ok&#39;},
 &#39;spec&#39;: None,
 &#39;state&#39;: 2,
 &#39;tid&#39;: 21,
 &#39;version&#39;: 0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;reg&#39;</span><span class="p">]</span>
<span class="n">cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="n">f</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;vals&#39;</span><span class="p">][</span><span class="n">val</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trials</span><span class="o">.</span><span class="n">trials</span><span class="p">]</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">)))</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)))</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">/* Put everything inside the global mpl namespace */
window.mpl = {};


mpl.get_websocket_type = function() {
    if (typeof(WebSocket) !== 'undefined') {
        return WebSocket;
    } else if (typeof(MozWebSocket) !== 'undefined') {
        return MozWebSocket;
    } else {
        alert('Your browser does not have WebSocket support.' +
              'Please try Chrome, Safari or Firefox ≥ 6. ' +
              'Firefox 4 and 5 are also supported but you ' +
              'have to enable WebSockets in about:config.');
    };
}

mpl.figure = function(figure_id, websocket, ondownload, parent_element) {
    this.id = figure_id;

    this.ws = websocket;

    this.supports_binary = (this.ws.binaryType != undefined);

    if (!this.supports_binary) {
        var warnings = document.getElementById("mpl-warnings");
        if (warnings) {
            warnings.style.display = 'block';
            warnings.textContent = (
                "This browser does not support binary websocket messages. " +
                    "Performance may be slow.");
        }
    }

    this.imageObj = new Image();

    this.context = undefined;
    this.message = undefined;
    this.canvas = undefined;
    this.rubberband_canvas = undefined;
    this.rubberband_context = undefined;
    this.format_dropdown = undefined;

    this.image_mode = 'full';

    this.root = $('<div/>');
    this._root_extra_style(this.root)
    this.root.attr('style', 'display: inline-block');

    $(parent_element).append(this.root);

    this._init_header(this);
    this._init_canvas(this);
    this._init_toolbar(this);

    var fig = this;

    this.waiting = false;

    this.ws.onopen =  function () {
            fig.send_message("supports_binary", {value: fig.supports_binary});
            fig.send_message("send_image_mode", {});
            if (mpl.ratio != 1) {
                fig.send_message("set_dpi_ratio", {'dpi_ratio': mpl.ratio});
            }
            fig.send_message("refresh", {});
        }

    this.imageObj.onload = function() {
            if (fig.image_mode == 'full') {
                // Full images could contain transparency (where diff images
                // almost always do), so we need to clear the canvas so that
                // there is no ghosting.
                fig.context.clearRect(0, 0, fig.canvas.width, fig.canvas.height);
            }
            fig.context.drawImage(fig.imageObj, 0, 0);
        };

    this.imageObj.onunload = function() {
        fig.ws.close();
    }

    this.ws.onmessage = this._make_on_message_function(this);

    this.ondownload = ondownload;
}

mpl.figure.prototype._init_header = function() {
    var titlebar = $(
        '<div class="ui-dialog-titlebar ui-widget-header ui-corner-all ' +
        'ui-helper-clearfix"/>');
    var titletext = $(
        '<div class="ui-dialog-title" style="width: 100%; ' +
        'text-align: center; padding: 3px;"/>');
    titlebar.append(titletext)
    this.root.append(titlebar);
    this.header = titletext[0];
}



mpl.figure.prototype._canvas_extra_style = function(canvas_div) {

}


mpl.figure.prototype._root_extra_style = function(canvas_div) {

}

mpl.figure.prototype._init_canvas = function() {
    var fig = this;

    var canvas_div = $('<div/>');

    canvas_div.attr('style', 'position: relative; clear: both; outline: 0');

    function canvas_keyboard_event(event) {
        return fig.key_event(event, event['data']);
    }

    canvas_div.keydown('key_press', canvas_keyboard_event);
    canvas_div.keyup('key_release', canvas_keyboard_event);
    this.canvas_div = canvas_div
    this._canvas_extra_style(canvas_div)
    this.root.append(canvas_div);

    var canvas = $('<canvas/>');
    canvas.addClass('mpl-canvas');
    canvas.attr('style', "left: 0; top: 0; z-index: 0; outline: 0")

    this.canvas = canvas[0];
    this.context = canvas[0].getContext("2d");

    var backingStore = this.context.backingStorePixelRatio ||
	this.context.webkitBackingStorePixelRatio ||
	this.context.mozBackingStorePixelRatio ||
	this.context.msBackingStorePixelRatio ||
	this.context.oBackingStorePixelRatio ||
	this.context.backingStorePixelRatio || 1;

    mpl.ratio = (window.devicePixelRatio || 1) / backingStore;

    var rubberband = $('<canvas/>');
    rubberband.attr('style', "position: absolute; left: 0; top: 0; z-index: 1;")

    var pass_mouse_events = true;

    canvas_div.resizable({
        start: function(event, ui) {
            pass_mouse_events = false;
        },
        resize: function(event, ui) {
            fig.request_resize(ui.size.width, ui.size.height);
        },
        stop: function(event, ui) {
            pass_mouse_events = true;
            fig.request_resize(ui.size.width, ui.size.height);
        },
    });

    function mouse_event_fn(event) {
        if (pass_mouse_events)
            return fig.mouse_event(event, event['data']);
    }

    rubberband.mousedown('button_press', mouse_event_fn);
    rubberband.mouseup('button_release', mouse_event_fn);
    // Throttle sequential mouse events to 1 every 20ms.
    rubberband.mousemove('motion_notify', mouse_event_fn);

    rubberband.mouseenter('figure_enter', mouse_event_fn);
    rubberband.mouseleave('figure_leave', mouse_event_fn);

    canvas_div.on("wheel", function (event) {
        event = event.originalEvent;
        event['data'] = 'scroll'
        if (event.deltaY < 0) {
            event.step = 1;
        } else {
            event.step = -1;
        }
        mouse_event_fn(event);
    });

    canvas_div.append(canvas);
    canvas_div.append(rubberband);

    this.rubberband = rubberband;
    this.rubberband_canvas = rubberband[0];
    this.rubberband_context = rubberband[0].getContext("2d");
    this.rubberband_context.strokeStyle = "#000000";

    this._resize_canvas = function(width, height) {
        // Keep the size of the canvas, canvas container, and rubber band
        // canvas in synch.
        canvas_div.css('width', width)
        canvas_div.css('height', height)

        canvas.attr('width', width * mpl.ratio);
        canvas.attr('height', height * mpl.ratio);
        canvas.attr('style', 'width: ' + width + 'px; height: ' + height + 'px;');

        rubberband.attr('width', width);
        rubberband.attr('height', height);
    }

    // Set the figure to an initial 600x600px, this will subsequently be updated
    // upon first draw.
    this._resize_canvas(600, 600);

    // Disable right mouse context menu.
    $(this.rubberband_canvas).bind("contextmenu",function(e){
        return false;
    });

    function set_focus () {
        canvas.focus();
        canvas_div.focus();
    }

    window.setTimeout(set_focus, 100);
}

mpl.figure.prototype._init_toolbar = function() {
    var fig = this;

    var nav_element = $('<div/>')
    nav_element.attr('style', 'width: 100%');
    this.root.append(nav_element);

    // Define a callback function for later on.
    function toolbar_event(event) {
        return fig.toolbar_button_onclick(event['data']);
    }
    function toolbar_mouse_event(event) {
        return fig.toolbar_button_onmouseover(event['data']);
    }

    for(var toolbar_ind in mpl.toolbar_items) {
        var name = mpl.toolbar_items[toolbar_ind][0];
        var tooltip = mpl.toolbar_items[toolbar_ind][1];
        var image = mpl.toolbar_items[toolbar_ind][2];
        var method_name = mpl.toolbar_items[toolbar_ind][3];

        if (!name) {
            // put a spacer in here.
            continue;
        }
        var button = $('<button/>');
        button.addClass('ui-button ui-widget ui-state-default ui-corner-all ' +
                        'ui-button-icon-only');
        button.attr('role', 'button');
        button.attr('aria-disabled', 'false');
        button.click(method_name, toolbar_event);
        button.mouseover(tooltip, toolbar_mouse_event);

        var icon_img = $('<span/>');
        icon_img.addClass('ui-button-icon-primary ui-icon');
        icon_img.addClass(image);
        icon_img.addClass('ui-corner-all');

        var tooltip_span = $('<span/>');
        tooltip_span.addClass('ui-button-text');
        tooltip_span.html(tooltip);

        button.append(icon_img);
        button.append(tooltip_span);

        nav_element.append(button);
    }

    var fmt_picker_span = $('<span/>');

    var fmt_picker = $('<select/>');
    fmt_picker.addClass('mpl-toolbar-option ui-widget ui-widget-content');
    fmt_picker_span.append(fmt_picker);
    nav_element.append(fmt_picker_span);
    this.format_dropdown = fmt_picker[0];

    for (var ind in mpl.extensions) {
        var fmt = mpl.extensions[ind];
        var option = $(
            '<option/>', {selected: fmt === mpl.default_extension}).html(fmt);
        fmt_picker.append(option)
    }

    // Add hover states to the ui-buttons
    $( ".ui-button" ).hover(
        function() { $(this).addClass("ui-state-hover");},
        function() { $(this).removeClass("ui-state-hover");}
    );

    var status_bar = $('<span class="mpl-message"/>');
    nav_element.append(status_bar);
    this.message = status_bar[0];
}

mpl.figure.prototype.request_resize = function(x_pixels, y_pixels) {
    // Request matplotlib to resize the figure. Matplotlib will then trigger a resize in the client,
    // which will in turn request a refresh of the image.
    this.send_message('resize', {'width': x_pixels, 'height': y_pixels});
}

mpl.figure.prototype.send_message = function(type, properties) {
    properties['type'] = type;
    properties['figure_id'] = this.id;
    this.ws.send(JSON.stringify(properties));
}

mpl.figure.prototype.send_draw_message = function() {
    if (!this.waiting) {
        this.waiting = true;
        this.ws.send(JSON.stringify({type: "draw", figure_id: this.id}));
    }
}


mpl.figure.prototype.handle_save = function(fig, msg) {
    var format_dropdown = fig.format_dropdown;
    var format = format_dropdown.options[format_dropdown.selectedIndex].value;
    fig.ondownload(fig, format);
}


mpl.figure.prototype.handle_resize = function(fig, msg) {
    var size = msg['size'];
    if (size[0] != fig.canvas.width || size[1] != fig.canvas.height) {
        fig._resize_canvas(size[0], size[1]);
        fig.send_message("refresh", {});
    };
}

mpl.figure.prototype.handle_rubberband = function(fig, msg) {
    var x0 = msg['x0'] / mpl.ratio;
    var y0 = (fig.canvas.height - msg['y0']) / mpl.ratio;
    var x1 = msg['x1'] / mpl.ratio;
    var y1 = (fig.canvas.height - msg['y1']) / mpl.ratio;
    x0 = Math.floor(x0) + 0.5;
    y0 = Math.floor(y0) + 0.5;
    x1 = Math.floor(x1) + 0.5;
    y1 = Math.floor(y1) + 0.5;
    var min_x = Math.min(x0, x1);
    var min_y = Math.min(y0, y1);
    var width = Math.abs(x1 - x0);
    var height = Math.abs(y1 - y0);

    fig.rubberband_context.clearRect(
        0, 0, fig.canvas.width, fig.canvas.height);

    fig.rubberband_context.strokeRect(min_x, min_y, width, height);
}

mpl.figure.prototype.handle_figure_label = function(fig, msg) {
    // Updates the figure title.
    fig.header.textContent = msg['label'];
}

mpl.figure.prototype.handle_cursor = function(fig, msg) {
    var cursor = msg['cursor'];
    switch(cursor)
    {
    case 0:
        cursor = 'pointer';
        break;
    case 1:
        cursor = 'default';
        break;
    case 2:
        cursor = 'crosshair';
        break;
    case 3:
        cursor = 'move';
        break;
    }
    fig.rubberband_canvas.style.cursor = cursor;
}

mpl.figure.prototype.handle_message = function(fig, msg) {
    fig.message.textContent = msg['message'];
}

mpl.figure.prototype.handle_draw = function(fig, msg) {
    // Request the server to send over a new figure.
    fig.send_draw_message();
}

mpl.figure.prototype.handle_image_mode = function(fig, msg) {
    fig.image_mode = msg['mode'];
}

mpl.figure.prototype.updated_canvas_event = function() {
    // Called whenever the canvas gets updated.
    this.send_message("ack", {});
}

// A function to construct a web socket function for onmessage handling.
// Called in the figure constructor.
mpl.figure.prototype._make_on_message_function = function(fig) {
    return function socket_on_message(evt) {
        if (evt.data instanceof Blob) {
            /* FIXME: We get "Resource interpreted as Image but
             * transferred with MIME type text/plain:" errors on
             * Chrome.  But how to set the MIME type?  It doesn't seem
             * to be part of the websocket stream */
            evt.data.type = "image/png";

            /* Free the memory for the previous frames */
            if (fig.imageObj.src) {
                (window.URL || window.webkitURL).revokeObjectURL(
                    fig.imageObj.src);
            }

            fig.imageObj.src = (window.URL || window.webkitURL).createObjectURL(
                evt.data);
            fig.updated_canvas_event();
            fig.waiting = false;
            return;
        }
        else if (typeof evt.data === 'string' && evt.data.slice(0, 21) == "data:image/png;base64") {
            fig.imageObj.src = evt.data;
            fig.updated_canvas_event();
            fig.waiting = false;
            return;
        }

        var msg = JSON.parse(evt.data);
        var msg_type = msg['type'];

        // Call the  "handle_{type}" callback, which takes
        // the figure and JSON message as its only arguments.
        try {
            var callback = fig["handle_" + msg_type];
        } catch (e) {
            console.log("No handler for the '" + msg_type + "' message type: ", msg);
            return;
        }

        if (callback) {
            try {
                // console.log("Handling '" + msg_type + "' message: ", msg);
                callback(fig, msg);
            } catch (e) {
                console.log("Exception inside the 'handler_" + msg_type + "' callback:", e, e.stack, msg);
            }
        }
    };
}

// from http://stackoverflow.com/questions/1114465/getting-mouse-location-in-canvas
mpl.findpos = function(e) {
    //this section is from http://www.quirksmode.org/js/events_properties.html
    var targ;
    if (!e)
        e = window.event;
    if (e.target)
        targ = e.target;
    else if (e.srcElement)
        targ = e.srcElement;
    if (targ.nodeType == 3) // defeat Safari bug
        targ = targ.parentNode;

    // jQuery normalizes the pageX and pageY
    // pageX,Y are the mouse positions relative to the document
    // offset() returns the position of the element relative to the document
    var x = e.pageX - $(targ).offset().left;
    var y = e.pageY - $(targ).offset().top;

    return {"x": x, "y": y};
};

/*
 * return a copy of an object with only non-object keys
 * we need this to avoid circular references
 * http://stackoverflow.com/a/24161582/3208463
 */
function simpleKeys (original) {
  return Object.keys(original).reduce(function (obj, key) {
    if (typeof original[key] !== 'object')
        obj[key] = original[key]
    return obj;
  }, {});
}

mpl.figure.prototype.mouse_event = function(event, name) {
    var canvas_pos = mpl.findpos(event)

    if (name === 'button_press')
    {
        this.canvas.focus();
        this.canvas_div.focus();
    }

    var x = canvas_pos.x * mpl.ratio;
    var y = canvas_pos.y * mpl.ratio;

    this.send_message(name, {x: x, y: y, button: event.button,
                             step: event.step,
                             guiEvent: simpleKeys(event)});

    /* This prevents the web browser from automatically changing to
     * the text insertion cursor when the button is pressed.  We want
     * to control all of the cursor setting manually through the
     * 'cursor' event from matplotlib */
    event.preventDefault();
    return false;
}

mpl.figure.prototype._key_event_extra = function(event, name) {
    // Handle any extra behaviour associated with a key event
}

mpl.figure.prototype.key_event = function(event, name) {

    // Prevent repeat events
    if (name == 'key_press')
    {
        if (event.which === this._key)
            return;
        else
            this._key = event.which;
    }
    if (name == 'key_release')
        this._key = null;

    var value = '';
    if (event.ctrlKey && event.which != 17)
        value += "ctrl+";
    if (event.altKey && event.which != 18)
        value += "alt+";
    if (event.shiftKey && event.which != 16)
        value += "shift+";

    value += 'k';
    value += event.which.toString();

    this._key_event_extra(event, name);

    this.send_message(name, {key: value,
                             guiEvent: simpleKeys(event)});
    return false;
}

mpl.figure.prototype.toolbar_button_onclick = function(name) {
    if (name == 'download') {
        this.handle_save(this, null);
    } else {
        this.send_message("toolbar_button", {name: name});
    }
};

mpl.figure.prototype.toolbar_button_onmouseover = function(tooltip) {
    this.message.textContent = tooltip;
};
mpl.toolbar_items = [["Home", "Reset original view", "fa fa-home icon-home", "home"], ["Back", "Back to  previous view", "fa fa-arrow-left icon-arrow-left", "back"], ["Forward", "Forward to next view", "fa fa-arrow-right icon-arrow-right", "forward"], ["", "", "", ""], ["Pan", "Pan axes with left mouse, zoom with right", "fa fa-arrows icon-move", "pan"], ["Zoom", "Zoom to rectangle", "fa fa-square-o icon-check-empty", "zoom"], ["", "", "", ""], ["Download", "Download plot", "fa fa-floppy-o icon-save", "download"]];

mpl.extensions = ["eps", "jpeg", "pdf", "png", "ps", "raw", "svg", "tif"];

mpl.default_extension = "png";var comm_websocket_adapter = function(comm) {
    // Create a "websocket"-like object which calls the given IPython comm
    // object with the appropriate methods. Currently this is a non binary
    // socket, so there is still some room for performance tuning.
    var ws = {};

    ws.close = function() {
        comm.close()
    };
    ws.send = function(m) {
        //console.log('sending', m);
        comm.send(m);
    };
    // Register the callback with on_msg.
    comm.on_msg(function(msg) {
        //console.log('receiving', msg['content']['data'], msg);
        // Pass the mpl event to the overridden (by mpl) onmessage function.
        ws.onmessage(msg['content']['data'])
    });
    return ws;
}

mpl.mpl_figure_comm = function(comm, msg) {
    // This is the function which gets called when the mpl process
    // starts-up an IPython Comm through the "matplotlib" channel.

    var id = msg.content.data.id;
    // Get hold of the div created by the display call when the Comm
    // socket was opened in Python.
    var element = $("#" + id);
    var ws_proxy = comm_websocket_adapter(comm)

    function ondownload(figure, format) {
        window.open(figure.imageObj.src);
    }

    var fig = new mpl.figure(id, ws_proxy,
                           ondownload,
                           element.get(0));

    // Call onopen now - mpl needs it, as it is assuming we've passed it a real
    // web socket which is closed, not our websocket->open comm proxy.
    ws_proxy.onopen();

    fig.parent_element = element.get(0);
    fig.cell_info = mpl.find_output_cell("<div id='" + id + "'></div>");
    if (!fig.cell_info) {
        console.error("Failed to find cell for figure", id, fig);
        return;
    }

    var output_index = fig.cell_info[2]
    var cell = fig.cell_info[0];

};

mpl.figure.prototype.handle_close = function(fig, msg) {
    var width = fig.canvas.width/mpl.ratio
    fig.root.unbind('remove')

    // Update the output cell to use the data from the current canvas.
    fig.push_to_output();
    var dataURL = fig.canvas.toDataURL();
    // Re-enable the keyboard manager in IPython - without this line, in FF,
    // the notebook keyboard shortcuts fail.
    IPython.keyboard_manager.enable()
    $(fig.parent_element).html('<img src="' + dataURL + '" width="' + width + '">');
    fig.close_ws(fig, msg);
}

mpl.figure.prototype.close_ws = function(fig, msg){
    fig.send_message('closing', msg);
    // fig.ws.close()
}

mpl.figure.prototype.push_to_output = function(remove_interactive) {
    // Turn the data on the canvas into data in the output cell.
    var width = this.canvas.width/mpl.ratio
    var dataURL = this.canvas.toDataURL();
    this.cell_info[1]['text/html'] = '<img src="' + dataURL + '" width="' + width + '">';
}

mpl.figure.prototype.updated_canvas_event = function() {
    // Tell IPython that the notebook contents must change.
    IPython.notebook.set_dirty(true);
    this.send_message("ack", {});
    var fig = this;
    // Wait a second, then push the new image to the DOM so
    // that it is saved nicely (might be nice to debounce this).
    setTimeout(function () { fig.push_to_output() }, 1000);
}

mpl.figure.prototype._init_toolbar = function() {
    var fig = this;

    var nav_element = $('<div/>')
    nav_element.attr('style', 'width: 100%');
    this.root.append(nav_element);

    // Define a callback function for later on.
    function toolbar_event(event) {
        return fig.toolbar_button_onclick(event['data']);
    }
    function toolbar_mouse_event(event) {
        return fig.toolbar_button_onmouseover(event['data']);
    }

    for(var toolbar_ind in mpl.toolbar_items){
        var name = mpl.toolbar_items[toolbar_ind][0];
        var tooltip = mpl.toolbar_items[toolbar_ind][1];
        var image = mpl.toolbar_items[toolbar_ind][2];
        var method_name = mpl.toolbar_items[toolbar_ind][3];

        if (!name) { continue; };

        var button = $('<button class="btn btn-default" href="#" title="' + name + '"><i class="fa ' + image + ' fa-lg"></i></button>');
        button.click(method_name, toolbar_event);
        button.mouseover(tooltip, toolbar_mouse_event);
        nav_element.append(button);
    }

    // Add the status bar.
    var status_bar = $('<span class="mpl-message" style="text-align:right; float: right;"/>');
    nav_element.append(status_bar);
    this.message = status_bar[0];

    // Add the close button to the window.
    var buttongrp = $('<div class="btn-group inline pull-right"></div>');
    var button = $('<button class="btn btn-mini btn-primary" href="#" title="Stop Interaction"><i class="fa fa-power-off icon-remove icon-large"></i></button>');
    button.click(function (evt) { fig.handle_close(fig, {}); } );
    button.mouseover('Stop Interaction', toolbar_mouse_event);
    buttongrp.append(button);
    var titlebar = this.root.find($('.ui-dialog-titlebar'));
    titlebar.prepend(buttongrp);
}

mpl.figure.prototype._root_extra_style = function(el){
    var fig = this
    el.on("remove", function(){
	fig.close_ws(fig, {});
    });
}

mpl.figure.prototype._canvas_extra_style = function(el){
    // this is important to make the div 'focusable
    el.attr('tabindex', 0)
    // reach out to IPython and tell the keyboard manager to turn it's self
    // off when our div gets focus

    // location in version 3
    if (IPython.notebook.keyboard_manager) {
        IPython.notebook.keyboard_manager.register_events(el);
    }
    else {
        // location in version 2
        IPython.keyboard_manager.register_events(el);
    }

}

mpl.figure.prototype._key_event_extra = function(event, name) {
    var manager = IPython.notebook.keyboard_manager;
    if (!manager)
        manager = IPython.keyboard_manager;

    // Check for shift+enter
    if (event.shiftKey && event.which == 13) {
        this.canvas_div.blur();
        event.shiftKey = false;
        // Send a "J" for go to next cell
        event.which = 74;
        event.keyCode = 74;
        manager.command_mode();
        manager.handle_keydown(event);
    }
}

mpl.figure.prototype.handle_save = function(fig, msg) {
    fig.ondownload(fig, null);
}


mpl.find_output_cell = function(html_output) {
    // Return the cell and output element which can be found *uniquely* in the notebook.
    // Note - this is a bit hacky, but it is done because the "notebook_saving.Notebook"
    // IPython event is triggered only after the cells have been serialised, which for
    // our purposes (turning an active figure into a static one), is too late.
    var cells = IPython.notebook.get_cells();
    var ncells = cells.length;
    for (var i=0; i<ncells; i++) {
        var cell = cells[i];
        if (cell.cell_type === 'code'){
            for (var j=0; j<cell.output_area.outputs.length; j++) {
                var data = cell.output_area.outputs[j];
                if (data.data) {
                    // IPython >= 3 moved mimebundle to data attribute of output
                    data = data.data;
                }
                if (data['text/html'] == html_output) {
                    return [cell, data, j];
                }
            }
        }
    }
}

// Register the function which deals with the matplotlib target/channel.
// The kernel may be null if the page has been refreshed.
if (IPython.notebook.kernel != null) {
    IPython.notebook.kernel.comm_manager.register_target('matplotlib', mpl.mpl_figure_comm);
}
</script><div class="output text_html"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABdwAAAH0CAYAAAAnhe8sAAAgAElEQVR4XuzdDdBdZXkv/CtKnKCvSGJrlQrahoSA1DGUDvLRIq3ThNI0HGmt7aslflDQSTWmVURHC9W2ehBsbPxqx0rp26FVKyihSTqtBUqAUqhoG76SDOkoULUnAaUQThDeWbsmKk+yedZ+1t73x/o9M87px9rrvu7ff527177Y7D3r8ccffzz8ESBAgAABAgQIECBAgAABAgQIECBAgAABAjMSmGXgPiM/LyZAgAABAgQIECBAgAABAgQIECBAgAABAgMBA3cPAgECBAgQIECAAAECBAgQIECAAAECBAgQ6EDAwL0DRLcgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIG7p4BAgQIECBAgAABAgQIECBAgAABAgQIECDQgYCBeweIbkGAAAECBAgQIECAAAECBAgQIECAAAECBAzcPQMECBAgQIAAAQIECBAgQIAAAQIECBAgQKADAQP3DhDdggABAgQIECBAgAABAgQIECBAgAABAgQIGLh7BggQIECAAAECBAgQIECAAAECBAgQIECAQAcCBu4dILoFAQIECBAgQIAAAQIECBAgQIAAAQIECBAwcPcMECBAgAABAgQIECBAgAABAgQIECBAgACBDgQM3DtAdAsCBAgQIECAAAECBAgQIECAAAECBAgQIGDg7hkgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIdCBi4d4DoFgQIECBAgAABAgQIECBAgAABAgQIECBAwMDdM0CAAAECBAgQIECAAAECBAgQIECAAAECBDoQMHDvANEtCBAgQIAAAQIECBAgQIAAAQIECBAgQICAgbtngAABAgQIECBAgAABAgQIECBAgAABAgQIdCBg4N4BolsQIECAAAECBAgQIECAAAECBAgQIECAAAEDd88AAQIECBAgQIAAAQIECBAgQIAAAQIECBDoQMDAvQNEtyBAgAABAgQIECBAgAABAgQIECBAgAABAgbungECBAgQIECAAAECBAgQIECAAAECBAgQINCBgIF7B4huQYAAAQIECBAgQIAAAQIECBAgQIAAAQIEDNw9AwQIECBAgAABAgQIECBAgAABAgQIECBAoAMBA/cOEN2CAAECBAgQIECAAAECBAgQIECAAAECBAgYuHsGCBAgQIAAAQIECBAgQIAAAQIECBAgQIBABwIG7h0gugUBAgQIECBAgAABAgQIECBAgAABAgQIEDBw9wwQIECAAAECBAgQIECAAAECBAgQIECAAIEOBAzcO0B0CwIECBAgQIAAAQIECBAgQIAAAQIECBAgYODuGSBAgAABAgQIECBAgAABAgQIECBAgAABAh0IGLh3gOgWBAgQIECAAAECBAgQIECAAAECBAgQIEDAwN0zQIAAAQIECBAgQIAAAQIECBAgQIAAAQIEOhAwcO8A0S0IECBAgAABAgQIECBAgAABAgQIECBAgICBu2eAAAECBAgQIECAAAECBAgQIECAAAECBAh0IGDg3gGiWxAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQN3zwABAgQIECBAgAABAgQIECBAgAABAgQIEOhAwMC9A0S3IECAAAECBAgQIECAAAECBAgQIECAAAECBu6eAQIECBAgQIAAAQIECBAgQIAAAQIECBAg0IGAgXsHiG5BgAABAgQIECBAgAABAgQIECBAgAABAgQM3D0DBAgQIECAAAECBAgQIECAAAECBAgQIECgAwED9w4Q3YIAAQIECBAgQIAAAQIECBAgQIAAAQIECBi4ewYIECBAgEALgRe+8IVx9NFHx7p161q8yqUECBAgQIAAAQIECBAgQIBAHwQM3PuQsj0SIECAQGcCBu6dUboRAQIECBAgQIAAAQIECBCoTsDAvbpIbYgAAQIEGoGHHnoonv70p3eOYeDeOakbEiBAgAABAgRmJDCuvm9GRXkxAQIECPRWwMC9t9HbOAECBOoROP/88+OCCy6IW265Jf7gD/4g/uEf/iHmzJkTV155ZXzwgx+MG2+8Mb7+9a/Hj/zIj8Txxx8f73//++MFL3jBXoBLLrkkXvva18YXv/jF+PSnPx2f+cxn4vHHH4+TTz451q5dG4cccsjea/c1cP/oRz8ab37zm+Nd73rXoA5/BAgQIECAAAEC4xHYX9933333xc033xy/93u/F9ddd93gwxdHHnlknHfeefHKV77yB4pp/vdve9vb4ktf+lI8+9nPjte97nWD3vCss86Ku+++O5p+zx8BAgQIEBhVwMB9VDmvI0CAAIFsBPa88WreKL3qVa+Kl7/85fHf//3fsXv37vi3f/u3WLx4ccybNy+aN2If+9jH4rbbbhv854d+6IcGe9gzcP/xH//xOO200+IXf/EX46tf/ergjdhLXvKSwSB+z9/3D9yboXxzzYc//OH4kz/5k1ixYkU2JgohQIAAAQIECNQosL++76CDDoqlS5fGcccdFytXroxnPetZ8Vd/9VeDPu9Tn/rU3j7tK1/5yuCahQsXxjvf+c7BvxH58Y9/fNAbbt++3cC9xofGnggQIDBhAQP3CYNbjgABAgS6F9jzxus973nP0E+Yf+c734ldu3YNPunefBK++VT69w/c3/SmN8VHPvKRvQVeeOGF8fa3v30wqH/uc587+J/vGbg3n4J/zWteE3//938ff/M3fxM/93M/1/3G3JEAAQIECBAgQOAHBPbX9zWfZj/wwAPjpptuigMOOGDva5YtWzb4tyC/9rWvxVOe8pTBp93/9m//djBc3/Phi8ceeyx+4id+YjB09wl3DxwBAgQIzFTAwH2mgl5PgAABAskF9rzx+vKXvxwvfvGL99bz4IMPxnvf+97BQLx5U9UM3Pf8nXPOOYNPuzd/ez7hvmHDhliyZMneazZu3Dj4pFTzlTTNJ6Gav2bg/rznPW/wX99zzz2DN2xHH310cgMFECBAgAABAgT6ILCvvm/r1q2xYMGCwVcJvuUtb/kBhj/90z+N5kMVzTC9Gco3H7xo+rovfOELP3Bd87WAzb0N3PvwFNkjAQIExitg4D5eX3cnQIAAgQkI7Hnj9Y1vfCN++Id/eO+Kv/RLvzT4Pvd3v/vd8VM/9VPR/KvGs2bNil/4hV8Y/KcZtDd/ewbu//Iv/xLHHnvs3tdfffXVccopp8Q//uM/xste9rLB/7wZuH/729+OnTt3Dr7n8xOf+MQEdmgJAgQIECBAgACBRmBffd+mTZvipJNOGgp07bXXxk//9E8PPv3e/HZPM4j//r/ma2Xe+MY3Grh7zAgQIEBgxgIG7jMmdAMCBAgQSC2w543XN7/5zb3/avADDzwQc+fOjd/93d8d/GfP3yOPPBLPeMYz4tWvfvXIA/fmE+2/8iu/Eq9//esH/2k+Kd/8K8r+CBAgQIAAAQIExiuwr77vzjvvjEWLFg1+IPUVr3jFPgs44ogj4pnPfOZ+P+G+574+4T7e/NydAAECfRAwcO9DyvZIgACBygX29cbrW9/61uDHsv7wD/8w3vGOd+wVaL6jvfkhrTPPPHNGA/d169bFZz/72fj1X//1wXeB/vmf/3k89alPrVza9ggQIECAAAECaQX21fc1FTU/gtp8rcxVV101tEDf4Z42P6sTIECgDwIG7n1I2R4JECBQucD+3nidfPLJ8e///u/xgQ98YPBVMNdcc0188pOfjIcffjiWL18+44F7w9p8h/sv//Ivx6mnnhqXXXZZPO1pT6tc2/YIECBAgAABAukE9tf3NV8B2PRjTf+3YsWK+NEf/dHYsWNH3H777fGv//qv0fzgffPX/ObPS1/60sGA/l3vetfgh1abr5PZvHlz/Md//MfgP4cddli6DVqZAAECBIoXMHAvPkIbIECAAIH9vfFqftS0+eGsL37xi/Hoo4/GiSeeOPgxrdNOO23wneyjfod785UyzSfc9/w13/W+bNmywXeHfu5znxu8cfNHgAABAgQIECDQvcD++r5mpa985Svx+7//+9H0Zs3v7Tz72c+Oo446avBvI5599tl7i7nuuuvid37nd+LWW28dfAXha17zmsHXEp577rlx//33D/4tSX8ECBAgQGBUAQP3UeW8jgABAgQIECBAgAABAgQIEKhC4Od//udj+/btcdddd1WxH5sgQIAAgXQCBu7p7K1MgAABAgQIECBAgAABAgQITFhg9erVsXjx4jj00EMHXzvzl3/5l4N/S7H56sHXve51E67GcgQIECBQm4CBe22J2g8BAgQIECBAgAABAgQIECCwX4HmKwe/8IUvxH/+53/GrFmzBl87s2rVqnj1q19NjQABAgQIzFjAwH3GhG5AgAABAgQIECBAgAABAgQIECBAgAABAgQiDNw9BQQIECBAgAABAgQIECBAgAABAgQIECBAoAMBA/cOEN2CAAECBAgQIECAAAECBAgQIECAAAECBAgYuHsGCBAgQIAAAQIECBAgQIAAAQIECBAgQIBABwIG7h0gukUZAo899ljce++98cxnPnPwwzj+CBAgQIAAAQJPJvD444/Ht7/97TjkkEPiKU95ypNd7n+fSECflwjesgQIECBAoGABfV7B4WVeuoF75gEprzuBr33ta3HooYd2d0N3IkCAAAECBHoj8NWvfjWe//zn92a/pW1Un1daYuolQIAAAQL5COjz8smilkoM3GtJ0j6eVOCBBx6Igw8+OJqD9KCDDnrS611AgAABAgQIEPjWt741+Af2999/fzzrWc8CkqmAPi/TYJRFgAABAgQyFtDnZRxO4aUZuBce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A/e881FdhwIO0g4x3YoAAQIECPREQP9QRtByKiMnVRIgQIAAgZwE9A85pVFXLQbudeVZxG6uvfbauPDCC+OWW26J++67Ly6//PI4/fTT91v7ddddF+eee27ccccd8dBDD8ULXvCCOPvss+Otb31rq/06SFtxuZgAAQIECBCICP1Du8dAn9fOy9UECBAgQIBAOgF9Xjr72lc2cK894Qz3t379+ti0aVMcc8wxccYZZzzpwP1LX/rSYNj+4he/OJ7xjGdEM4BvBu4f+tCH4jd/8zenvUMH6bSpXEiAAAECBAh8V0D/0O5R0Oe183I1AQIECBAgkE5An5fOvvaVDdxrTzjz/c2aNetJB+772sIrXvGKwfD9L/7iL6a9QwfptKlcSIAAAQIECBi4z/gZ0OfNmNANCBAgQIAAgTEKmBONEbfntzZw7/kDkHr7o7wRaz7xfuqpp8b73ve+eMMb3jDtLThIp03lQgIECBAgQMDAfcbPgD5vxoRuQIAAAQIECIxRwJxojLg9v7WBe88fgNTbb/NG7PnPf35885vfjEcffTTOP//8ePe73z20/EceeSSa/+z5aw7SQw89NB544IE46KCDUm/d+gQIECBAgEABAt6IjR6SPm90O68kQIAAAQIExi+gzxu/cV9XMHDva/KZ7LvNG7G77747HnzwwbjxxhvjHe94R6xduzZ+7dd+bb87aYbyF1xwwZT/vYF7JuErgwABAgQIFCDgjdjoIenzRrfzSgIECBAgQGD8Avq88Rv3dQUD974mn8m+27wR+/6Sm6+Tab6//c4779zvTnzCPZOQlUGAAAECBAoW8EZs9PD0eaPbeSUBAgQIECAwfgF93viN+7qCgXtfk89k36O+EXvve98bn/zkJ2P79u3T3omDdNpULiRAgAABAgS+K6B/GP1R0OeNbueVBAgQIECAwPgF9HnjN+7rCgbufU0+4b6br4XZunXroILFixfHxRdfHKecckrMmzcvDjvssDjvvPPinnvuiUsvvXRwzUc+8pHB/3zRokWD//66666LVatWxW/91m8Nfjh1un8O0ulKuY4AAQIECBDYI6B/aPcs6PPaebmaAAECBAgQSCegz0tnX/vKBu61J5zh/q6++urBgP2Jf2eeeWZccsklsWLFisEn15vrmr8//uM/jk984hPRfIf7AQccEPPnz4+zzjorzj777HjK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N3bmzZuXFy7F03yHHHJI3kKydQxjzIzn0rSYqfIYqG69CUi49+bkLAIECBAgQIAAAQIECBAgQIAAAQIECBAgMKaAhLsAIUCAAAECBAgQIECAAAECBAgQIECAAAECJQhIuJeAqAgCBAgQIECAAAECBAgQIECAAAECBAgQICDhLgYIECBAgAABAgQIECBAgAABAgQIECBAgEAJAhLuJSAqggABAgQIECBAgAABAgQIECBAgAABAgQISLiLAQIECBAgQIAAAQIECBAgQIAAAQIECBAgUIKAhHsJiIogQIAAAQIECBAgQIAAAQIECBAgQIAAAQIS7mKAAAECBAgQIECAAAECBAgQIECAAAECBAiUICDhXgKiIggQIECAAAECBAgQIECAAAECBAgQIECAgIS7GCBAgAABAgQIECBAgAABAgQIECBAgAABAiUISLiXgKgIAgQIECBAgAABAgQIECBAgAABAgQIECAg4S4GCBAgQIAAAQIECBAgQIAAAQIECBAgQIBACQIS7iUgKoIAAQIECBAgQIAAAQIECBAgQIAAAQIECEi4iwECBAgQIECAAAECBAgQIECAAAECBAgQIFCCgIR7CYiKIECAAAECBAgQIECAAAECBAgQIECAAAECEu5igAABAgQIECBAgAABAgQIECBAgAABAgQIlCAg4V4CoiIIECBAgAABAgQIECBAgAABAgQIECBAgICEuxggQIAAAQIECBAgQIAAAQIECBAgQIAAAQIlCEi4l4CoCAIECBAgQIAAAQIECBAgQIAAAQIECBAgIOEuBggQIECAAAECBAgQIECAAAECBAgQIECAQAkCEu4lICqCAAECBAgQIECAAAECBAgQIECAAAECBAhIuIsBAgQIECBAgAABAgQIECBAgAABAgQIECBQgoCEewmIiiBAgAABAgQIECBAgAABAgQIECBAgAABAhLuYoAAAQIECBAgQIAAAQIECBAgQIAAAQIECJQgIOFeAqIiCBAgQIAAAQIECBAgQIAAAQIECBAgQICAhLsYIECAAAECBAgQIECAAAECBAgQIECAAAECJQhIuJeAqAgCBAgQIECAAAECBAgQIECAAAECBAgQICDhLgYIECBAgAABAgQIECBAgAABAgQIECBAgEAJAhLuJSAqggABAgQIECBAgAABAgQIECBAgAABAgQISLiLAQIECBAgQIAAAQIECBAgQIAAAQIECBAgUIKAhHsJiIogQIAAAQIECBAgQIAAAQIECBAgQIAAAQIS7mKAAAECBAgQIECAAAECBAgQIECAAAECBAiUICDhXgKiIggQIECAAAECBAgQIECAAAECBAgQIECAgIS7GCBAgAABAgQIECBAgAABAgQIECBAgAABAiUI/B8uIcd76T9AFgAAAABJRU5ErkJggg==" width="1500"></div></div>
</div>
<p>It can be seen from the above plot that</p>
<ul class="simple">
<li><p>The actual impact of rank is in line with the intuition - the smaller the value the better the result.</p></li>
<li><p>It is interesting to see that the optimal value of reg is around 0.1 to 0.15.</p></li>
</ul>
<p>Get the best model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span>
    <span class="n">rank</span><span class="o">=</span><span class="n">best</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">],</span>
    <span class="n">regParam</span><span class="o">=</span><span class="n">best</span><span class="p">[</span><span class="s2">&quot;reg&quot;</span><span class="p">],</span>
    <span class="n">maxIter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">implicitPrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span>
    <span class="n">nonnegative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="o">**</span><span class="n">HEADER_ALS</span>
<span class="p">)</span>
    
<span class="n">model_best_hyperopt</span> <span class="o">=</span> <span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Tuning prameters against other metrics can be simply done by modifying the <code class="docutils literal notranslate"><span class="pre">objective</span></code> function. The following shows an objective function of how to tune “precision&#64;k”. Since <code class="docutils literal notranslate"><span class="pre">fmin</span></code> in <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> only supports minimization while the actual objective of the loss is to maximize “precision&#64;k”, <code class="docutils literal notranslate"><span class="pre">-precision</span></code> instead of <code class="docutils literal notranslate"><span class="pre">precision</span></code> is used in the returned value of the <code class="docutils literal notranslate"><span class="pre">objective</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Customize an objective function</span>
<span class="k">def</span> <span class="nf">objective_precision</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">time_run_start</span><span class="p">:</span>

        <span class="n">rank</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;reg&#39;</span><span class="p">]</span>
        <span class="n">train</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span> 
        <span class="n">valid</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> 
        <span class="n">col_user</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;col_user&#39;</span><span class="p">]</span> 
        <span class="n">col_item</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;col_item&#39;</span><span class="p">]</span>
        <span class="n">col_rating</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;col_rating&#39;</span><span class="p">]</span> 
        <span class="n">col_prediction</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;col_prediction&#39;</span><span class="p">]</span> 
        <span class="n">k</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
        <span class="n">relevancy_method</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;relevancy_method&#39;</span><span class="p">]</span>

        <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;userCol&quot;</span><span class="p">:</span> <span class="n">col_user</span><span class="p">,</span>
            <span class="s2">&quot;itemCol&quot;</span><span class="p">:</span> <span class="n">col_item</span><span class="p">,</span>
            <span class="s2">&quot;ratingCol&quot;</span><span class="p">:</span> <span class="n">col_rating</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span>
            <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span>
            <span class="n">maxIter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">implicitPrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">regParam</span><span class="o">=</span><span class="n">reg</span><span class="p">,</span>
            <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span>
            <span class="n">nonnegative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
            <span class="o">**</span><span class="n">header</span>
        <span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
    
        <span class="n">users</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col_user</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col_item</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="n">user_item</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">crossJoin</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="n">dfs_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">user_item</span><span class="p">)</span>

        <span class="c1"># Remove seen items.</span>
        <span class="n">dfs_pred_exclude_train</span> <span class="o">=</span> <span class="n">dfs_pred</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pred&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">train</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">dfs_pred</span><span class="p">[</span><span class="n">col_user</span><span class="p">]</span> <span class="o">==</span> <span class="n">train</span><span class="p">[</span><span class="n">col_user</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfs_pred</span><span class="p">[</span><span class="n">col_item</span><span class="p">]</span> <span class="o">==</span> <span class="n">train</span><span class="p">[</span><span class="n">col_item</span><span class="p">]),</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span>
        <span class="p">)</span>

        <span class="n">top_all</span> <span class="o">=</span> <span class="n">dfs_pred_exclude_train</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dfs_pred_exclude_train</span><span class="p">[</span><span class="s2">&quot;train.Rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span> \
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;pred.&#39;</span> <span class="o">+</span> <span class="n">col_user</span><span class="p">,</span> <span class="s1">&#39;pred.&#39;</span> <span class="o">+</span> <span class="n">col_item</span><span class="p">,</span> <span class="s1">&#39;pred.&#39;</span> <span class="o">+</span> <span class="s2">&quot;prediction&quot;</span><span class="p">)</span>

        <span class="n">top_all</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="n">rank_eval</span> <span class="o">=</span> <span class="n">SparkRankingEvaluation</span><span class="p">(</span>
            <span class="n">valid</span><span class="p">,</span> 
            <span class="n">top_all</span><span class="p">,</span> 
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> 
            <span class="n">col_user</span><span class="o">=</span><span class="n">col_user</span><span class="p">,</span> 
            <span class="n">col_item</span><span class="o">=</span><span class="n">col_item</span><span class="p">,</span> 
            <span class="n">col_rating</span><span class="o">=</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span> 
            <span class="n">col_prediction</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span> 
            <span class="n">relevancy_method</span><span class="o">=</span><span class="n">relevancy_method</span>
        <span class="p">)</span>

        <span class="n">precision</span> <span class="o">=</span> <span class="n">rank_eval</span><span class="o">.</span><span class="n">precision_at_k</span><span class="p">()</span>

    <span class="c1"># Return the objective function result.</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="o">-</span><span class="n">precision</span><span class="p">,</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">STATUS_OK</span><span class="p">,</span>
        <span class="s1">&#39;eval_time&#39;</span><span class="p">:</span> <span class="n">time_run_start</span><span class="o">.</span><span class="n">interval</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="hyperparameter-tuning-with-hyperopt-sampling-methods">
<h3>4.2 Hyperparameter tuning with <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> sampling methods<a class="headerlink" href="#hyperparameter-tuning-with-hyperopt-sampling-methods" title="Permalink to this headline">¶</a></h3>
<p>Though <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> works well in a single node machine, its features (e.g., <code class="docutils literal notranslate"><span class="pre">Trials</span></code> module) do not support Spark environment, which makes it hard to perform the tuning tasks in a distributed/parallel manner. It is useful to use <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> for sampling parameter values from the pre-defined sampling space, and then parallelize the model training onto Spark cluster with the sampled parameter combinations.</p>
<p>The downside of this method is that the intelligent searching algorithm (i.e., TPE) of <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> cannot be used. The approach introduced here is therefore equivalent to random search.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">time_sample</span><span class="p">:</span>
    <span class="c1"># Sample the parameters used for model building from the pre-defined space. </span>
    <span class="n">sample_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample</span><span class="p">(</span><span class="n">space</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBER_ITERATIONS</span><span class="p">)]</span>
    
    <span class="c1"># The following runs model building on the sampled parameter values with the pre-defined objective function.</span>
    <span class="n">results_map</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">objective</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">sample_params</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results_map</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;eval_time&#39;: 9.468051671981812, &#39;loss&#39;: 1.027085217204854, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 8.947720766067505, &#39;loss&#39;: 1.017764730532703, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.599841117858887, &#39;loss&#39;: 1.2995721337596726, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 8.645057439804077, &#39;loss&#39;: 0.998792404289471, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.246882200241089, &#39;loss&#39;: 1.159882028048988, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.159096479415894, &#39;loss&#39;: 1.3707996773718212, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.555922508239746, &#39;loss&#39;: 1.4255606225971154, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.555083751678467, &#39;loss&#39;: 0.9974149852593205, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.14759874343872, &#39;loss&#39;: 1.0233910316377184, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.288854122161865, &#39;loss&#39;: 1.1079683856151636, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.035703420639038, &#39;loss&#39;: 1.4973257401273627, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.43152904510498, &#39;loss&#39;: 1.3660611992616116, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.249063491821289, &#39;loss&#39;: 1.3212144812805433, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.086166143417358, &#39;loss&#39;: 1.1874756727128037, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 8.880879878997803, &#39;loss&#39;: 1.017539254275622, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.382610559463501, &#39;loss&#39;: 1.0726440276761462, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.176624774932861, &#39;loss&#39;: 1.4048578426830673, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.292484045028687, &#39;loss&#39;: 1.4308198992737957, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 8.882294178009033, &#39;loss&#39;: 1.2712116101690774, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.89118218421936, &#39;loss&#39;: 1.0887572322216503, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.102333545684814, &#39;loss&#39;: 1.449849882363006, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.27437686920166, &#39;loss&#39;: 1.0465564408902348, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.215168714523315, &#39;loss&#39;: 1.248519446580608, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.225409269332886, &#39;loss&#39;: 1.0265498645574211, &#39;status&#39;: &#39;ok&#39;},
 {&#39;eval_time&#39;: 9.08506464958191, &#39;loss&#39;: 1.254533287299843, &#39;status&#39;: &#39;ok&#39;}]
</pre></div>
</div>
</div>
</div>
<p>Get the best model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">loss_metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results_map</span><span class="p">])</span>
<span class="n">best_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">loss_metrics</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">loss_metrics</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_param</span> <span class="o">=</span> <span class="n">sample_params</span><span class="p">[</span><span class="n">best_loss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span>
    <span class="n">rank</span><span class="o">=</span><span class="n">best_param</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">],</span>
    <span class="n">regParam</span><span class="o">=</span><span class="n">best_param</span><span class="p">[</span><span class="s2">&quot;reg&quot;</span><span class="p">],</span>
    <span class="n">maxIter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">implicitPrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span>
    <span class="n">nonnegative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="o">**</span><span class="n">HEADER_ALS</span>
<span class="p">)</span>
    
<span class="n">model_best_sample</span> <span class="o">=</span> <span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="evaluation-on-testing-data">
<h2>5 Evaluation on testing data<a class="headerlink" href="#evaluation-on-testing-data" title="Permalink to this headline">¶</a></h2>
<p>The optimal parameters can then be used for building a recommender, which is then evaluated on the testing data.</p>
<p>The following codes generate the evaluation results by using the testing dataset with the optimal model selected against the pre-defined loss. Without loss of generity, in this case, the optimal model that performs the best w.r.t regression loss (i.e., the RMSE metric) is used. One can simply use other metrics like precision&#64;k, as illustrated in the above sections, to evaluate the optimal model on the testing dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get prediction results with the optimal modesl from different approaches.</span>
<span class="n">prediction_spark</span> <span class="o">=</span> <span class="n">model_best_spark</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="n">prediction_hyperopt</span> <span class="o">=</span> <span class="n">model_best_hyperopt</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
<span class="n">prediction_sample</span> <span class="o">=</span> <span class="n">model_best_sample</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

<span class="n">predictions</span> <span class="o">=</span> <span class="p">[</span><span class="n">prediction_spark</span><span class="p">,</span> <span class="n">prediction_hyperopt</span><span class="p">,</span> <span class="n">prediction_sample</span><span class="p">]</span>
<span class="n">elapsed</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_spark</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">time_hyperopt</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span> <span class="n">time_sample</span><span class="o">.</span><span class="n">interval</span><span class="p">]</span>

<span class="n">approaches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spark&#39;</span><span class="p">,</span> <span class="s1">&#39;hyperopt&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">]</span>
<span class="n">test_evaluations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">approach</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">approaches</span><span class="p">):</span>    
    <span class="n">rating_eval</span> <span class="o">=</span> <span class="n">SparkRatingEvaluation</span><span class="p">(</span>
        <span class="n">test</span><span class="p">,</span> 
        <span class="n">predictions</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span>
        <span class="o">**</span><span class="n">HEADER</span>
    <span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Approach&#39;</span><span class="p">:</span> <span class="n">approach</span><span class="p">,</span>
        <span class="s1">&#39;RMSE&#39;</span><span class="p">:</span> <span class="n">rating_eval</span><span class="o">.</span><span class="n">rmse</span><span class="p">(),</span>
        <span class="s1">&#39;MAE&#39;</span><span class="p">:</span> <span class="n">rating_eval</span><span class="o">.</span><span class="n">mae</span><span class="p">(),</span>
        <span class="s1">&#39;Explained variance&#39;</span><span class="p">:</span> <span class="n">rating_eval</span><span class="o">.</span><span class="n">exp_var</span><span class="p">(),</span>
        <span class="s1">&#39;R squared&#39;</span><span class="p">:</span> <span class="n">rating_eval</span><span class="o">.</span><span class="n">rsquared</span><span class="p">(),</span>
        <span class="s1">&#39;Elapsed&#39;</span><span class="p">:</span> <span class="n">elapsed</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">test_evaluations</span> <span class="o">=</span> <span class="n">test_evaluations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_evaluations</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Approach</th>
      <th>Elapsed</th>
      <th>Explained variance</th>
      <th>MAE</th>
      <th>R squared</th>
      <th>RMSE</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>spark</td>
      <td>133.150098</td>
      <td>0.289853</td>
      <td>0.776693</td>
      <td>0.252805</td>
      <td>0.976022</td>
    </tr>
    <tr>
      <th>0</th>
      <td>hyperopt</td>
      <td>235.779974</td>
      <td>0.299736</td>
      <td>0.790172</td>
      <td>0.240981</td>
      <td>0.983563</td>
    </tr>
    <tr>
      <th>0</th>
      <td>sample</td>
      <td>230.902271</td>
      <td>0.287638</td>
      <td>0.791199</td>
      <td>0.232688</td>
      <td>0.988922</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>From the results, it can be seen that, <em>with the same number of iterations</em>, Spark native construct based approach takes the least amount of time, even if there is no parallel computing. This is simply because Spark native constructs leverage the underlying Java codes for running the actual analytics with high performance efficiency. Interestingly, the run time for <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> with TPE algorithm and random search methods are almost the same. Possible reasons for this are that, the TPE algorithm searches optimal parameters intelligently but runs the tuning iterations sequentially. Also, the advantage of TPE may become obvious when there is a higher dimensionality of hyperparameters.</p>
<p>The three approaches use the same RMSE loss. In this measure, the native Spark construct performs the best. The <code class="docutils literal notranslate"><span class="pre">hyperopt</span></code> based approach performs the second best, but the advantage is very subtle. It should be noted that these differences may be owing to many factors like characteristics of datasets, dimensionality of hyperparameter space, sampling size in the searching, etc. Note the differences in the RMSE metrics may also come from the randomness of the intermediate steps in parameter tuning process. In practice, multiple runs are required for generating statistically robust comparison results. We have tried 5 times for running the same comparison codes above. The results aligned well with each other in terms of objective metric values and elapsed time.</p>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="conclusions">
<h1>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline">¶</a></h1>
<p>In summary, there are mainly three different approaches for running hyperparameter tuning for Spark based recommendation algorithm. The three different approaches are compared as follows.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Approach</p></th>
<th class="head"><p>Distributed (on Spark)</p></th>
<th class="head"><p>Param sampling</p></th>
<th class="head"><p>Advanced hyperparam searching algo</p></th>
<th class="head"><p>Custom evaluation metrics</p></th>
<th class="head"><p>Custom data split</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>AzureML Services</p></td>
<td><p>Parallelizing Spark sessions on multi-node cluster or single Spark session on one VM node.)</p></td>
<td><p>Random, Grid, Bayesian sampling for discrete and continuous variables.</p></td>
<td><p>Bandit policy, Median stopping policy, and truncation selection policy.</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>Spark native construct</p></td>
<td><p>Distributed in single-node standalone Spark environment or multi-node Spark cluster.</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>Need to re-engineer Spark modules</p></td>
<td><p>Need to re-engineer Spark modules.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">hyperopt</span></code></p></td>
<td><p>No (only support parallelization on MongoDB)</p></td>
<td><p>Random sampling for discrete and continuous variables.</p></td>
<td><p>Tree Parzen Estimator</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cleanup spark instance</span>
<span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Azure Machine Learning Services, url: <a class="reference external" href="https://azure.microsoft.com/en-us/services/machine-learning-service/">https://azure.microsoft.com/en-us/services/machine-learning-service/</a></p></li>
<li><p>Lisa Li, <em>et al</em>, Hyperband: A Novel Bandit-Based Approach to Hyperparameter Optimization, The Journal of Machine Learning Research, Volume 18 Issue 1, pp 6765-6816, January 2017.</p></li>
<li><p>James Bergstrat <em>et al</em>, Algorithms for Hyper-Parameter Optimization, Procs 25th NIPS 2011.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hyperopt</span></code>, url: <a class="reference external" href="http://hyperopt.github.io/hyperopt/">http://hyperopt.github.io/hyperopt/</a>.</p></li>
<li><p>Bergstra, J., Yamins, D., Cox, D. D. (2013) Making a Science of Model Search: Hyperparameter Optimization in Hundreds of Dimensions for Vision Architectures. Proc. of the 30th International Conference on Machine Learning (ICML 2013).</p></li>
<li><p>Kris Wright, “Hyper parameter tuning with hyperopt”, url:<a class="reference external" href="https://districtdatalabs.silvrback.com/parameter-tuning-with-hyperopt">https://districtdatalabs.silvrback.com/parameter-tuning-with-hyperopt</a></p></li>
</ul>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "reco_pyspark"
        },
        kernelOptions: {
            kernelName: "reco_pyspark",
            path: "./examples/04_model_select_and_optimize"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'reco_pyspark'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>