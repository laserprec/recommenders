
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spark Collaborative Filtering (ALS) Deep Dive &#8212; &lt;h1 style=&#34;font-size:1.7em;text-align:center;color:#FF5733&#34;&gt;Recommenders&lt;/h1&gt;</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Estimating Baseline Performance" href="baseline_deep_dive.html" />
    <link rel="prev" title="Neural Collaborative Filtering on MovieLens dataset." href="../00_quick_start/ncf_movielens.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title"><h1 style="font-size:1.7em;text-align:center;color:#FF5733">Recommenders</h1></h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption" role="heading">
 <span class="caption-text">
  Quick Start
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../00_quick_start/als_movielens.html">
   Running ALS on MovieLens (PySpark)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../00_quick_start/ncf_movielens.html">
   Neural Collaborative Filtering on MovieLens dataset.
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Deep Dive
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Spark Collaborative Filtering (ALS) Deep Dive
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="baseline_deep_dive.html">
   Estimating Baseline Performance
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  API Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/datasets.html">
   Dataset module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/evaluation.html">
   Evaluation module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/models.html">
   Recommender algorithms module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/tuning.html">
   Hyperparameter tuning module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source/utils.html">
   Common utilities module
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/examples/02_model_collaborative_filtering/als_deep_dive.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/microsoft/recommenders"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/microsoft/recommenders/issues/new?title=Issue%20on%20page%20%2Fexamples/02_model_collaborative_filtering/als_deep_dive.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/microsoft/recommenders/main?urlpath=tree/docs/examples/02_model_collaborative_filtering/als_deep_dive.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#matrix-factorization-algorithm">
   1 Matrix factorization algorithm
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#matrix-factorization-for-collaborative-filtering-problem">
     1.1 Matrix factorization for collaborative filtering problem
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#alternating-least-square-als">
     1.2 Alternating Least Square (ALS)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spark-mllib-implementation">
   2 Spark Mllib implementation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spark-als-based-movielens-recommender">
   3 Spark ALS based MovieLens recommender
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-and-prepare-data">
     3.1 Load and prepare data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-a-movielens-model">
     3.2 Train a movielens model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#prediction-with-the-model">
     3.3 Prediction with the model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fine-tune-the-model">
     3.4 Fine tune the model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#top-k-recommendation">
     3.5 Top K recommendation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#top-k-for-all-users-items">
       3.5.1 Top k for all users (items)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#top-k-for-a-selected-set-of-users-items">
       3.5.2 Top k for a selected set of users (items)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#run-time-considerations-for-top-k-recommendations">
       3.5.3 Run-time considerations for top-k recommendations
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><i>Copyright (c) Microsoft Corporation. All rights reserved.</i></p>
<p><i>Licensed under the MIT License.</i></p>
<div class="tex2jax_ignore mathjax_ignore section" id="spark-collaborative-filtering-als-deep-dive">
<h1>Spark Collaborative Filtering (ALS) Deep Dive<a class="headerlink" href="#spark-collaborative-filtering-als-deep-dive" title="Permalink to this headline">¶</a></h1>
<p>Spark MLlib provides a collaborative filtering algorithm that can be used for training a matrix factorization model, which predicts explicit or implicit ratings of users on items for recommendations.</p>
<p>This notebook presents a deep dive into the Spark collaborative filtering algorithm.</p>
<div class="section" id="matrix-factorization-algorithm">
<h2>1 Matrix factorization algorithm<a class="headerlink" href="#matrix-factorization-algorithm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="matrix-factorization-for-collaborative-filtering-problem">
<h3>1.1 Matrix factorization for collaborative filtering problem<a class="headerlink" href="#matrix-factorization-for-collaborative-filtering-problem" title="Permalink to this headline">¶</a></h3>
<p>Matrix factorization is a common technique used in recommendation tasks. Basically, a matrix factorization algorithm tries to find latent factors that represent intrinsic user and item attributes in a lower dimension. That is,</p>
<div class="math notranslate nohighlight">
\[\hat r_{u,i} = q_{i}^{T}p_{u}\]</div>
<p>where <span class="math notranslate nohighlight">\(\hat r_{u,i}\)</span> is the predicted ratings for user <span class="math notranslate nohighlight">\(u\)</span> and item <span class="math notranslate nohighlight">\(i\)</span>, and <span class="math notranslate nohighlight">\(q_{i}^{T}\)</span> and <span class="math notranslate nohighlight">\(p_{u}\)</span> are latent factors for item and user, respectively. The challenge to the matrix factorization problem is to find <span class="math notranslate nohighlight">\(q_{i}^{T}\)</span> and <span class="math notranslate nohighlight">\(p_{u}\)</span>. This is achieved by methods such as matrix decomposition. A learning approach is therefore developed to converge the decomposition results close to the observed ratings as much as possible. Furthermore, to avoid overfitting issue, the learning process is regularized. For example, a basic form of such matrix factorization algorithm is represented as below.</p>
<div class="math notranslate nohighlight">
\[\min\sum(r_{u,i} - q_{i}^{T}p_{u})^2 + \lambda(||q_{i}||^2 + ||p_{u}||^2)\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda\)</span> is a the regularization parameter.</p>
<p>In case explict ratings are not available, implicit ratings which are usually derived from users’ historical interactions with the items (e.g., clicks, views, purchases, etc.). To account for such implicit ratings, the original matrix factorization algorithm can be formulated as</p>
<div class="math notranslate nohighlight">
\[\min\sum c_{u,i}(p_{u,i} - q_{i}^{T}p_{u})^2 + \lambda(||q_{i}||^2 + ||p_{u}||^2)\]</div>
<p>where <span class="math notranslate nohighlight">\(c_{u,i}=1+\alpha r_{u,i}\)</span> and <span class="math notranslate nohighlight">\(p_{u,i}=1\)</span> if <span class="math notranslate nohighlight">\(r_{u,i}&gt;0\)</span> and <span class="math notranslate nohighlight">\(p_{u,i}=0\)</span> if <span class="math notranslate nohighlight">\(r_{u,i}=0\)</span>. <span class="math notranslate nohighlight">\(r_{u,i}\)</span> is a numerical representation of users’ preferences (e.g., number of clicks, etc.).</p>
</div>
<div class="section" id="alternating-least-square-als">
<h3>1.2 Alternating Least Square (ALS)<a class="headerlink" href="#alternating-least-square-als" title="Permalink to this headline">¶</a></h3>
<p>Owing to the term of <span class="math notranslate nohighlight">\(q_{i}^{T}p_{u}\)</span> the loss function is non-convex. Gradient descent method can be applied but this will incur expensive computations. An Alternating Least Square (ALS) algorithm was therefore developed to overcome this issue.</p>
<p>The basic idea of ALS is to learn one of <span class="math notranslate nohighlight">\(q\)</span> and <span class="math notranslate nohighlight">\(p\)</span> at a time for optimization while keeping the other as constant. This makes the objective at each iteration convex and solvable. The alternating between <span class="math notranslate nohighlight">\(q\)</span> and <span class="math notranslate nohighlight">\(p\)</span> stops when there is convergence to the optimal. It is worth noting that this iterative computation can be parallelised and/or distributed, which makes the algorithm desirable for use cases where the dataset is large and thus the user-item rating matrix is super sparse (as is typical in recommendation scenarios). A comprehensive discussion of ALS and its distributed computation can be found <a class="reference external" href="http://stanford.edu/%7Erezab/classes/cme323/S15/notes/lec14.pdf">here</a>.</p>
</div>
</div>
<div class="section" id="spark-mllib-implementation">
<h2>2 Spark Mllib implementation<a class="headerlink" href="#spark-mllib-implementation" title="Permalink to this headline">¶</a></h2>
<p>The matrix factorization algorithm is available as <code class="docutils literal notranslate"><span class="pre">ALS</span></code> module in <a class="reference external" href="https://spark.apache.org/docs/latest/ml-collaborative-filtering.html">Spark <code class="docutils literal notranslate"><span class="pre">ml</span></code></a> for DataFrame or <a class="reference external" href="https://spark.apache.org/docs/latest/mllib-collaborative-filtering.html">Spark <code class="docutils literal notranslate"><span class="pre">mllib</span></code></a> for RDD.</p>
<ul class="simple">
<li><p>The uniqueness of ALS implementation is that it distributes the matrix factorization model training by using “Alternating Least Square” method.</p></li>
<li><p>In the training method, there are parameters that can be selected to control the model performance.</p></li>
<li><p>Both explicit and implicit ratings are supported by Spark ALS model.</p></li>
</ul>
</div>
<div class="section" id="spark-als-based-movielens-recommender">
<h2>3 Spark ALS based MovieLens recommender<a class="headerlink" href="#spark-als-based-movielens-recommender" title="Permalink to this headline">¶</a></h2>
<p>In the following code, the MovieLens-100K dataset is used to illustrate the ALS algorithm in Spark.</p>
<p><strong>Note</strong>: This notebook requires a PySpark environment to run properly. Please follow the steps in <a class="reference external" href="https://github.com/Microsoft/Recommenders/blob/master/SETUP.md#dependencies-setup">SETUP.md</a> to install the PySpark environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the environment path to find Recommenders</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">pyspark</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.recommendation</span> <span class="kn">import</span> <span class="n">ALS</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.tuning</span> <span class="kn">import</span> <span class="n">CrossValidator</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">LongType</span>

<span class="kn">from</span> <span class="nn">recommenders.datasets</span> <span class="kn">import</span> <span class="n">movielens</span>
<span class="kn">from</span> <span class="nn">recommenders.utils.spark_utils</span> <span class="kn">import</span> <span class="n">start_or_get_spark</span>
<span class="kn">from</span> <span class="nn">recommenders.evaluation.spark_evaluation</span> <span class="kn">import</span> <span class="n">SparkRankingEvaluation</span><span class="p">,</span> <span class="n">SparkRatingEvaluation</span>
<span class="kn">from</span> <span class="nn">recommenders.tuning.parameter_sweep</span> <span class="kn">import</span> <span class="n">generate_param_grid</span>
<span class="kn">from</span> <span class="nn">recommenders.datasets.spark_splitters</span> <span class="kn">import</span> <span class="n">spark_random_split</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;System version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pandas version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PySpark version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pyspark</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>System version: 3.6.9 (default, Jan 26 2021, 15:33:00) 
[GCC 8.4.0]
Pandas version: 1.1.5
PySpark version: 2.4.8
</pre></div>
</div>
</div>
</div>
<p>Data column names</p>
<div class="cell tag_parameters docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MOVIELENS_DATA_SIZE</span> <span class="o">=</span> <span class="s2">&quot;100k&quot;</span>

<span class="n">COL_USER</span> <span class="o">=</span> <span class="s2">&quot;UserId&quot;</span>
<span class="n">COL_ITEM</span> <span class="o">=</span> <span class="s2">&quot;MovieId&quot;</span>
<span class="n">COL_RATING</span> <span class="o">=</span> <span class="s2">&quot;Rating&quot;</span>
<span class="n">COL_PREDICTION</span> <span class="o">=</span> <span class="s2">&quot;prediction&quot;</span>
<span class="n">COL_TIMESTAMP</span> <span class="o">=</span> <span class="s2">&quot;Timestamp&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">StructField</span><span class="p">(</span><span class="n">COL_USER</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
        <span class="n">StructField</span><span class="p">(</span><span class="n">COL_ITEM</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
        <span class="n">StructField</span><span class="p">(</span><span class="n">COL_RATING</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">()),</span>
        <span class="n">StructField</span><span class="p">(</span><span class="n">COL_TIMESTAMP</span><span class="p">,</span> <span class="n">LongType</span><span class="p">()),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Model hyper parameters - these parameters are selected with reference to the benchmarking results <a class="reference external" href="http://mymedialite.net/examples/datasets.html">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RANK</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">MAX_ITER</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">REG_PARAM</span> <span class="o">=</span> <span class="mf">0.05</span>
</pre></div>
</div>
</div>
</div>
<p>Number of recommended items</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">K</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<p>Initialize a Spark session.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="n">start_or_get_spark</span><span class="p">(</span><span class="s2">&quot;ALS Deep Dive&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="s2">&quot;16g&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="load-and-prepare-data">
<h3>3.1 Load and prepare data<a class="headerlink" href="#load-and-prepare-data" title="Permalink to this headline">¶</a></h3>
<p>Data is read from csv into a Spark DataFrame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfs</span> <span class="o">=</span> <span class="n">movielens</span><span class="o">.</span><span class="n">load_spark_df</span><span class="p">(</span><span class="n">spark</span><span class="o">=</span><span class="n">spark</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">MOVIELENS_DATA_SIZE</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 4.81k/4.81k [00:00&lt;00:00, 20.5kKB/s]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfs</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+------+-------+------+---------+
|UserId|MovieId|Rating|Timestamp|
+------+-------+------+---------+
|   196|    242|   3.0|881250949|
|   186|    302|   3.0|891717742|
|    22|    377|   1.0|878887116|
|   244|     51|   2.0|880606923|
|   166|    346|   1.0|886397596|
+------+-------+------+---------+
only showing top 5 rows
</pre></div>
</div>
</div>
</div>
<p>Data is then randomly split by 80-20 ratio for training and testing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfs_train</span><span class="p">,</span> <span class="n">dfs_test</span> <span class="o">=</span> <span class="n">spark_random_split</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="train-a-movielens-model">
<h3>3.2 Train a movielens model<a class="headerlink" href="#train-a-movielens-model" title="Permalink to this headline">¶</a></h3>
<p>It is worth noting that Spark ALS model allows dropping cold users to favor a robust evaluation with the testing data. In case there are cold users, Spark ALS implementation allows users to drop cold users in order to make sure evaluations on the prediction results are sound.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span>
    <span class="n">maxIter</span><span class="o">=</span><span class="n">MAX_ITER</span><span class="p">,</span> 
    <span class="n">rank</span><span class="o">=</span><span class="n">RANK</span><span class="p">,</span>
    <span class="n">regParam</span><span class="o">=</span><span class="n">REG_PARAM</span><span class="p">,</span> 
    <span class="n">userCol</span><span class="o">=</span><span class="n">COL_USER</span><span class="p">,</span> 
    <span class="n">itemCol</span><span class="o">=</span><span class="n">COL_ITEM</span><span class="p">,</span> 
    <span class="n">ratingCol</span><span class="o">=</span><span class="n">COL_RATING</span><span class="p">,</span> 
    <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span>
<span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfs_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="prediction-with-the-model">
<h3>3.3 Prediction with the model<a class="headerlink" href="#prediction-with-the-model" title="Permalink to this headline">¶</a></h3>
<p>The trained model can be used to predict ratings with a given test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfs_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dfs_test</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">COL_RATING</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With the prediction results, the model performance can be evaluated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluations</span> <span class="o">=</span> <span class="n">SparkRatingEvaluation</span><span class="p">(</span>
    <span class="n">dfs_test</span><span class="p">,</span> 
    <span class="n">dfs_pred</span><span class="p">,</span>
    <span class="n">col_user</span><span class="o">=</span><span class="n">COL_USER</span><span class="p">,</span>
    <span class="n">col_item</span><span class="o">=</span><span class="n">COL_ITEM</span><span class="p">,</span>
    <span class="n">col_rating</span><span class="o">=</span><span class="n">COL_RATING</span><span class="p">,</span>
    <span class="n">col_prediction</span><span class="o">=</span><span class="n">COL_PREDICTION</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;RMSE score = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">evaluations</span><span class="o">.</span><span class="n">rmse</span><span class="p">()),</span>
    <span class="s2">&quot;MAE score = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">evaluations</span><span class="o">.</span><span class="n">mae</span><span class="p">()),</span>
    <span class="s2">&quot;R2 score = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">evaluations</span><span class="o">.</span><span class="n">rsquared</span><span class="p">()),</span>
    <span class="s2">&quot;Explained variance score = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">evaluations</span><span class="o">.</span><span class="n">exp_var</span><span class="p">()),</span>
    <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RMSE score = 0.9726930349322086
MAE score = 0.7565710909806911
R2 score = 0.24411065820407096
Explained variance score = 0.249700271662727
</pre></div>
</div>
</div>
</div>
<p>Oftentimes ranking metrics are also of interest to data scientists. Note usually ranking metrics apply to the scenario of recommending a list of items. In our case, the recommended items should be different from those that have been rated by the users.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the cross join of all user-item pairs and score them.</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">dfs_train</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">COL_USER</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">dfs_train</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">COL_ITEM</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
<span class="n">user_item</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">crossJoin</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
<span class="n">dfs_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">user_item</span><span class="p">)</span>

<span class="c1"># Remove seen items.</span>
<span class="n">dfs_pred_exclude_train</span> <span class="o">=</span> <span class="n">dfs_pred</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pred&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">dfs_train</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">dfs_pred</span><span class="p">[</span><span class="n">COL_USER</span><span class="p">]</span> <span class="o">==</span> <span class="n">dfs_train</span><span class="p">[</span><span class="n">COL_USER</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfs_pred</span><span class="p">[</span><span class="n">COL_ITEM</span><span class="p">]</span> <span class="o">==</span> <span class="n">dfs_train</span><span class="p">[</span><span class="n">COL_ITEM</span><span class="p">]),</span>
    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span>
<span class="p">)</span>

<span class="n">dfs_pred_final</span> <span class="o">=</span> <span class="n">dfs_pred_exclude_train</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dfs_pred_exclude_train</span><span class="p">[</span><span class="s2">&quot;train.Rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;pred.&#39;</span> <span class="o">+</span> <span class="n">COL_USER</span><span class="p">,</span> <span class="s1">&#39;pred.&#39;</span> <span class="o">+</span> <span class="n">COL_ITEM</span><span class="p">,</span> <span class="s1">&#39;pred.&#39;</span> <span class="o">+</span> <span class="s2">&quot;prediction&quot;</span><span class="p">)</span>

<span class="n">dfs_pred_final</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+------+-------+----------+
|UserId|MovieId|prediction|
+------+-------+----------+
|     1|    587| 3.2763875|
|     1|    869|  1.996331|
|     1|   1208| 3.0924819|
|     1|   1677| 3.0549564|
|     2|     80| 2.2266486|
|     2|    303| 3.5071766|
|     2|    472| 2.4076686|
|     2|    582|  4.137449|
|     2|    838| 1.6214753|
|     2|    975| 2.7880914|
|     2|   1260|  3.155648|
|     2|   1325| 1.2494813|
|     2|   1381|  3.712147|
|     2|   1530|   2.04168|
|     3|     22| 2.5458775|
|     3|     57| 1.7472819|
|     3|     89|   3.85607|
|     3|    367| 3.2235723|
|     3|   1091| 1.5452085|
|     3|   1167| 3.5050836|
+------+-------+----------+
only showing top 20 rows
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluations</span> <span class="o">=</span> <span class="n">SparkRankingEvaluation</span><span class="p">(</span>
    <span class="n">dfs_test</span><span class="p">,</span> 
    <span class="n">dfs_pred_final</span><span class="p">,</span>
    <span class="n">col_user</span><span class="o">=</span><span class="n">COL_USER</span><span class="p">,</span>
    <span class="n">col_item</span><span class="o">=</span><span class="n">COL_ITEM</span><span class="p">,</span>
    <span class="n">col_rating</span><span class="o">=</span><span class="n">COL_RATING</span><span class="p">,</span>
    <span class="n">col_prediction</span><span class="o">=</span><span class="n">COL_PREDICTION</span><span class="p">,</span>
    <span class="n">k</span><span class="o">=</span><span class="n">K</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Precision@k = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">evaluations</span><span class="o">.</span><span class="n">precision_at_k</span><span class="p">()),</span>
    <span class="s2">&quot;Recall@k = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">evaluations</span><span class="o">.</span><span class="n">recall_at_k</span><span class="p">()),</span>
    <span class="s2">&quot;NDCG@k = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">evaluations</span><span class="o">.</span><span class="n">ndcg_at_k</span><span class="p">()),</span>
    <span class="s2">&quot;Mean average precision = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">evaluations</span><span class="o">.</span><span class="n">map_at_k</span><span class="p">()),</span>
    <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Precision@k = 0.03170731707317073
Recall@k = 0.012679519170565132
NDCG@k = 0.02914424248125332
Mean average precision = 0.0033674440032626088
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="fine-tune-the-model">
<h3>3.4 Fine tune the model<a class="headerlink" href="#fine-tune-the-model" title="Permalink to this headline">¶</a></h3>
<p>Prediction performance of a Spark ALS model is often affected by the parameters</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Default value</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">rank</span></code></p></td>
<td><p>Number of latent factors</p></td>
<td><p>10</p></td>
<td><p>The larger the more intrinsic factors considered in the factorization modeling.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">regParam</span></code></p></td>
<td><p>Regularization parameter</p></td>
<td><p>1.0</p></td>
<td><p>The value needs to be selected empirically to avoid overfitting.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">maxIters</span></code></p></td>
<td><p>Maximum number of iterations</p></td>
<td><p>10</p></td>
<td><p>The more iterations the better the model converges to the optimal point.</p></td>
</tr>
</tbody>
</table>
<p>It is always a good practice to start model building with default parameter values and then sweep the parameter in a range to find the optimal combination of parameters. The following parameter set is used for training ALS models for comparison study purposes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
    <span class="s2">&quot;regParam&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Generate a dictionary for each parameter combination which can then be fed into model training.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_grid</span> <span class="o">=</span> <span class="n">generate_param_grid</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Train models with parameters specified in the parameter grid. Evaluate the model with, for example, the RMSE metric, and then record the metrics for visualization.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rmse_score</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">param_grid</span><span class="p">:</span>
    <span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span>        
        <span class="n">userCol</span><span class="o">=</span><span class="n">COL_USER</span><span class="p">,</span> 
        <span class="n">itemCol</span><span class="o">=</span><span class="n">COL_ITEM</span><span class="p">,</span> 
        <span class="n">ratingCol</span><span class="o">=</span><span class="n">COL_RATING</span><span class="p">,</span> 
        <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">g</span>
    <span class="p">)</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dfs_train</span><span class="p">)</span>
    
    <span class="n">dfs_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">dfs_test</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">COL_RATING</span><span class="p">)</span>
    
    <span class="n">evaluations</span> <span class="o">=</span> <span class="n">SparkRatingEvaluation</span><span class="p">(</span>
        <span class="n">dfs_test</span><span class="p">,</span> 
        <span class="n">dfs_pred</span><span class="p">,</span>
        <span class="n">col_user</span><span class="o">=</span><span class="n">COL_USER</span><span class="p">,</span>
        <span class="n">col_item</span><span class="o">=</span><span class="n">COL_ITEM</span><span class="p">,</span>
        <span class="n">col_rating</span><span class="o">=</span><span class="n">COL_RATING</span><span class="p">,</span>
        <span class="n">col_prediction</span><span class="o">=</span><span class="n">COL_PREDICTION</span>
    <span class="p">)</span>

    <span class="n">rmse_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evaluations</span><span class="o">.</span><span class="n">rmse</span><span class="p">())</span>

<span class="n">rmse_score</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rmse_score</span><span class="p">]</span>
<span class="n">rmse_score_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rmse_score</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;regParam&quot;</span><span class="p">])))</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rmse_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">rmse_score_array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;rank&quot;</span><span class="p">),</span> 
                       <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;regParam&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;reg. parameter&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">rmse_df</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.4g&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;AxesSubplot:xlabel=&#39;reg. parameter&#39;, ylabel=&#39;rank&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/als_deep_dive_40_1.png" src="../../_images/als_deep_dive_40_1.png" />
</div>
</div>
<p>The calculated RMSE scores can be visualized to comparatively study how model performance is affected by different parameters.</p>
<p>It can be seen from this visualization that RMSE first decreases and then increases as rank increases, due to overfitting. When the rank equals 20 and the regularization parameter equals 0.1, the model achieves the lowest RMSE score.</p>
</div>
<div class="section" id="top-k-recommendation">
<h3>3.5 Top K recommendation<a class="headerlink" href="#top-k-recommendation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="top-k-for-all-users-items">
<h4>3.5.1 Top k for all users (items)<a class="headerlink" href="#top-k-for-all-users-items" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfs_rec</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">recommendForAllUsers</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfs_rec</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+------+--------------------+
|UserId|     recommendations|
+------+--------------------+
|   471|[[814, 3.7504895]...|
|   463|[[814, 3.1264873]...|
|   833|[[814, 3.3154662]...|
|   496|[[814, 3.055388],...|
|   148|[[814, 4.03012], ...|
|   540|[[814, 3.8661027]...|
|   392|[[814, 4.119951],...|
|   243|[[814, 3.748784],...|
|   623|[[814, 3.9018161]...|
|   737|[[814, 3.8507497]...|
+------+--------------------+
only showing top 10 rows
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="top-k-for-a-selected-set-of-users-items">
<h4>3.5.2 Top k for a selected set of users (items)<a class="headerlink" href="#top-k-for-a-selected-set-of-users-items" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">users</span> <span class="o">=</span> <span class="n">dfs_train</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">als</span><span class="o">.</span><span class="n">getUserCol</span><span class="p">())</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">dfs_rec_subset</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">recommendForUserSubset</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dfs_rec_subset</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+------+--------------------+
|UserId|     recommendations|
+------+--------------------+
|   471|[[814, 3.7504895]...|
|   463|[[814, 3.1264873]...|
|   148|[[814, 4.03012], ...|
+------+--------------------+
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="run-time-considerations-for-top-k-recommendations">
<h4>3.5.3 Run-time considerations for top-k recommendations<a class="headerlink" href="#run-time-considerations-for-top-k-recommendations" title="Permalink to this headline">¶</a></h4>
<p>It is worth noting that usually computing the top-k recommendations for all users is the bottleneck of the whole pipeline (model training and scoring) of an ALS based recommendation system. This is because</p>
<ul class="simple">
<li><p>Getting the top k from all user-item pairs requires a cross join which is usually very computationally expensive.</p></li>
<li><p>Inner products of user-item pairs are calculated individually instead of leveraging matrix block multiplication features which are available in certain contemporary computing acceleration libraries (e.g., BLAS).</p></li>
</ul>
<p>More details about possible optimizations of the top k recommendations in Spark can be found <a class="reference external" href="https://engineeringblog.yelp.com/2018/05/scaling-collaborative-filtering-with-pyspark.html">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cleanup spark instance</span>
<span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p>Yehuda Koren, Robert Bell, and Chris Volinsky, “Matrix Factorization Techniques for Recommender Systems
“, ACM Computer, Vol. 42, Issue 8, pp 30-37, Aug., 2009.</p></li>
<li><p>Yifan Hu, Yehuda Koren, and Chris Volinsky, “Collaborative Filtering for Implicit Feedback Datasets
“, Proc. IEEE ICDM, 2008, Dec, Pisa, Italy.</p></li>
<li><p>Apache Spark. url: <a class="reference external" href="https://spark.apache.org/docs/latest/ml-collaborative-filtering.html">https://spark.apache.org/docs/latest/ml-collaborative-filtering.html</a></p></li>
<li><p>Seaborn. url: <a class="reference external" href="https://seaborn.pydata.org/">https://seaborn.pydata.org/</a></p></li>
<li><p>Scaling collaborative filtering with PySpark. url: <a class="reference external" href="https://engineeringblog.yelp.com/2018/05/scaling-collaborative-filtering-with-pyspark.html">https://engineeringblog.yelp.com/2018/05/scaling-collaborative-filtering-with-pyspark.html</a></p></li>
<li><p>Matrix Completion via Alternating Least Square (ALS). url: <a class="reference external" href="http://stanford.edu/%7Erezab/classes/cme323/S15/notes/lec14.pdf">http://stanford.edu/~rezab/classes/cme323/S15/notes/lec14.pdf</a></p></li>
</ol>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./examples/02_model_collaborative_filtering"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="../00_quick_start/ncf_movielens.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Neural Collaborative Filtering on MovieLens dataset.</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="baseline_deep_dive.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Estimating Baseline Performance</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>