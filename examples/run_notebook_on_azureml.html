
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submit an Existing Notebook to AzureML &#8212; &lt;h1 style=&#34;font-size:1.7em;text-align:center;color:#FF5733&#34;&gt;Recommenders&lt;/h1&gt;</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/tabs.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title"><h1 style="font-size:1.7em;text-align:center;color:#FF5733">Recommenders</h1></h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption" role="heading">
 <span class="caption-text">
  Quick Start
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="00_quick_start/als_movielens.html">
   Running ALS on MovieLens (PySpark)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="00_quick_start/ncf_movielens.html">
   Neural Collaborative Filtering on MovieLens dataset.
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Deep Dive
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="02_model_collaborative_filtering/als_deep_dive.html">
   Spark Collaborative Filtering (ALS) Deep Dive
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_model_collaborative_filtering/baseline_deep_dive.html">
   Estimating Baseline Performance
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  API Documentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../source/datasets.html">
   Dataset module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../source/evaluation.html">
   Evaluation module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../source/models.html">
   Recommender algorithms module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../source/tuning.html">
   Hyperparameter tuning module
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../source/utils.html">
   Common utilities module
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/examples/run_notebook_on_azureml.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/microsoft/recommenders"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/microsoft/recommenders/issues/new?title=Issue%20on%20page%20%2Fexamples/run_notebook_on_azureml.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/microsoft/recommenders/main?urlpath=tree/docs/examples/run_notebook_on_azureml.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Submit an Existing Notebook to AzureML
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#introduction-to-azure-machine-learning">
     Introduction to Azure Machine Learning
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#advantages-of-using-azureml">
       Advantages of using AzureML:
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#prerequisities">
       Prerequisities
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup-environment">
   Setup environment
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-azure-contrib-notebook-package">
     Install azure.contrib.notebook package
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#connect-to-an-azureml-workspace">
     Connect to an AzureML workspace
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-or-attach-azure-machine-learning-compute">
     Create or Attach Azure Machine Learning Compute
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#learn-more-about-azure-machine-learning-compute">
       Learn more about Azure Machine Learning Compute
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#jupyter-widget">
       Jupyter widget
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deprovision-compute-resource">
   Deprovision compute resource
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><i>Copyright (c) Microsoft Corporation. All rights reserved.</i></p>
<p><i>Licensed under the MIT License.</i></p>
<div class="tex2jax_ignore mathjax_ignore section" id="submit-an-existing-notebook-to-azureml">
<h1>Submit an Existing Notebook to AzureML<a class="headerlink" href="#submit-an-existing-notebook-to-azureml" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction-to-azure-machine-learning">
<h2>Introduction to Azure Machine Learning<a class="headerlink" href="#introduction-to-azure-machine-learning" title="Permalink to this headline">¶</a></h2>
<p>The <strong><a class="reference external" href="https://docs.microsoft.com/azure/machine-learning/service/overview-what-is-azure-ml">Azure Machine Learning service (AzureML)</a></strong> provides a cloud-based environment you can use to prep data, train, test, deploy, manage, and track machine learning models. By using Azure Machine Learning service, you can start training on your local machine and then scale out to the cloud. With many available compute targets, like <a class="reference external" href="https://docs.microsoft.com/en-us/azure/machine-learning/service/how-to-set-up-training-targets#amlcompute">Azure Machine Learning Compute</a> and <a class="reference external" href="https://docs.microsoft.com/en-us/azure/azure-databricks/what-is-azure-databricks">Azure Databricks</a>, and with <a class="reference external" href="https://docs.microsoft.com/en-us/azure/machine-learning/service/how-to-tune-hyperparameters">advanced hyperparameter tuning services</a>, you can build better models faster by using the power of the cloud.</p>
<p>Data scientists and AI developers use the main <a class="reference external" href="https://docs.microsoft.com/en-us/python/api/overview/azure/ml/intro?view=azure-ml-py">Azure Machine Learning Python SDK</a> to build and run machine learning workflows with the Azure Machine Learning service. You can interact with the service in any Python environment, including Jupyter Notebooks or your favorite Python IDE. The Azure Machine Learning SDK allows you the choice of using local or cloud compute resources, while managing and maintaining the complete data science workflow from the cloud.
<img alt="AzureML Workflow" src="https://docs.microsoft.com/en-us/azure/machine-learning/service/media/overview-what-is-azure-ml/aml.png" /></p>
<p>This noteboook provides a scaffold to directly submit an existing notebook to AzureML compute targets. Now a user doesn’t have to rewrite the training script, instead, just by replacing file name, now user can submit notebook directly.</p>
<div class="section" id="advantages-of-using-azureml">
<h3>Advantages of using AzureML:<a class="headerlink" href="#advantages-of-using-azureml" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Manage cloud resources for monitoring, logging, and organizing your machine learning experiments.</p></li>
<li><p>Train models either locally or by using cloud resources, including GPU-accelerated model training.</p></li>
<li><p>Easy to scale out when dataset grows - by just creating and pointing to new compute target</p></li>
</ul>
</div>
<div class="section" id="prerequisities">
<h3>Prerequisities<a class="headerlink" href="#prerequisities" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><strong>Azure Subscription</strong></p>
<ul>
<li><p>If you don’t have an Azure subscription, create a free account before you begin. Try the <a class="reference external" href="https://azure.microsoft.com/en-us/free/services/machine-learning/">free or paid version of Azure Machine Learning service today</a>.</p></li>
<li><p>You get credits to spend on Azure services, which will easily cover the cost of running this example notebook. After they’re used up, you can keep the account and use <a class="reference external" href="https://azure.microsoft.com/en-us/free/">free Azure services</a>. Your credit card is never charged unless you explicitly change your settings and ask to be charged. Or <a class="reference external" href="https://azure.microsoft.com/en-us/pricing/member-offers/credit-for-visual-studio-subscribers/">activate MSDN subscriber benefits</a>, which give you credits every month that you can use for paid Azure services.</p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="setup-environment">
<h1>Setup environment<a class="headerlink" href="#setup-environment" title="Permalink to this headline">¶</a></h1>
<div class="section" id="install-azure-contrib-notebook-package">
<h2>Install azure.contrib.notebook package<a class="headerlink" href="#install-azure-contrib-notebook-package" title="Permalink to this headline">¶</a></h2>
<p>We need notebook_run_config from azureml.contrib.notebook to run this notebook. Since azureml.contrib.notebook contains experimental components, it’s not included in generated .yaml file by default.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install &quot;azureml.contrib.notebook&gt;=1.0.21.1&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">azureml.core</span>
<span class="kn">from</span> <span class="nn">azureml.core</span> <span class="kn">import</span> <span class="n">Workspace</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">makedirs</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">azureml.core</span> <span class="kn">import</span> <span class="n">Experiment</span>
<span class="kn">from</span> <span class="nn">azureml.core.compute</span> <span class="kn">import</span> <span class="n">ComputeTarget</span><span class="p">,</span> <span class="n">AmlCompute</span>
<span class="kn">from</span> <span class="nn">azureml.widgets</span> <span class="kn">import</span> <span class="n">RunDetails</span>
<span class="kn">from</span> <span class="nn">azureml.core.runconfig</span> <span class="kn">import</span> <span class="n">RunConfiguration</span>
<span class="kn">from</span> <span class="nn">azureml.contrib.notebook</span> <span class="kn">import</span> <span class="n">NotebookRunConfig</span><span class="p">,</span> <span class="n">PapermillExecutionHandler</span>
<span class="kn">from</span> <span class="nn">azureml.core.runconfig</span> <span class="kn">import</span> <span class="n">DEFAULT_CPU_IMAGE</span>
<span class="kn">from</span> <span class="nn">azureml.core.conda_dependencies</span> <span class="kn">import</span> <span class="n">CondaDependencies</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;azureml.core version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">azureml</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">VERSION</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>azureml.core version: 1.0.23
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="connect-to-an-azureml-workspace">
<h2>Connect to an AzureML workspace<a class="headerlink" href="#connect-to-an-azureml-workspace" title="Permalink to this headline">¶</a></h2>
<p>An <a class="reference external" href="https://docs.microsoft.com/en-us/python/api/azureml-core/azureml.core.workspace.workspace?view=azure-ml-py">AzureML Workspace</a> is an Azure resource that organizes and coordinates the actions of many other Azure resources to assist in executing and sharing machine learning workflows. In particular, an Azure ML Workspace coordinates storage, databases, and compute resources providing added functionality for machine learning experimentation, deployment, inferencing, and the monitoring of deployed models.</p>
<p>The function below will get or create an AzureML Workspace and save the configuration to <code class="docutils literal notranslate"><span class="pre">aml_config/config.json</span></code>.</p>
<p>It defaults to use provided input parameters or environment variables for the Workspace configuration values. Otherwise, it will use an existing configuration file (either at <code class="docutils literal notranslate"><span class="pre">./aml_config/config.json</span></code> or a path specified by the config_path parameter).</p>
<p>Lastly, if the workspace does not exist, one will be created for you. See <a class="reference external" href="https://docs.microsoft.com/en-us/azure/machine-learning/service/setup-create-workspace#portal">this tutorial</a> to locate information such as subscription id.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ws</span> <span class="o">=</span> <span class="n">Workspace</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&lt;WORKSPACE_NAME&gt;&quot;</span><span class="p">,</span>
    <span class="n">subscription_id</span><span class="o">=</span><span class="s2">&quot;&lt;SUBSCRIPTION_ID&gt;&quot;</span><span class="p">,</span>
    <span class="n">resource_group</span><span class="o">=</span><span class="s2">&quot;&lt;RESOURCE_GROUP&gt;&quot;</span><span class="p">,</span>
    <span class="n">location</span><span class="o">=</span><span class="s2">&quot;&lt;WORKSPACE_REGION&gt;&quot;</span>
    <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This example uses run-based AzureML Compute, which requires minimum setup. Alternatively, you can use persistent compute target (cpu or gpu cluster) or remote virtual machines. For more details, see <a class="reference external" href="https://docs.microsoft.com/en-us/azure/machine-learning/service/how-to-set-up-training-targets">How to set up training targets</a>.</p>
<p>Cost-wise, according to Azure <a class="reference external" href="https://azure.microsoft.com/en-us/pricing/calculator/">Pricing calculator</a>, with example VM size <code class="docutils literal notranslate"><span class="pre">STANDARD_D2_V2</span></code>, it costs a few dollars to run this notebook, which is well covered by Azure new subscription credit. For billing and pricing questions, please contact <a class="reference external" href="https://azure.microsoft.com/en-us/support/options/">Azure support</a>.</p>
<p><strong>Note</strong>:</p>
<ul class="simple">
<li><p>See list of all available VM sizes <a class="reference external" href="https://docs.microsoft.com/en-us/azure/templates/Microsoft.Compute/2018-10-01/virtualMachines?toc=%2Fen-us%2Fazure%2Fazure-resource-manager%2Ftoc.json&amp;bc=%2Fen-us%2Fazure%2Fbread%2Ftoc.json#hardwareprofile-object">here</a>.</p></li>
<li><p>As with other Azure services, there are limits on certain resources (for eg. AmlCompute quota) associated with the Azure Machine Learning service. Please read <a class="reference external" href="https://docs.microsoft.com/en-us/azure/azure-supportability/resource-manager-core-quotas-request">these instructions</a> on the default limits and how to request more quota.</p></li>
</ul>
</div>
<div class="section" id="create-or-attach-azure-machine-learning-compute">
<h2>Create or Attach Azure Machine Learning Compute<a class="headerlink" href="#create-or-attach-azure-machine-learning-compute" title="Permalink to this headline">¶</a></h2>
<p>We create a cpu cluster as our <strong>remote compute target</strong>. If a cluster with the same name already exists in your workspace, the script will load it instead. You can read <a class="reference external" href="https://docs.microsoft.com/en-us/azure/machine-learning/service/how-to-set-up-training-targets">Set up compute targets for model training</a> to learn more about setting up compute target on different locations. You can also create GPU machines when larger machines are necessary to train the model.</p>
<p>According to Azure <a class="reference external" href="https://azure.microsoft.com/en-us/pricing/calculator/">Pricing calculator</a>, with example VM size <code class="docutils literal notranslate"><span class="pre">STANDARD_D2_V2</span></code>, it costs a few dollars to run this notebook, which is well covered by Azure new subscription credit. For billing and pricing questions, please contact <a class="reference external" href="https://azure.microsoft.com/en-us/support/options/">Azure support</a>.</p>
<p><strong>Note</strong>:</p>
<ul class="simple">
<li><p>10m and 20m dataset requires more capacity than <code class="docutils literal notranslate"><span class="pre">STANDARD_D2_V2</span></code>, such as <code class="docutils literal notranslate"><span class="pre">STANDARD_NC6</span></code> or <code class="docutils literal notranslate"><span class="pre">STANDARD_NC12</span></code>. See list of all available VM sizes <a class="reference external" href="https://docs.microsoft.com/en-us/azure/templates/Microsoft.Compute/2018-10-01/virtualMachines?toc=%2Fen-us%2Fazure%2Fazure-resource-manager%2Ftoc.json&amp;bc=%2Fen-us%2Fazure%2Fbread%2Ftoc.json#hardwareprofile-object">here</a>.</p></li>
<li><p>As with other Azure services, there are limits on certain resources (for eg. AmlCompute quota) associated with the Azure Machine Learning service. Please read <a class="reference external" href="https://docs.microsoft.com/en-us/azure/azure-supportability/resource-manager-core-quotas-request">these instructions</a> on the default limits and how to request more quota.</p></li>
</ul>
<hr class="docutils" />
<div class="section" id="learn-more-about-azure-machine-learning-compute">
<h3>Learn more about Azure Machine Learning Compute<a class="headerlink" href="#learn-more-about-azure-machine-learning-compute" title="Permalink to this headline">¶</a></h3>
<details>
    <summary>Click to learn more about compute types</summary>
<p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/machine-learning/service/how-to-set-up-training-targets#amlcompute">Azure Machine Learning Compute</a> is managed compute infrastructure that allows the user to easily create single to multi-node compute of the appropriate VM Family. It is created within your workspace region and is a resource that can be used by other users in your workspace. It autoscales by default to the max_nodes, when a job is submitted, and executes in a containerized environment packaging the dependencies as specified by the user.</p>
<p>Since it is managed compute, job scheduling and cluster management are handled internally by Azure Machine Learning service.</p>
<p>You can provision a persistent AmlCompute resource by simply defining two parameters thanks to smart defaults. By default it autoscales from 0 nodes and provisions dedicated VMs to run your job in a container. This is useful when you want to continously re-use the same target, debug it between jobs or simply share the resource with other users of your workspace.</p>
<p>In addition to vm_size and max_nodes, you can specify:</p>
<ul class="simple">
<li><p><strong>min_nodes</strong>: Minimum nodes (default 0 nodes) to downscale to while running a job on AmlCompute</p></li>
<li><p><strong>vm_priority</strong>: Choose between ‘dedicated’ (default) and ‘lowpriority’ VMs when provisioning AmlCompute. Low Priority VMs use Azure’s excess capacity and are thus cheaper but risk your run being pre-empted</p></li>
<li><p><strong>idle_seconds_before_scaledown</strong>: Idle time (default 120 seconds) to wait after run completion before auto-scaling to min_nodes</p></li>
<li><p><strong>vnet_resourcegroup_name</strong>: Resource group of the existing VNet within which AmlCompute should be provisioned</p></li>
<li><p><strong>vnet_name</strong>: Name of VNet</p></li>
<li><p><strong>subnet_name</strong>: Name of SubNet within the VNet</p></li>
</ul>
</details>
---<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remote compute (cluster) configuration. If you want to save the cost more, set these to small.</span>
<span class="n">VM_SIZE</span> <span class="o">=</span> <span class="s1">&#39;STANDARD_D2_V2&#39;</span>
<span class="c1"># Cluster nodes</span>
<span class="n">MIN_NODES</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">MAX_NODES</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">CLUSTER_NAME</span> <span class="o">=</span> <span class="s1">&#39;cpucluster&#39;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">compute_target</span> <span class="o">=</span> <span class="n">ComputeTarget</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">CLUSTER_NAME</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found existing compute target&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating a new compute target...&quot;</span><span class="p">)</span>
    <span class="c1"># Specify the configuration for the new cluster</span>
    <span class="n">compute_config</span> <span class="o">=</span> <span class="n">AmlCompute</span><span class="o">.</span><span class="n">provisioning_configuration</span><span class="p">(</span>
        <span class="n">vm_size</span><span class="o">=</span><span class="n">VM_SIZE</span><span class="p">,</span>
        <span class="n">min_nodes</span><span class="o">=</span><span class="n">MIN_NODES</span><span class="p">,</span>
        <span class="n">max_nodes</span><span class="o">=</span><span class="n">MAX_NODES</span>
    <span class="p">)</span>
    <span class="c1"># Create the cluster with the specified name and configuration</span>
    <span class="n">compute_target</span> <span class="o">=</span> <span class="n">ComputeTarget</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">CLUSTER_NAME</span><span class="p">,</span> <span class="n">compute_config</span><span class="p">)</span>
    <span class="c1"># Wait for the cluster to complete, show the output log</span>
    <span class="n">compute_target</span><span class="o">.</span><span class="n">wait_for_completion</span><span class="p">(</span><span class="n">show_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_node_count</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout_in_minutes</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found existing compute target
</pre></div>
</div>
</div>
</div>
<p>This example uses persistent compute target, which requires creation of the computing resource for first time. Alternatively, you can use run-based compute target or remote virtual machines.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NOTEBOOK_NAME</span> <span class="o">=</span> <span class="s1">&#39;sar_movielens.ipynb&#39;</span> <span class="c1"># use different notebook file name if trying to run other notebooks</span>
<span class="n">experiment_name</span> <span class="o">=</span> <span class="n">NOTEBOOK_NAME</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.ipynb&quot;</span><span class="p">)</span>
<span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">()</span>
<span class="n">notebook_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">NOTEBOOK_NAME</span><span class="p">)</span>
<span class="n">source_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;00_quick_start/&#39;</span><span class="p">,</span> <span class="n">NOTEBOOK_NAME</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">notebook_path</span><span class="p">)</span>
        
<span class="n">exp</span> <span class="o">=</span> <span class="n">Experiment</span><span class="p">(</span><span class="n">workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">experiment_name</span><span class="p">)</span>

<span class="n">run_config</span> <span class="o">=</span> <span class="n">RunConfiguration</span><span class="p">()</span>
<span class="n">run_config</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;cpucluster&quot;</span> <span class="c1"># possible to use alternative compute targets</span>
<span class="n">run_config</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">run_config</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">base_image</span> <span class="o">=</span> <span class="n">DEFAULT_CPU_IMAGE</span>
<span class="n">run_config</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">user_managed_dependencies</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">run_config</span><span class="o">.</span><span class="n">auto_prepare_environment</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">run_config</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">conda_dependencies</span> <span class="o">=</span> <span class="n">CondaDependencies</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">python_version</span><span class="o">=</span><span class="s1">&#39;3.6.2&#39;</span><span class="p">)</span>
<span class="n">run_config</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">python</span><span class="o">.</span><span class="n">conda_dependencies</span><span class="o">.</span><span class="n">add_pip_package</span><span class="p">(</span><span class="s1">&#39;sklearn&#39;</span><span class="p">)</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="n">NotebookRunConfig</span><span class="p">(</span><span class="n">source_directory</span><span class="o">=</span><span class="s1">&#39;../&#39;</span><span class="p">,</span>
                            <span class="n">notebook</span><span class="o">=</span><span class="s1">&#39;notebooks/00_quick_start/&#39;</span> <span class="o">+</span> <span class="n">NOTEBOOK_NAME</span><span class="p">,</span>
                            <span class="n">output_notebook</span><span class="o">=</span><span class="s1">&#39;outputs/out.ipynb&#39;</span><span class="p">,</span>
                            <span class="n">parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;MOVIELENS_DATA_SIZE&quot;</span><span class="p">:</span> <span class="s2">&quot;100k&quot;</span><span class="p">,</span> <span class="s2">&quot;TOP_K&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
                            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">exp.submit()</span></code> will submit source_directory folder and designate notebook to run</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">run</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="n">run</span>
</pre></div>
</div>
</div>
</div>
<p>Above cell should output similar table as below
<img alt="Experiment submit output" src="https://recodatasets.z20.web.core.windows.net/images/aml_papermill_cell_output.jpg" />
After clicking “Link to Azure Portal”, experiment run details tab looks like this
<img alt="Azure Portal Experiment" src="https://recodatasets.z20.web.core.windows.net/images/aml_papermill_portal.jpg" />
You can find the executed notebook out.ipynb under outputs tab.
<img alt="Output file" src="https://recodatasets.z20.web.core.windows.net/images/aml_papermill_outputs_tab.jpg" /></p>
</div>
<div class="section" id="jupyter-widget">
<h3>Jupyter widget<a class="headerlink" href="#jupyter-widget" title="Permalink to this headline">¶</a></h3>
<p>You can use a Jupyter widget to monitor the progress of the run. Like the run submission, the widget is asynchronous and provides live updates every 10-15 seconds until the job completes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RunDetails</span><span class="p">(</span><span class="n">run</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4cdf15aac31d48879cc6fb0021ed51ce", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<p>You can view logged metrics with run.get_metrics()</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run below after run is complete, otherwise metrics is empty</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">get_metrics</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;MOVIELENS_DATA_SIZE&#39;: &#39;100k&#39;, &#39;TOP_K&#39;: 10, &#39;map&#39;: 0.10485162234730652, &#39;ndcg&#39;: 0.3704872048540983, &#39;precision&#39;: 0.3211252653927813, &#39;recall&#39;: 0.17416985459670545, &#39;test_time&#39;: 0.15025854110717773, &#39;train_time&#39;: 0.29204869270324707}
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="deprovision-compute-resource">
<h1>Deprovision compute resource<a class="headerlink" href="#deprovision-compute-resource" title="Permalink to this headline">¶</a></h1>
<p>To avoid unnecessary charges, if you created compute target that doesn’t scale down to 0, make sure the compute target is deprovisioned after use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># delete () is used to deprovision and delete the AmlCompute target. </span>
<span class="c1"># do not run below before experiment completes</span>

<span class="c1"># compute_target.delete()</span>

<span class="c1"># deletion will take a few minutes. You can check progress in Azure Portal / Computing tab</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># clean up temporary directory</span>
<span class="n">tmp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3-azureml",
            path: "./examples"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3-azureml'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>