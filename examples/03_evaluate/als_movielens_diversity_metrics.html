
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Apply Diversity Metrics &#8212; &lt;h1 style=&#34;font-size:2em;text-align:center;color:#FF5733&#34;&gt;Recommenders&lt;/h1&gt;</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title"><h1 style="font-size:2em;text-align:center;color:#FF5733">Recommenders</h1></h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption" role="heading">
 <span class="caption-text">
  Getting Started Notebooks
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../00_quick_start/als_movielens.html">
   Running ALS on MovieLens (PySpark)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../00_quick_start/ncf_movielens.html">
   Neural Collaborative Filtering on MovieLens dataset.
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/examples/03_evaluate/als_movielens_diversity_metrics.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/microsoft/genalog"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/microsoft/genalog/issues/new?title=Issue%20on%20page%20%2Fexamples/03_evaluate/als_movielens_diversity_metrics.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/microsoft/genalog/main?urlpath=tree/docs/genalog_docs/examples/03_evaluate/als_movielens_diversity_metrics.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compare-als-and-random-recommenders-on-movielens-pyspark">
   – Compare ALS and Random Recommenders on MovieLens (PySpark)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-up-spark-context">
     1. Set up Spark context
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#download-the-movielens-dataset">
     2. Download the MovieLens dataset
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#split-the-data-using-the-spark-random-splitter-provided-in-utilities">
       Split the data using the Spark random splitter provided in utilities
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#get-all-possible-user-item-pairs">
       Get all possible user-item pairs
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-the-als-model-on-the-training-data-and-get-the-top-k-recommendations-for-our-testing-data">
     3. Train the ALS model on the training data, and get the top-k recommendations for our testing data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#random-recommender">
     4. Random Recommender
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#als-vs-random-recommenders-performance-comparison">
     5. ALS vs Random Recommenders Performance Comparison
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#als-recommender-performance-results">
       ALS Recommender Performance Results
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#random-recommender-performance-results">
       Random Recommender Performance Results
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#result-comparison">
       Result Comparison
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#conclusion">
       Conclusion
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-diversity-metrics-using-item-feature-vector-based-item-item-similarity">
     6.  Calculate diversity metrics using item feature vector based item-item similarity
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#references">
     References
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><i>Copyright (c) Microsoft Corporation. All rights reserved.</i></p>
<p><i>Licensed under the MIT License.</i></p>
<div class="tex2jax_ignore mathjax_ignore section" id="apply-diversity-metrics">
<h1>Apply Diversity Metrics<a class="headerlink" href="#apply-diversity-metrics" title="Permalink to this headline">¶</a></h1>
<div class="section" id="compare-als-and-random-recommenders-on-movielens-pyspark">
<h2>– Compare ALS and Random Recommenders on MovieLens (PySpark)<a class="headerlink" href="#compare-als-and-random-recommenders-on-movielens-pyspark" title="Permalink to this headline">¶</a></h2>
<p>In this notebook, we demonstrate how to evaluate a recommender using metrics other than commonly used rating/ranking metrics.</p>
<p>Such metrics include:</p>
<ul class="simple">
<li><p>Coverage - We use following two metrics defined by [Shani and Gunawardana]:</p>
<ul>
<li><p>(1) catalog_coverage, which measures the proportion of items that get recommended from the item catalog;</p></li>
<li><p>(2) distributional_coverage, which measures how equally different items are recommended in the recommendations to all users.</p></li>
</ul>
</li>
<li><p>Novelty - A more novel item indicates it is less popular, i.e. it gets recommended less frequently.
We use the definition of novelty from [Castells et al.]</p></li>
<li><p>Diversity - The dissimilarity of items being recommended.
We use a definition based on <em>intralist similarity</em> by [Zhang et al.]</p></li>
<li><p>Serendipity - The “unusualness” or “surprise” of recommendations to a user.
We use a definition based on cosine similarity by [Zhang et al.]</p></li>
</ul>
<p>We evaluate the results obtained with two approaches: using the ALS recommender algorithm vs. a baseline of random recommendations.</p>
<ul class="simple">
<li><p>Matrix factorization by <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/_modules/pyspark/ml/recommendation.html#ALS">ALS</a> (Alternating Least Squares) is a well known collaborative filtering algorithm.</p></li>
<li><p>We also define a process which randomly recommends unseen items to each user.</p></li>
<li><p>We show two options to calculate item-item similarity: (1) based on item co-occurrence count; and (2) based on item feature vectors.</p></li>
</ul>
<p>The comparision results show that the ALS recommender outperforms the random recommender on ranking metrics (Precision&#64;k, Recall&#64;k, NDCG&#64;k, and	Mean average precision), while the random recommender outperforms ALS recommender on diversity metrics. This is because ALS is optimized for estimating the item rating as accurate as possible, therefore it performs well on accuracy metrics including rating and ranking metrics. As a side effect, the items being recommended tend to be popular items, which are the items mostly sold or viewed. It leaves the <a class="reference external" href="https://github.com/microsoft/recommenders/blob/main/GLOSSARY.md">long-tail items</a> having less chance to get introduced to the users. This is the reason why ALS is not performing as well as a random recommender on diversity metrics.</p>
<p>From the algorithmic point of view, items in the tail suffer from the cold-start problem, making them hard for recommendation systems to use. However, from the business point of view, oftentimes the items in the tail can be highly profitable, since, depending on supply, business can apply a higher margin to them. Recommendation systems that optimize metrics like novelty and diversity, can help to find users willing to get these long tail items. Usually there is a trade-off between one type of metric vs. another. One should decide which set of metrics to optimize based on business scenarios.</p>
<p><strong>Coverage</strong></p>
<p>We define <em>catalog coverage</em> as the proportion of items showing in all users’ recommendations:
$<span class="math notranslate nohighlight">\(
\textrm{CatalogCoverage} = \frac{|N_r|}{|N_t|}
\)</span><span class="math notranslate nohighlight">\(
where \)</span>N_r<span class="math notranslate nohighlight">\( denotes the set of items in the recommendations (`reco_df` in the code below) and \)</span>N_t$ the set of items in the historical data (<code class="docutils literal notranslate"><span class="pre">train_df</span></code>).</p>
<p><em>Distributional coverage</em> measures how equally different items are recommended to users when a particular recommender system is used.
If  <span class="math notranslate nohighlight">\(p(i|R)\)</span> denotes the probability that item <span class="math notranslate nohighlight">\(i\)</span> is observed among all recommendation lists, we define distributional coverage as
$<span class="math notranslate nohighlight">\(
\textrm{DistributionalCoverage} = -\sum_{i \in N_t} p(i|R) \log_2 p(i)
\)</span><span class="math notranslate nohighlight">\(
where 
\)</span><span class="math notranslate nohighlight">\(
p(i|R) = \frac{|M_r (i)|}{|\textrm{reco_df}|}
\)</span><span class="math notranslate nohighlight">\(
and \)</span>M_r (i)<span class="math notranslate nohighlight">\( denotes the users who are recommended item \)</span>i$.</p>
<p><strong>Diversity</strong></p>
<p>Diversity represents the variety present in a list of recommendations.
<em>Intra-List Similarity</em> aggregates the pairwise similarity of all items in a set. A recommendation list with groups of very similar items will score a high intra-list similarity. Lower intra-list similarity indicates higher diversity.
To measure similarity between any two items we use <em>cosine similarity</em>:
$<span class="math notranslate nohighlight">\(
\textrm{Cosine Similarity}(i,j)=  \frac{|M_t^{l(i,j)}|} {\sqrt{|M_t^{l(i)}|} \sqrt{|M_t^{l(j)}|} }
\)</span><span class="math notranslate nohighlight">\(
where \)</span>M_t^{l(i)}<span class="math notranslate nohighlight">\( denotes the set of users who liked item \)</span>i<span class="math notranslate nohighlight">\( and \)</span>M_t^{l(i,j)}<span class="math notranslate nohighlight">\( the users who liked both \)</span>i<span class="math notranslate nohighlight">\( and \)</span>j<span class="math notranslate nohighlight">\(.
Intra-list similarity is then defined as 
\)</span><span class="math notranslate nohighlight">\(
\textrm{IL} = \frac{1}{|M|} \sum_{u \in M} \frac{1}{\binom{N_r(u)}{2}} \sum_{i,j \in N_r (u),\, i&lt;j} \textrm{Cosine Similarity}(i,j)
\)</span><span class="math notranslate nohighlight">\(
where \)</span>M<span class="math notranslate nohighlight">\( is the set of users and \)</span>N_r(u)<span class="math notranslate nohighlight">\( the set of recommendations for user \)</span>u<span class="math notranslate nohighlight">\(. Finally, diversity is defined as
\)</span><span class="math notranslate nohighlight">\(
\textrm{diversity} = 1 - \textrm{IL}
\)</span>$</p>
<p><strong>Novelty</strong></p>
<p>The novelty of an item is inverse to its <em>popularity</em>. If <span class="math notranslate nohighlight">\(p(i)\)</span> represents the probability that item <span class="math notranslate nohighlight">\(i\)</span> is observed (or known, interacted with etc.) by users, then<br />
$<span class="math notranslate nohighlight">\(
p(i) = \frac{|M_t (i)|} {|\textrm{train_df}|}
\)</span><span class="math notranslate nohighlight">\(
where \)</span>M_t (i)<span class="math notranslate nohighlight">\( is the set of users who have interacted with item \)</span>i$ in the historical data.</p>
<p>The novelty of an item is then defined as
$<span class="math notranslate nohighlight">\(
\textrm{novelty}(i) = -\log_2 p(i)
\)</span><span class="math notranslate nohighlight">\(
and the novelty of the recommendations across all users is defined as
\)</span><span class="math notranslate nohighlight">\(
\textrm{novelty} = \sum_{i \in N_r} \frac{|M_r (i)|}{|\textrm{reco_df}|} \textrm{novelty}(i)
\)</span>$</p>
<p><strong>Serendipity</strong></p>
<p>Serendipity represents the “unusualness” or “surprise” of recommendations. Unlike novelty, serendipity encompasses the semantic content of items and can be imagined as the distance between recommended items and their expected contents (Zhang et al.) Lower cosine similarity indicates lower expectedness and higher serendipity.
We define the expectedness of an unseen item <span class="math notranslate nohighlight">\(i\)</span> for user <span class="math notranslate nohighlight">\(u\)</span> as the average similarity between every already seen item <span class="math notranslate nohighlight">\(j\)</span> in the historical data and <span class="math notranslate nohighlight">\(i\)</span>:
$<span class="math notranslate nohighlight">\(
\textrm{expectedness}(i|u) = \frac{1}{|N_t (u)|} \sum_{j \in N_t (u)} \textrm{Cosine Similarity}(i,j)
\)</span><span class="math notranslate nohighlight">\(
The serendipity of item \)</span>i<span class="math notranslate nohighlight">\( is (1 - expectedness) multiplied by _relevance_, where relevance indicates whether the item turns out to be liked by the user or not. For example, in a binary scenario, if an item in `reco_df` is liked (purchased, clicked) in `test_df`, its relevance equals one, otherwise it equals zero. Aggregating over all users and items, the overall 
serendipity is defined as
\)</span><span class="math notranslate nohighlight">\(
\textrm{serendipity} = \frac{1}{|M|} \sum_{u \in M_r}
\frac{1}{|N_r (u)|} \sum_{i \in N_r (u)} \big(1 - \textrm{expectedness}(i|u) \big) \, \textrm{relevance}(i)
\)</span>$</p>
<p><strong>Note</strong>: This notebook requires a PySpark environment to run properly. Please follow the steps in <a class="reference external" href="https://github.com/Microsoft/Recommenders/blob/master/SETUP.md#dependencies-setup">SETUP.md</a> to install the PySpark environment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the environment path to find Recommenders</span>
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">pyspark</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.recommendation</span> <span class="kn">import</span> <span class="n">ALS</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">FloatType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">LongType</span><span class="p">,</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">Tokenizer</span><span class="p">,</span> <span class="n">StopWordsRemover</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">HashingTF</span><span class="p">,</span> <span class="n">CountVectorizer</span><span class="p">,</span> <span class="n">VectorAssembler</span>

<span class="kn">from</span> <span class="nn">recommenders.utils.timer</span> <span class="kn">import</span> <span class="n">Timer</span>
<span class="kn">from</span> <span class="nn">recommenders.datasets</span> <span class="kn">import</span> <span class="n">movielens</span>
<span class="kn">from</span> <span class="nn">recommenders.datasets.spark_splitters</span> <span class="kn">import</span> <span class="n">spark_random_split</span>
<span class="kn">from</span> <span class="nn">recommenders.evaluation.spark_evaluation</span> <span class="kn">import</span> <span class="n">SparkRankingEvaluation</span><span class="p">,</span> <span class="n">SparkDiversityEvaluation</span>
<span class="kn">from</span> <span class="nn">recommenders.utils.spark_utils</span> <span class="kn">import</span> <span class="n">start_or_get_spark</span>

<span class="kn">from</span> <span class="nn">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;System version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spark version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pyspark</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>System version: 3.6.9 (default, Jan 26 2021, 15:33:00) 
[GCC 8.4.0]
Spark version: 2.4.8
</pre></div>
</div>
</div>
</div>
<p>Set the default parameters.</p>
<div class="cell tag_parameters docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># top k items to recommend</span>
<span class="n">TOP_K</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># Select MovieLens data size: 100k, 1m, 10m, or 20m</span>
<span class="n">MOVIELENS_DATA_SIZE</span> <span class="o">=</span> <span class="s1">&#39;100k&#39;</span>

<span class="c1"># user, item column names</span>
<span class="n">COL_USER</span><span class="o">=</span><span class="s2">&quot;UserId&quot;</span>
<span class="n">COL_ITEM</span><span class="o">=</span><span class="s2">&quot;MovieId&quot;</span>
<span class="n">COL_RATING</span><span class="o">=</span><span class="s2">&quot;Rating&quot;</span>
<span class="n">COL_TITLE</span><span class="o">=</span><span class="s2">&quot;Title&quot;</span>
<span class="n">COL_GENRE</span><span class="o">=</span><span class="s2">&quot;Genre&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="set-up-spark-context">
<h3>1. Set up Spark context<a class="headerlink" href="#set-up-spark-context" title="Permalink to this headline">¶</a></h3>
<p>The following settings work well for debugging locally on VM - change when running on a cluster. We set up a giant single executor with many threads and specify memory cap.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># the following settings work well for debugging locally on VM - change when running on a cluster</span>
<span class="c1"># set up a giant single executor with many threads and specify memory cap</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">start_or_get_spark</span><span class="p">(</span><span class="s2">&quot;ALS PySpark&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="s2">&quot;16g&quot;</span><span class="p">)</span>

<span class="n">spark</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;spark.sql.crossJoin.enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="download-the-movielens-dataset">
<h3>2. Download the MovieLens dataset<a class="headerlink" href="#download-the-movielens-dataset" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note: The DataFrame-based API for ALS currently only supports integers for user and item ids.</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">StructField</span><span class="p">(</span><span class="n">COL_USER</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
        <span class="n">StructField</span><span class="p">(</span><span class="n">COL_ITEM</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">()),</span>
        <span class="n">StructField</span><span class="p">(</span><span class="n">COL_RATING</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">()),</span>
        <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">,</span> <span class="n">LongType</span><span class="p">()),</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">movielens</span><span class="o">.</span><span class="n">load_spark_df</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">MOVIELENS_DATA_SIZE</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">title_col</span><span class="o">=</span><span class="n">COL_TITLE</span><span class="p">,</span> <span class="n">genres_col</span><span class="o">=</span><span class="n">COL_GENRE</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|██████████| 4.81k/4.81k [00:00&lt;00:00, 20.1kKB/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+-------+------+------+---------+--------------------+------+
|MovieId|UserId|Rating|Timestamp|               Title| Genre|
+-------+------+------+---------+--------------------+------+
|     26|   138|   5.0|879024232|Brothers McMullen...|Comedy|
|     26|   224|   3.0|888104153|Brothers McMullen...|Comedy|
|     26|    18|   4.0|880129731|Brothers McMullen...|Comedy|
|     26|   222|   3.0|878183043|Brothers McMullen...|Comedy|
|     26|    43|   5.0|883954901|Brothers McMullen...|Comedy|
|     26|   201|   4.0|884111927|Brothers McMullen...|Comedy|
|     26|   299|   4.0|878192601|Brothers McMullen...|Comedy|
|     26|    95|   3.0|880571951|Brothers McMullen...|Comedy|
|     26|    89|   3.0|879459909|Brothers McMullen...|Comedy|
|     26|   361|   3.0|879440941|Brothers McMullen...|Comedy|
|     26|   194|   3.0|879522240|Brothers McMullen...|Comedy|
|     26|   391|   5.0|877399745|Brothers McMullen...|Comedy|
|     26|   345|   3.0|884993555|Brothers McMullen...|Comedy|
|     26|   303|   4.0|879468307|Brothers McMullen...|Comedy|
|     26|   401|   3.0|891033395|Brothers McMullen...|Comedy|
|     26|   429|   3.0|882386333|Brothers McMullen...|Comedy|
|     26|   293|   3.0|888907015|Brothers McMullen...|Comedy|
|     26|   270|   5.0|876954995|Brothers McMullen...|Comedy|
|     26|   442|   3.0|883388576|Brothers McMullen...|Comedy|
|     26|   342|   2.0|875320037|Brothers McMullen...|Comedy|
+-------+------+------+---------+--------------------+------+
only showing top 20 rows
</pre></div>
</div>
</div>
</div>
<div class="section" id="split-the-data-using-the-spark-random-splitter-provided-in-utilities">
<h4>Split the data using the Spark random splitter provided in utilities<a class="headerlink" href="#split-the-data-using-the-spark-random-splitter-provided-in-utilities" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">spark_random_split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">COL_USER</span><span class="p">,</span> <span class="n">COL_ITEM</span><span class="p">,</span> <span class="n">COL_RATING</span><span class="p">),</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;N train_df&quot;</span><span class="p">,</span> <span class="n">train_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;N test_df&quot;</span><span class="p">,</span> <span class="n">test_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>N train_df 75066
N test_df 24934
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="get-all-possible-user-item-pairs">
<h4>Get all possible user-item pairs<a class="headerlink" href="#get-all-possible-user-item-pairs" title="Permalink to this headline">¶</a></h4>
<p>Note: We assume that training data contains all users and all catalog items.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">users</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">COL_USER</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
<span class="n">items</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">COL_ITEM</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
<span class="n">user_item</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">crossJoin</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="train-the-als-model-on-the-training-data-and-get-the-top-k-recommendations-for-our-testing-data">
<h3>3. Train the ALS model on the training data, and get the top-k recommendations for our testing data<a class="headerlink" href="#train-the-als-model-on-the-training-data-and-get-the-top-k-recommendations-for-our-testing-data" title="Permalink to this headline">¶</a></h3>
<p>To predict movie ratings, we use the rating data in the training set as users’ explicit feedback. The hyperparameters used in building the model are referenced from <a class="reference external" href="http://mymedialite.net/examples/datasets.html">here</a>. We do not constrain the latent factors (<code class="docutils literal notranslate"><span class="pre">nonnegative</span> <span class="pre">=</span> <span class="pre">False</span></code>) in order to allow for both positive and negative preferences towards movies.
Timing will vary depending on the machine being used to train.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;userCol&quot;</span><span class="p">:</span> <span class="n">COL_USER</span><span class="p">,</span>
    <span class="s2">&quot;itemCol&quot;</span><span class="p">:</span> <span class="n">COL_ITEM</span><span class="p">,</span>
    <span class="s2">&quot;ratingCol&quot;</span><span class="p">:</span> <span class="n">COL_RATING</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span>
    <span class="n">rank</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">maxIter</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">implicitPrefs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">regParam</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">coldStartStrategy</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">,</span>
    <span class="n">nonnegative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="o">**</span><span class="n">header</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Timer</span><span class="p">()</span> <span class="k">as</span> <span class="n">train_time</span><span class="p">:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_df</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Took </span><span class="si">{}</span><span class="s2"> seconds for training.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_time</span><span class="o">.</span><span class="n">interval</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Took 4.189040212018881 seconds for training.
</pre></div>
</div>
</div>
</div>
<p>In the movie recommendation use case, recommending movies that have been rated by the users does not make sense. Therefore, the rated movies are removed from the recommended items.</p>
<p>In order to achieve this, we recommend all movies to all users, and then remove the user-movie pairs that exist in the training dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Score all user-item pairs</span>
<span class="n">dfs_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">user_item</span><span class="p">)</span>

<span class="c1"># Remove seen items.</span>
<span class="n">dfs_pred_exclude_train</span> <span class="o">=</span> <span class="n">dfs_pred</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pred&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">train_df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">dfs_pred</span><span class="p">[</span><span class="n">COL_USER</span><span class="p">]</span> <span class="o">==</span> <span class="n">train_df</span><span class="p">[</span><span class="n">COL_USER</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfs_pred</span><span class="p">[</span><span class="n">COL_ITEM</span><span class="p">]</span> <span class="o">==</span> <span class="n">train_df</span><span class="p">[</span><span class="n">COL_ITEM</span><span class="p">]),</span>
    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span>
<span class="p">)</span>

<span class="n">top_all</span> <span class="o">=</span> <span class="n">dfs_pred_exclude_train</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">dfs_pred_exclude_train</span><span class="p">[</span><span class="s2">&quot;train.Rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span> \
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;pred.&#39;</span> <span class="o">+</span> <span class="n">COL_USER</span><span class="p">,</span> <span class="s1">&#39;pred.&#39;</span> <span class="o">+</span> <span class="n">COL_ITEM</span><span class="p">,</span> <span class="s1">&#39;pred.&#39;</span> <span class="o">+</span> <span class="s2">&quot;prediction&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">top_all</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    
<span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="n">COL_USER</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>    
<span class="n">top_k_reco</span> <span class="o">=</span> <span class="n">top_all</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">TOP_K</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">)</span>
 
<span class="nb">print</span><span class="p">(</span><span class="n">top_k_reco</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1464853
9430
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="random-recommender">
<h3>4. Random Recommender<a class="headerlink" href="#random-recommender" title="Permalink to this headline">¶</a></h3>
<p>We define a recommender which randomly recommends unseen items to each user.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># random recommender</span>
<span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="n">COL_USER</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span>

<span class="c1"># randomly generated recommendations for each user</span>
<span class="n">pred_df</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">train_df</span>
  <span class="c1"># join training data with all possible user-item pairs (seen in training)</span>
  <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_item</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="n">COL_USER</span><span class="p">,</span> <span class="n">COL_ITEM</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span>
  <span class="p">)</span>
  <span class="c1"># get user-item pairs that were not seen in the training data</span>
  <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">COL_RATING</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>
  <span class="c1"># count items for each user (randomly sorting them)</span>
  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">window</span><span class="p">))</span>
  <span class="c1"># get the top k items per user</span>
  <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">TOP_K</span><span class="p">)</span>
  <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">COL_RATING</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="als-vs-random-recommenders-performance-comparison">
<h3>5. ALS vs Random Recommenders Performance Comparison<a class="headerlink" href="#als-vs-random-recommenders-performance-comparison" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_ranking_results</span><span class="p">(</span><span class="n">ranking_eval</span><span class="p">):</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Precision@k&quot;</span><span class="p">:</span> <span class="n">ranking_eval</span><span class="o">.</span><span class="n">precision_at_k</span><span class="p">(),</span>
        <span class="s2">&quot;Recall@k&quot;</span><span class="p">:</span> <span class="n">ranking_eval</span><span class="o">.</span><span class="n">recall_at_k</span><span class="p">(),</span>
        <span class="s2">&quot;NDCG@k&quot;</span><span class="p">:</span> <span class="n">ranking_eval</span><span class="o">.</span><span class="n">ndcg_at_k</span><span class="p">(),</span>
        <span class="s2">&quot;Mean average precision&quot;</span><span class="p">:</span> <span class="n">ranking_eval</span><span class="o">.</span><span class="n">map_at_k</span><span class="p">()</span>
      
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">metrics</span>   

<span class="k">def</span> <span class="nf">get_diversity_results</span><span class="p">(</span><span class="n">diversity_eval</span><span class="p">):</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;catalog_coverage&quot;</span><span class="p">:</span><span class="n">diversity_eval</span><span class="o">.</span><span class="n">catalog_coverage</span><span class="p">(),</span>
        <span class="s2">&quot;distributional_coverage&quot;</span><span class="p">:</span><span class="n">diversity_eval</span><span class="o">.</span><span class="n">distributional_coverage</span><span class="p">(),</span> 
        <span class="s2">&quot;novelty&quot;</span><span class="p">:</span> <span class="n">diversity_eval</span><span class="o">.</span><span class="n">novelty</span><span class="p">(),</span> 
        <span class="s2">&quot;diversity&quot;</span><span class="p">:</span> <span class="n">diversity_eval</span><span class="o">.</span><span class="n">diversity</span><span class="p">(),</span> 
        <span class="s2">&quot;serendipity&quot;</span><span class="p">:</span> <span class="n">diversity_eval</span><span class="o">.</span><span class="n">serendipity</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">metrics</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_summary</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">algo</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ranking_metrics</span><span class="p">,</span> <span class="n">diversity_metrics</span><span class="p">):</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s2">&quot;Algo&quot;</span><span class="p">:</span> <span class="n">algo</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">ranking_metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ranking_metrics</span> <span class="o">=</span> <span class="p">{</span>           
            <span class="s2">&quot;Precision@k&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;Recall@k&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>            
            <span class="s2">&quot;nDCG@k&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;MAP&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ranking_metrics</span><span class="p">)</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">diversity_metrics</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">summary</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="als-recommender-performance-results">
<h4>ALS Recommender Performance Results<a class="headerlink" href="#als-recommender-performance-results" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">als_ranking_eval</span> <span class="o">=</span> <span class="n">SparkRankingEvaluation</span><span class="p">(</span>
    <span class="n">test_df</span><span class="p">,</span> 
    <span class="n">top_all</span><span class="p">,</span> 
    <span class="n">k</span> <span class="o">=</span> <span class="n">TOP_K</span><span class="p">,</span> 
    <span class="n">col_user</span><span class="o">=</span><span class="n">COL_USER</span><span class="p">,</span> 
    <span class="n">col_item</span><span class="o">=</span><span class="n">COL_ITEM</span><span class="p">,</span>
    <span class="n">col_rating</span><span class="o">=</span><span class="n">COL_RATING</span><span class="p">,</span> 
    <span class="n">col_prediction</span><span class="o">=</span><span class="s2">&quot;prediction&quot;</span><span class="p">,</span>
    <span class="n">relevancy_method</span><span class="o">=</span><span class="s2">&quot;top_k&quot;</span>
<span class="p">)</span>

<span class="n">als_ranking_metrics</span> <span class="o">=</span> <span class="n">get_ranking_results</span><span class="p">(</span><span class="n">als_ranking_eval</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">als_diversity_eval</span> <span class="o">=</span> <span class="n">SparkDiversityEvaluation</span><span class="p">(</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">,</span> 
    <span class="n">reco_df</span> <span class="o">=</span> <span class="n">top_k_reco</span><span class="p">,</span>
    <span class="n">col_user</span> <span class="o">=</span> <span class="n">COL_USER</span><span class="p">,</span> 
    <span class="n">col_item</span> <span class="o">=</span> <span class="n">COL_ITEM</span>
<span class="p">)</span>

<span class="n">als_diversity_metrics</span> <span class="o">=</span> <span class="n">get_diversity_results</span><span class="p">(</span><span class="n">als_diversity_eval</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">als_results</span> <span class="o">=</span> <span class="n">generate_summary</span><span class="p">(</span><span class="n">MOVIELENS_DATA_SIZE</span><span class="p">,</span> <span class="s2">&quot;als&quot;</span><span class="p">,</span> <span class="n">TOP_K</span><span class="p">,</span> <span class="n">als_ranking_metrics</span><span class="p">,</span> <span class="n">als_diversity_metrics</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="random-recommender-performance-results">
<h4>Random Recommender Performance Results<a class="headerlink" href="#random-recommender-performance-results" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_ranking_eval</span> <span class="o">=</span> <span class="n">SparkRankingEvaluation</span><span class="p">(</span>
    <span class="n">test_df</span><span class="p">,</span>
    <span class="n">pred_df</span><span class="p">,</span>
    <span class="n">col_user</span><span class="o">=</span><span class="n">COL_USER</span><span class="p">,</span>
    <span class="n">col_item</span><span class="o">=</span><span class="n">COL_ITEM</span><span class="p">,</span>
    <span class="n">col_rating</span><span class="o">=</span><span class="n">COL_RATING</span><span class="p">,</span>
    <span class="n">col_prediction</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">,</span>
    <span class="n">k</span><span class="o">=</span><span class="n">TOP_K</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">random_ranking_metrics</span> <span class="o">=</span> <span class="n">get_ranking_results</span><span class="p">(</span><span class="n">random_ranking_eval</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_diversity_eval</span> <span class="o">=</span> <span class="n">SparkDiversityEvaluation</span><span class="p">(</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">,</span> 
    <span class="n">reco_df</span> <span class="o">=</span> <span class="n">pred_df</span><span class="p">,</span> 
    <span class="n">col_user</span> <span class="o">=</span> <span class="n">COL_USER</span><span class="p">,</span> 
    <span class="n">col_item</span> <span class="o">=</span> <span class="n">COL_ITEM</span>
<span class="p">)</span>
  
<span class="n">random_diversity_metrics</span> <span class="o">=</span> <span class="n">get_diversity_results</span><span class="p">(</span><span class="n">random_diversity_eval</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_results</span> <span class="o">=</span> <span class="n">generate_summary</span><span class="p">(</span><span class="n">MOVIELENS_DATA_SIZE</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="n">TOP_K</span><span class="p">,</span> <span class="n">random_ranking_metrics</span><span class="p">,</span> <span class="n">random_diversity_metrics</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="result-comparison">
<h4>Result Comparison<a class="headerlink" href="#result-comparison" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Data&quot;</span><span class="p">,</span> <span class="s2">&quot;Algo&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;Precision@k&quot;</span><span class="p">,</span> <span class="s2">&quot;Recall@k&quot;</span><span class="p">,</span> <span class="s2">&quot;NDCG@k&quot;</span><span class="p">,</span> <span class="s2">&quot;Mean average precision&quot;</span><span class="p">,</span><span class="s2">&quot;catalog_coverage&quot;</span><span class="p">,</span> <span class="s2">&quot;distributional_coverage&quot;</span><span class="p">,</span><span class="s2">&quot;novelty&quot;</span><span class="p">,</span> <span class="s2">&quot;diversity&quot;</span><span class="p">,</span> <span class="s2">&quot;serendipity&quot;</span> <span class="p">]</span>
<span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

<span class="n">df_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">als_results</span> 
<span class="n">df_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_results</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Data</th>
      <th>Algo</th>
      <th>K</th>
      <th>Precision@k</th>
      <th>Recall@k</th>
      <th>NDCG@k</th>
      <th>Mean average precision</th>
      <th>catalog_coverage</th>
      <th>distributional_coverage</th>
      <th>novelty</th>
      <th>diversity</th>
      <th>serendipity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>100k</td>
      <td>als</td>
      <td>10</td>
      <td>0.047296</td>
      <td>0.016015</td>
      <td>0.043097</td>
      <td>0.004579</td>
      <td>0.385793</td>
      <td>7.967257</td>
      <td>11.659776</td>
      <td>0.892277</td>
      <td>0.878733</td>
    </tr>
    <tr>
      <th>2</th>
      <td>100k</td>
      <td>random</td>
      <td>10</td>
      <td>0.016543</td>
      <td>0.005566</td>
      <td>0.016373</td>
      <td>0.001441</td>
      <td>0.994489</td>
      <td>10.541850</td>
      <td>12.136439</td>
      <td>0.922613</td>
      <td>0.892511</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="conclusion">
<h4>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h4>
<p>The comparision results show that the ALS recommender outperforms the random recommender on ranking metrics (Precision&#64;k, Recall&#64;k, NDCG&#64;k, and	Mean average precision), while the random recommender outperforms ALS recommender on diversity metrics. This is because ALS is optimized for estimating the item rating as accurate as possible, therefore it performs well on accuracy metrics including rating and ranking metrics. As a side effect, the items being recommended tend to be popular items, which are the items mostly sold or viewed. It leaves the long-tail less popular items having less chance to get introduced to the users. This is the reason why ALS is not performing as well as a random recommender on diversity metrics.</p>
</div>
</div>
<div class="section" id="calculate-diversity-metrics-using-item-feature-vector-based-item-item-similarity">
<h3>6.  Calculate diversity metrics using item feature vector based item-item similarity<a class="headerlink" href="#calculate-diversity-metrics-using-item-feature-vector-based-item-item-similarity" title="Permalink to this headline">¶</a></h3>
<p>In the above section we calculate diversity metrics using item co-occurrence count based item-item similarity. In the scenarios when item features are available, we may want to calculate item-item similarity based on item feature vectors. In this section, we show how to calculate diversity metrics using item feature vector based item-item similarity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get movie features &quot;title&quot; and &quot;genres&quot;</span>
<span class="n">movies</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">COL_ITEM</span><span class="p">,</span> <span class="n">COL_TITLE</span><span class="p">,</span> <span class="n">COL_GENRE</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>  <span class="c1"># remove rows with null values</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">COL_GENRE</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">COL_GENRE</span><span class="p">),</span> <span class="s2">&quot;\|&quot;</span><span class="p">))</span>  <span class="c1"># convert to array of genres</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">COL_TITLE</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">COL_TITLE</span><span class="p">),</span> <span class="s2">&quot;[\(),:^0-9]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>  <span class="c1"># remove year from title</span>
    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>  <span class="c1"># remove unused columns</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># tokenize &quot;title&quot; column</span>
<span class="n">title_tokenizer</span> <span class="o">=</span> <span class="n">Tokenizer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="n">COL_TITLE</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;title_words&quot;</span><span class="p">)</span>
<span class="n">tokenized_data</span> <span class="o">=</span> <span class="n">title_tokenizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">movies</span><span class="p">)</span>

<span class="c1"># remove stop words</span>
<span class="n">remover</span> <span class="o">=</span> <span class="n">StopWordsRemover</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s2">&quot;title_words&quot;</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
<span class="n">clean_data</span> <span class="o">=</span> <span class="n">remover</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">tokenized_data</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">COL_TITLE</span><span class="p">,</span> <span class="s2">&quot;title_words&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert text input into feature vectors</span>

<span class="c1"># step 1: perform HashingTF on column &quot;text&quot;</span>
<span class="n">text_hasher</span> <span class="o">=</span> <span class="n">HashingTF</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;text_features&quot;</span><span class="p">,</span> <span class="n">numFeatures</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">hashed_data</span> <span class="o">=</span> <span class="n">text_hasher</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">clean_data</span><span class="p">)</span>

<span class="c1"># step 2: fit a CountVectorizerModel from column &quot;genres&quot;.</span>
<span class="n">count_vectorizer</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="n">COL_GENRE</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;genres_features&quot;</span><span class="p">)</span>
<span class="n">count_vectorizer_model</span> <span class="o">=</span> <span class="n">count_vectorizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">hashed_data</span><span class="p">)</span>
<span class="n">vectorized_data</span> <span class="o">=</span> <span class="n">count_vectorizer_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">hashed_data</span><span class="p">)</span>

<span class="c1"># step 3: assemble features into a single vector</span>
<span class="n">assembler</span> <span class="o">=</span> <span class="n">VectorAssembler</span><span class="p">(</span>
    <span class="n">inputCols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;text_features&quot;</span><span class="p">,</span> <span class="s2">&quot;genres_features&quot;</span><span class="p">],</span>
    <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;features&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">feature_data</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">vectorized_data</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">COL_ITEM</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

<span class="n">feature_data</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>+------+---------------------------------------------+
|ItemId|features                                     |
+------+---------------------------------------------+
|167   |(1043,[128,544,1025],[1.0,1.0,1.0])          |
|1343  |(1043,[38,300,1024],[1.0,1.0,1.0])           |
|1607  |(1043,[592,821,1024],[1.0,1.0,1.0])          |
|966   |(1043,[389,502,1028],[1.0,1.0,1.0])          |
|9     |(1043,[11,342,1014,1024],[1.0,1.0,1.0,1.0])  |
|1230  |(1043,[597,740,902,1025],[1.0,1.0,1.0,1.0])  |
|1118  |(1043,[702,1025],[1.0,1.0])                  |
|673   |(1043,[169,690,1027,1040],[1.0,1.0,1.0,1.0]) |
|879   |(1043,[909,1026,1027,1034],[1.0,1.0,1.0,1.0])|
|66    |(1043,[256,1025,1028],[1.0,1.0,1.0])         |
+------+---------------------------------------------+
only showing top 10 rows
</pre></div>
</div>
</div>
</div>
<p>The <em>features</em> column is represented with a SparseVector object. For example, in the feature vector (1043,[128,544,1025],[1.0,1.0,1.0]), 1043 is the vector length, indicating the vector consisting of 1043 item features. The values at index positions 128,544,1025 are 1.0, and the values at other positions are all 0.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">als_eval</span> <span class="o">=</span> <span class="n">SparkDiversityEvaluation</span><span class="p">(</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">,</span> 
    <span class="n">reco_df</span> <span class="o">=</span> <span class="n">top_k_reco</span><span class="p">,</span>
    <span class="n">item_feature_df</span> <span class="o">=</span> <span class="n">feature_data</span><span class="p">,</span> 
    <span class="n">item_sim_measure</span><span class="o">=</span><span class="s2">&quot;item_feature_vector&quot;</span><span class="p">,</span>
    <span class="n">col_user</span> <span class="o">=</span> <span class="n">COL_USER</span><span class="p">,</span> 
    <span class="n">col_item</span> <span class="o">=</span> <span class="n">COL_ITEM</span>
<span class="p">)</span>

<span class="n">als_diversity</span><span class="o">=</span><span class="n">als_eval</span><span class="o">.</span><span class="n">diversity</span><span class="p">()</span>
<span class="n">als_serendipity</span><span class="o">=</span><span class="n">als_eval</span><span class="o">.</span><span class="n">serendipity</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">als_diversity</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">als_serendipity</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8738984131037538
0.8873467159479473
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_eval</span> <span class="o">=</span> <span class="n">SparkDiversityEvaluation</span><span class="p">(</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">,</span> 
    <span class="n">reco_df</span> <span class="o">=</span> <span class="n">pred_df</span><span class="p">,</span> 
    <span class="n">item_feature_df</span> <span class="o">=</span> <span class="n">feature_data</span><span class="p">,</span> 
    <span class="n">item_sim_measure</span><span class="o">=</span><span class="s2">&quot;item_feature_vector&quot;</span><span class="p">,</span>    
    <span class="n">col_user</span> <span class="o">=</span> <span class="n">COL_USER</span><span class="p">,</span> 
    <span class="n">col_item</span> <span class="o">=</span> <span class="n">COL_ITEM</span>
<span class="p">)</span>
  
<span class="n">random_diversity</span><span class="o">=</span><span class="n">random_eval</span><span class="o">.</span><span class="n">diversity</span><span class="p">()</span>
<span class="n">random_serendipity</span><span class="o">=</span><span class="n">random_eval</span><span class="o">.</span><span class="n">serendipity</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">random_diversity</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">random_serendipity</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8982144953920664
0.8941807579293202
</pre></div>
</div>
</div>
</div>
<p>It’s interesting that the value of diversity and serendipity changes when using different item-item similarity calculation approach, for both ALS algorithm and random recommender. The diversity and serendipity of random recommender are still higher than ALS algorithm.</p>
</div>
<div class="section" id="references">
<h3>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h3>
<p>The metric definitions / formulations are based on the following references:</p>
<ul class="simple">
<li><p>P. Castells, S. Vargas, and J. Wang, Novelty and diversity metrics for recommender systems: choice, discovery and relevance, ECIR 2011</p></li>
<li><p>G. Shani and A. Gunawardana, Evaluating recommendation systems, Recommender Systems Handbook pp. 257-297, 2010.</p></li>
<li><p>E. Yan, Serendipity: Accuracy’s unpopular best friend in recommender Systems, <a class="reference external" href="http://eugeneyan.com">eugeneyan.com</a>, April 2020</p></li>
<li><p>Y.C. Zhang, D.Ó. Séaghdha, D. Quercia and T. Jambor, Auralist: introducing serendipity into music recommendation, WSDM 2012</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cleanup spark instance</span>
<span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./examples/03_evaluate"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The Jupyter Book community<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>